<% content_for :title, "検索結果 - College Spark" %>

<style>
  .results-page {
    min-height: 100vh;
    background: #ffffff;
  }

  /* Hero Section */
  .hero-section {
    background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
    padding: 60px 20px;
    text-align: center;
    color: white;
  }

  .hero-content {
    max-width: 800px;
    margin: 0 auto;
  }

  .hero-title {
    font-size: 42px;
    font-weight: 700;
    margin: 0 0 10px;
    letter-spacing: -0.5px;
  }

  .hero-subtitle {
    font-size: 16px;
    font-weight: 300;
    opacity: 0.8;
    letter-spacing: 2px;
    text-transform: uppercase;
    margin: 0;
  }

  .hero-divider {
    width: 60px;
    height: 3px;
    background: rgb(240, 177, 61);
    margin: 25px auto 0;
  }

  /* Main Content */
  .results-main {
    padding: 40px 20px;
  }

  .results-container {
    max-width: 1400px;
    margin: 0 auto;
  }

  .results-header {
    background: white;
    color: #333;
    padding: 20px 24px;
    border-radius: 8px;
    margin-bottom: 20px;
    border: 1px solid #e5e5e5;
  }

  .header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 20px;
  }

  .results-count {
    font-size: 0.875rem;
    font-weight: 500;
    margin-bottom: 0;
    color: #666;
  }

  .results-info {
    font-size: 14px;
    color: #666;
  }

  .controls-container {
    display: flex;
    align-items: center;
    gap: 16px;
    flex-wrap: wrap;
  }

  .change-conditions-btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 10px 20px;
    background: #1a1a1a;
    color: white;
    text-decoration: none;
    border-radius: 25px;
    font-size: 0.875rem;
    font-weight: 500;
    transition: all 0.2s ease;
    border: none;
  }

  .change-conditions-btn:hover {
    background: rgb(240, 177, 61);
    color: white;
    text-decoration: none;
  }

  .change-conditions-btn i {
    font-size: 0.875rem;
  }

  .per-page-container {
    display: flex;
    align-items: center;
    gap: 10px;
    background: #f8f8f8;
    padding: 8px 12px;
    border-radius: 8px;
    border: 1px solid #e5e5e5;
  }

  .per-page-label {
    font-size: 14px;
    font-weight: 500;
    color: #666;
  }

  .per-page-select {
    padding: 8px 12px;
    border-radius: 6px;
    border: 1px solid #e5e5e5;
    background: white;
    color: #333;
    font-size: 14px;
    cursor: pointer;
    outline: none;
    transition: border-color 0.2s ease;
  }

  .per-page-select:hover {
    border-color: #1a1a1a;
  }

  .sort-container {
    display: flex;
    align-items: center;
    gap: 10px;
    background: #f8f8f8;
    padding: 8px 12px;
    border-radius: 8px;
    border: 1px solid #e5e5e5;
  }

  .sort-label {
    font-size: 14px;
    font-weight: 500;
    color: #666;
  }

  .sort-select {
    padding: 8px 12px;
    border-radius: 6px;
    border: 1px solid #e5e5e5;
    background: white;
    color: #333;
    font-size: 14px;
    cursor: pointer;
    outline: none;
    transition: border-color 0.2s ease;
  }

  .sort-select:hover {
    border-color: #1a1a1a;
  }

  /* ページネーションスタイル */
  .pagination-container {
    margin: 30px 0;
    padding: 20px;
    background: white;
    border-radius: 8px;
    border: 1px solid #e5e5e5;
  }

  .pagination-info {
    text-align: center;
    margin-bottom: 20px;
    font-size: 14px;
    color: #666;
  }

  .pagination-nav {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 5px;
    flex-wrap: wrap;
  }

  .pagination-pages {
    display: flex;
    gap: 5px;
    margin: 0 10px;
  }

  .pagination-btn {
    display: inline-block;
    padding: 8px 12px;
    border: 1px solid #e5e5e5;
    border-radius: 6px;
    background: white;
    color: #333;
    text-decoration: none;
    font-size: 14px;
    transition: all 0.2s ease;
    min-width: 40px;
    text-align: center;
  }

  .pagination-btn:hover {
    background: #1a1a1a;
    color: white;
    border-color: #1a1a1a;
    text-decoration: none;
  }

  .pagination-btn.pagination-current {
    background: #1a1a1a;
    color: white;
    border-color: #1a1a1a;
    font-weight: 600;
  }

  .pagination-btn.disabled {
    background: #f8f8f8;
    color: #999;
    cursor: not-allowed;
    border-color: #e5e5e5;
  }

  .pagination-btn.disabled:hover {
    background: #f8f8f8;
    color: #999;
    border-color: #e5e5e5;
  }

  .pagination-first,
  .pagination-last {
    font-weight: 500;
  }

  .pagination-prev,
  .pagination-next {
    font-weight: 500;
    padding: 8px 16px;
  }

  .data-source {
    background-color: #f8f8f8;
    padding: 12px 16px;
    border-radius: 8px;
    margin-bottom: 20px;
    border-left: 3px solid rgb(240, 177, 61);
    font-size: 0.8125rem;
    color: #666;
  }

  .data-source i {
    color: rgb(200, 140, 40);
  }

  .data-source a {
    color: rgb(200, 140, 40);
    text-decoration: none;
    font-weight: 500;
  }

  .data-source a:hover {
    text-decoration: underline;
  }

  .results-table {
    background: white;
    border-radius: 8px;
    overflow: hidden;
    border: 1px solid #e5e5e5;
  }

  table {
    width: 100%;
    border-collapse: collapse;
  }

  thead {
    background: #1a1a1a;
    color: white;
  }

  th {
    padding: 14px 16px;
    text-align: left;
    font-weight: 600;
    font-size: 13px;
    text-transform: none;
    letter-spacing: 0;
    cursor: pointer;
    user-select: none;
    position: relative;
    white-space: nowrap;
  }

  th.sortable:hover {
    background-color: rgba(255, 255, 255, 0.1);
  }

  th.sortable::after {
    content: ' ⇅';
    position: relative;
    opacity: 0.5;
    font-size: 14px;
    margin-left: 4px;
  }

  th.sort-asc::after {
    content: ' ↑';
    opacity: 1;
    color: rgb(240, 177, 61);
  }

  th.sort-desc::after {
    content: ' ↓';
    opacity: 1;
    color: rgb(240, 177, 61);
  }

  tbody tr {
    border-bottom: 1px solid #f0f0f0;
    transition: all 0.2s ease;
    cursor: pointer;
    min-height: 48px;
  }

  tbody tr:hover {
    background-color: #fef9e7;
  }

  td {
    padding: 16px;
    font-size: 14px;
    white-space: nowrap;
    vertical-align: top;
  }

  /* Allow college name to wrap when needed */
  td:first-child {
    white-space: normal;
    word-wrap: break-word;
    max-width: 200px;
    min-height: 48px;
  }

  .university-link {
    color: #1a1a1a;
    text-decoration: none;
    font-weight: 600;
    transition: color 0.2s ease;
  }

  .university-link:hover {
    color: rgb(240, 177, 61);
  }

  .university-link .english-name {
    font-size: 12px;
    font-weight: 400;
    color: #666;
  }

  .tag {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 500;
  }

  .tag-private {
    background: #fef3c7;
    color: #92400e;
  }

  .tag-public {
    background: #dbeafe;
    color: #1e40af;
  }

  .tag-profit {
    background-color: #fee2e2;
    color: #991b1b;
  }

  .tag-community {
    background: #d1fae5;
    color: #065f46;
  }

  .no-results {
    background: white;
    border-radius: 8px;
    padding: 60px 40px;
    text-align: center;
    border: 1px solid #e5e5e5;
  }

  .no-results-icon {
    width: 80px;
    height: 80px;
    margin: 0 auto 20px;
    color: #999;
  }

  .no-results h2 {
    font-size: 24px;
    margin-bottom: 10px;
    color: #1a1a1a;
  }

  .no-results p {
    color: #666;
    margin-bottom: 30px;
  }

  .back-button {
    display: inline-block;
    padding: 12px 30px;
    background: #1a1a1a;
    color: white;
    text-decoration: none;
    border-radius: 25px;
    font-weight: 600;
    transition: all 0.2s ease;
  }

  .back-button:hover {
    background: rgb(240, 177, 61);
    color: white;
    text-decoration: none;
  }

  /* Action Buttons */
  .action-btn {
    width: 36px;
    height: 36px;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 14px;
  }

  .favorite-btn-small {
    background: #f5f5f5;
    color: #666;
    border: 1px solid #e5e5e5;
  }

  .favorite-btn-small:hover {
    background: #eee;
    border-color: #ddd;
  }

  .favorite-btn-small.favorited {
    background: rgb(240, 177, 61);
    color: #1a1a1a;
    border-color: rgb(240, 177, 61);
  }

  .favorite-btn-small.favorited:hover {
    background: rgb(220, 160, 50);
    border-color: rgb(220, 160, 50);
  }

  .compare-btn-small {
    background: #f5f5f5;
    color: #666;
    border: 1px solid #e5e5e5;
  }

  .compare-btn-small:hover {
    background: #eee;
    border-color: #ddd;
  }

  .compare-btn-small.added {
    background: #1a1a1a;
    color: white;
    border-color: #1a1a1a;
  }

  .compare-btn-small.added:hover {
    background: #333;
    border-color: #333;
  }

    /* Mobile Styles */
    @media (max-width: 768px) {
      .results-container {
        padding: 20px 10px;
      }

      .results-header {
        padding: 20px;
        border-radius: 10px;
      }

      .header-content {
        flex-direction: column;
        gap: 15px;
      }

      .results-count {
        font-size: 22px;
      }

      .results-info {
        font-size: 14px;
      }

      .controls-container {
        flex-direction: column;
        gap: 10px;
        width: 100%;
      }
      
      .per-page-container {
        width: 100%;
        justify-content: space-between;
      }

      .per-page-select {
        flex: 1;
        max-width: 120px;
      }

      .sort-container {
        width: 100%;
        justify-content: space-between;
      }

      .sort-select {
        flex: 1;
        max-width: 200px;
      }
      
      /* モバイル用ページネーション */
      .pagination-container {
        padding: 15px;
        margin: 20px 0;
      }
      
      .pagination-nav {
        gap: 3px;
      }
      
      .pagination-btn {
        padding: 6px 8px;
        font-size: 13px;
        min-width: 32px;
      }
      
      .pagination-prev,
      .pagination-next {
        padding: 6px 12px;
      }
      
      .pagination-pages {
        margin: 0 5px;
      }

      /* アクションボタン */
      .action-column {
        width: 100px;
        text-align: center;
      }

      .action-buttons {
        text-align: center !important;
        padding: 8px !important;
        vertical-align: middle !important;
        min-height: 48px !important;
        display: table-cell !important;
      }

      .button-group {
        display: flex !important;
        gap: 6px !important;
        justify-content: center !important;
        align-items: center !important;
        min-height: 32px !important;
        width: 100% !important;
        height: 100% !important;
      }

      .action-btn {
        width: 32px !important;
        height: 32px !important;
        border: none !important;
        border-radius: 50% !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        cursor: pointer !important;
        transition: all 0.3s ease !important;
        font-size: 14px !important;
        position: relative !important;
        min-width: 32px !important;
        flex-shrink: 0 !important;
      }

      .favorite-btn-small {
        background: #f5f5f5 !important;
        color: #666 !important;
        border: 1px solid #e5e5e5 !important;
      }

      .favorite-btn-small:hover {
        background: #eee !important;
        border-color: #ddd !important;
      }

      .favorite-btn-small.favorited {
        background: rgb(240, 177, 61) !important;
        color: #1a1a1a !important;
        border-color: rgb(240, 177, 61) !important;
      }

      .favorite-btn-small.favorited:hover {
        background: rgb(220, 160, 50) !important;
        border-color: rgb(220, 160, 50) !important;
      }

      .compare-btn-small {
        background: #f5f5f5 !important;
        color: #666 !important;
        border: 1px solid #e5e5e5 !important;
      }

      .compare-btn-small:hover {
        background: #eee !important;
        border-color: #ddd !important;
      }

      .compare-btn-small.added {
        background: #1a1a1a !important;
        color: white !important;
        border-color: #1a1a1a !important;
      }

      .compare-btn-small.added:hover {
        background: #333 !important;
        border-color: #333 !important;
      }

      /* Mobile Card Layout */
      .results-table {
        border-radius: 0;
        box-shadow: none;
      }

      table, thead, tbody, th, td, tr {
        display: block;
      }

      thead {
        display: none;
      }

      tbody tr {
        margin-bottom: 15px;
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        padding: 15px;
        position: relative;
        border: none;
      }

      tbody tr:hover {
        transform: none;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
      }

      td {
        padding: 8px 0;
        text-align: left;
        position: relative;
        padding-left: 35%;
        border: none;
        min-height: 32px;
        vertical-align: top;
      }
      
      td:first-child {
        white-space: normal;
        word-wrap: break-word;
        min-height: 40px;
      }

      td:before {
        content: attr(data-label);
        position: absolute;
        left: 0;
        width: 30%;
        font-weight: 600;
        font-size: 13px;
        color: #6b7280;
      }

      td:first-child {
        padding-left: 0;
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 10px;
        padding-bottom: 12px;
        border-bottom: 1px solid #e5e7eb;
      }

      td:first-child:before {
        display: none;
      }

      .university-link {
        font-size: 16px;
      }

      .tag {
        font-size: 11px;
        padding: 3px 8px;
      }

      /* モバイル用アクションボタン */
      .action-buttons {
        padding-left: 0 !important;
        padding-top: 12px !important;
        min-height: 48px !important;
        display: flex !important;
        align-items: center !important;
      }
      
      .action-buttons:before {
        display: none !important;
      }
      
      .button-group {
        justify-content: flex-start;
        gap: 8px;
        width: 100%;
        align-items: center;
      }
      }

      .data-source {
        font-size: 13px;
        padding: 12px 15px;
      }

      .no-results {
        padding: 40px 20px;
      }

      .no-results h2 {
        font-size: 20px;
      }

      .back-button {
        padding: 10px 20px;
        font-size: 14px;
      }
    }

    /* Tablet Styles */
    @media (min-width: 769px) and (max-width: 1024px) {
      .results-container {
        padding: 30px 20px;
      }

      th {
        padding: 12px 10px;
        font-size: 12px;
      }

      td {
        padding: 15px 10px;
        font-size: 14px;
      }

      .results-table {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }

      table {
        min-width: 900px;
      }
    }

    /* Login Modal Styles */
    .login-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      display: none;
      justify-content: center;
      align-items: center;
    }

    .login-modal {
      background: white;
      border-radius: 8px;
      width: 90%;
      max-width: 400px;
      overflow: hidden;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
      position: relative;
    }

    .login-modal-header {
      background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
      color: white;
      padding: 20px 24px;
      position: relative;
      text-align: center;
    }

    .login-modal-close {
      position: absolute;
      right: 16px;
      top: 16px;
      background: none;
      border: none;
      color: white;
      font-size: 24px;
      cursor: pointer;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: background-color 0.2s;
    }

    .login-modal-close:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .login-modal-title {
      font-size: 18px;
      font-weight: 600;
      margin: 0;
    }

    .login-modal-body {
      padding: 32px 24px;
      text-align: center;
    }

    .login-modal-message {
      font-size: 16px;
      color: #333;
      margin: 0 0 32px;
      line-height: 1.6;
    }

    .login-modal-buttons {
      display: flex;
      gap: 12px;
      justify-content: center;
    }

    .login-modal-btn {
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.2s;
      cursor: pointer;
      border: none;
      min-width: 120px;
    }

    .login-modal-btn-primary {
      background: #1a1a1a;
      color: white;
    }

    .login-modal-btn-primary:hover {
      background: #333;
    }

    .login-modal-btn-secondary {
      background: white;
      color: #1a1a1a;
      border: 1px solid #e5e5e5;
    }

    .login-modal-btn-secondary:hover {
      background: #f5f5f5;
      border-color: #ddd;
    }

  /* Responsive - Hero */
  @media (max-width: 768px) {
    .hero-section {
      padding: 40px 20px;
    }

    .hero-title {
      font-size: 28px;
    }

    .results-main {
      padding: 20px 16px;
    }
  }
</style>

<div class="results-page">
  <!-- Hero Section -->
  <section class="hero-section">
    <div class="hero-content">
      <h1 class="hero-title">検索結果</h1>
      <p class="hero-subtitle">Search Results</p>
      <div class="hero-divider"></div>
    </div>
  </section>

  <!-- Main Content -->
  <section class="results-main">
    <div class="results-container">
      <% if @results.present? %>
        <div class="results-header">
        <div class="header-content">
          <div>
            <div class="results-count">
              条件に一致する大学: <%= @total_count %> 校 (表示中: <%= @results.current_page %>/<%= @results.total_pages %>ページ)
            </div>
          </div>
          <div class="controls-container">
            <a href="/search" class="change-conditions-btn">
              <i class="fas fa-filter"></i>
              条件を変更
            </a>
            <div class="per-page-container">
              <span class="per-page-label">表示件数:</span>
              <select class="per-page-select" id="perPageSelect">
                <option value="20" <%= 'selected' if params[:per_page] == '20' || params[:per_page].blank? %>>20件</option>
                <option value="50" <%= 'selected' if params[:per_page] == '50' %>>50件</option>
                <option value="100" <%= 'selected' if params[:per_page] == '100' %>>100件</option>
              </select>
            </div>
            <div class="sort-container">
              <span class="sort-label">並べ替え:</span>
              <select class="sort-select" id="mobileSortSelect">
                <option value="">選択してください</option>
                <option value="name-asc" <%= 'selected' if params[:sort] == 'name-asc' %>>大学名 (A→Z)</option>
                <option value="name-desc" <%= 'selected' if params[:sort] == 'name-desc' %>>大学名 (Z→A)</option>
                <option value="students-desc" <%= 'selected' if params[:sort] == 'students-desc' %>>学生数 (多い順)</option>
                <option value="students-asc" <%= 'selected' if params[:sort] == 'students-asc' %>>学生数 (少ない順)</option>
                <option value="tuition-asc" <%= 'selected' if params[:sort] == 'tuition-asc' %>>授業料 (安い順)</option>
                <option value="tuition-desc" <%= 'selected' if params[:sort] == 'tuition-desc' %>>授業料 (高い順)</option>
                <option value="graduation-desc" <%= 'selected' if params[:sort] == 'graduation-desc' %>>卒業率 (高い順)</option>
                <option value="graduation-asc" <%= 'selected' if params[:sort] == 'graduation-asc' %>>卒業率 (低い順)</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <div class="data-source">
        <i class="fas fa-info-circle" style="margin-right: 8px;"></i>
        大学情報は、アメリカ教育省 College Scorecardのデータに基づいています。
        詳細については<a href="https://collegescorecard.ed.gov/" target="_blank">こちら</a>をご覧ください。
      </div>

      <div class="results-table">
        <table id="resultsTable">
          <thead>
            <tr>
              <th class="sortable" data-sort="name">大学名</th>
              <th class="sortable" data-sort="state">州</th>
              <th>区分</th>
              <th class="sortable" data-sort="students">学生数</th>
              <th class="sortable" data-sort="tuition">授業料</th>
              <th class="sortable" data-sort="graduation">卒業率</th>
              <th>立地</th>
              <th class="action-column">アクション</th>
            </tr>
          </thead>
          <tbody>
            <% @results.each_with_index do |result, index| %>
              <tr data-name="<%= result.college %>" 
                  data-students="<%= result.students || 0 %>"
                  data-tuition="<%= result.tuition || 0 %>"
                  data-graduation="<%= result.graduation_rate || 0 %>"
                  data-url="<%= conditions_path(result) %>"
                  onclick="window.location.href='<%= conditions_path(result) %>'">
                <td>
                  <span class="university-link">
                    <% if result.name_ja.present? %>
                      <%= result.name_ja %><br>
                      <span class="english-name"><%= result.college %></span>
                    <% else %>
                      <%= result.college %>
                    <% end %>
                  </span>
                </td>
                <td data-label="州"><%=
                  if result.state
                    case result.state.gsub(/\s*\(.*?\)/, '')
                    when 'AL' then 'アラバマ州'
                    when 'AK' then 'アラスカ州'
                    when 'AZ' then 'アリゾナ州'
                    when 'AR' then 'アーカンソー州'
                    when 'CA' then 'カリフォルニア州'
                    when 'CO' then 'コロラド州'
                    when 'CT' then 'コネチカット州'
                    when 'DE' then 'デラウェア州'
                    when 'FL' then 'フロリダ州'
                    when 'GA' then 'ジョージア州'
                    when 'HI' then 'ハワイ州'
                    when 'ID' then 'アイダホ州'
                    when 'IL' then 'イリノイ州'
                    when 'IN' then 'インディアナ州'
                    when 'IA' then 'アイオワ州'
                    when 'KS' then 'カンザス州'
                    when 'KY' then 'ケンタッキー州'
                    when 'LA' then 'ルイジアナ州'
                    when 'ME' then 'メイン州'
                    when 'MD' then 'メリーランド州'
                    when 'MA' then 'マサチューセッツ州'
                    when 'MI' then 'ミシガン州'
                    when 'MN' then 'ミネソタ州'
                    when 'MS' then 'ミシシッピ州'
                    when 'MO' then 'ミズーリ州'
                    when 'MT' then 'モンタナ州'
                    when 'NE' then 'ネブラスカ州'
                    when 'NV' then 'ネバダ州'
                    when 'NH' then 'ニューハンプシャー州'
                    when 'NJ' then 'ニュージャージー州'
                    when 'NM' then 'ニューメキシコ州'
                    when 'NY' then 'ニューヨーク州'
                    when 'NC' then 'ノースカロライナ州'
                    when 'ND' then 'ノースダコタ州'
                    when 'OH' then 'オハイオ州'
                    when 'OK' then 'オクラホマ州'
                    when 'OR' then 'オレゴン州'
                    when 'PA' then 'ペンシルベニア州'
                    when 'RI' then 'ロードアイランド州'
                    when 'SC' then 'サウスカロライナ州'
                    when 'SD' then 'サウスダコタ州'
                    when 'TN' then 'テネシー州'
                    when 'TX' then 'テキサス州'
                    when 'UT' then 'ユタ州'
                    when 'VT' then 'バーモント州'
                    when 'VA' then 'バージニア州'
                    when 'WA' then 'ワシントン州'
                    when 'WV' then 'ウェストバージニア州'
                    when 'WI' then 'ウィスコンシン州'
                    when 'WY' then 'ワイオミング州'
                    when 'DC' then 'ワシントンD.C.'
                    when 'PR' then 'プエルトリコ'
                    when 'VI' then 'バージン諸島'
                    when 'GU' then 'グアム'
                    when 'AS' then 'アメリカ領サモア'
                    when 'MP' then '北マリアナ諸島'
                    else result.state.gsub(/\s*\(.*?\)/, '')
                    end
                  else
                    "N/A"
                  end
                %></td>
                <td data-label="区分">
                  <% if result.privateorpublic == "私立" || result.privateorpublic == "Private" %>
                    <span class="tag tag-private">私立</span>
                  <% elsif result.privateorpublic == "州立" || result.privateorpublic == "Public" %>
                    <span class="tag tag-public">州立</span>
                  <% elsif result.privateorpublic == "営利" %>
                    <span class="tag tag-profit">営利</span>
                  <% elsif result.school_type == '2年制' %>
                    <span class="tag tag-community">2年制</span>
                  <% else %>
                    <span class="tag tag-profit">営利</span>
                  <% end %>
                </td>
                <td data-label="学生数"><%= number_with_delimiter(result.students) %> 人</td>
                <td data-label="授業料"><%=
                  if result.privateorpublic == "州立" || result.privateorpublic == "Public"
                    # 州立大学の場合は州外学生向け授業料を表示
                    if result.tuition_out_state.present?
                      number_to_currency(result.tuition_out_state, unit: "$", precision: 0)
                    elsif result.tuition.present?
                      number_to_currency(result.tuition, unit: "$", precision: 0)
                    else
                      "N/A"
                    end
                  else
                    # 私立大学の場合は通常の授業料を表示
                    result.tuition.present? ? number_to_currency(result.tuition, unit: "$", precision: 0) : "N/A"
                  end
                %></td>
                <td data-label="卒業率"><%= result.graduation_rate.present? ? "#{number_with_precision(result.graduation_rate * 100, precision: 1)}%" : "N/A" %></td>
                <td data-label="立地"><%=
                    case result.urbanicity&.to_i
                    when 11
                      "大都市"
                    when 12
                      "中都市"
                    when 13
                      "小都市"
                    when 21
                      "大郊外"
                    when 22
                      "中郊外"
                    when 23
                      "小郊外"
                    when 31
                      "近隣町"
                    when 32
                      "遠方町"
                    when 33
                      "僻地町"
                    when 41
                      "近隣地方"
                    when 42
                      "遠方地方"
                    when 43
                      "僻地"
                    else
                      "N/A"
                    end
                  %></td>
                <td class="action-buttons" data-label="アクション" onclick="event.stopPropagation();" style="text-align: center; padding: 8px;">
                  <div class="button-group" style="display: flex; gap: 6px; justify-content: center; align-items: center;">
                    <% if logged_in? %>
                      <% if current_user.favorite?(result) %>
                        <button class="action-btn favorite-btn-small favorited"
                                data-condition-id="<%= result.id %>"
                                title="お気に入り済み"
                                onclick="handleFavoriteClick(this, event)">
                          <i class="fas fa-heart"></i>
                        </button>
                      <% else %>
                        <button class="action-btn favorite-btn-small"
                                data-condition-id="<%= result.id %>"
                                title="お気に入りに追加"
                                onclick="handleFavoriteClick(this, event)">
                          <i class="fas fa-heart"></i>
                        </button>
                      <% end %>
                    <% else %>
                      <button class="action-btn favorite-btn-small"
                              data-condition-id="<%= result.id %>"
                              title="お気に入りに追加（ログインが必要）"
                              onclick="handleFavoriteClick(this, event)">
                        <i class="fas fa-heart"></i>
                      </button>
                    <% end %>
                    
                    <% if logged_in? %>
                      <% comparison_list = current_user.comparison_list || [] %>
                      <% if comparison_list.include?(result.id) %>
                        <button class="action-btn compare-btn-small added"
                                data-condition-id="<%= result.id %>"
                                title="比較リストに追加済み"
                                onclick="handleCompareClick(this, event)">
                          <i class="fas fa-balance-scale"></i>
                        </button>
                      <% else %>
                        <button class="action-btn compare-btn-small"
                                data-condition-id="<%= result.id %>"
                                title="比較リストに追加"
                                onclick="handleCompareClick(this, event)">
                          <i class="fas fa-balance-scale"></i>
                        </button>
                      <% end %>
                    <% else %>
                      <button class="action-btn compare-btn-small"
                              data-condition-id="<%= result.id %>"
                              title="比較リストに追加（ログインが必要）"
                              onclick="handleCompareClick(this, event)">
                        <i class="fas fa-balance-scale"></i>
                      </button>
                    <% end %>
                  </div>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
      
      <!-- ページネーション -->
      <% if @results.total_pages > 1 %>
        <div class="pagination-container">
          <div class="pagination-info">
            <%= @results.offset_value + 1 %> - <%= [@results.offset_value + @results.limit_value, @total_count].min %> 件 / 全 <%= @total_count %> 件
          </div>
          
          <div class="pagination-nav">
            <%
              # 全ての検索パラメータを許可
              permitted_params = params.permit(
                :state, :college_name, :privateorpublic, :tuition, :students,
                :sat_score, :act_score, :Division, :urbanicity, :graduation_rate,
                :sort, major: []
              )
            %>
            <% if @results.prev_page %>
              <a href="<%= url_for(permitted_params.merge(page: 1)) %>" class="pagination-btn pagination-first">最初</a>
              <a href="<%= url_for(permitted_params.merge(page: @results.prev_page)) %>" class="pagination-btn pagination-prev">前へ</a>
            <% else %>
              <span class="pagination-btn pagination-first disabled">最初</span>
              <span class="pagination-btn pagination-prev disabled">前へ</span>
            <% end %>

            <div class="pagination-pages">
              <% start_page = [@results.current_page - 2, 1].max %>
              <% end_page = [start_page + 4, @results.total_pages].min %>
              <% start_page = [end_page - 4, 1].max %>

              <% (start_page..end_page).each do |page| %>
                <% if page == @results.current_page %>
                  <span class="pagination-btn pagination-current"><%= page %></span>
                <% else %>
                  <a href="<%= url_for(permitted_params.merge(page: page)) %>" class="pagination-btn"><%= page %></a>
                <% end %>
              <% end %>
            </div>

            <% if @results.next_page %>
              <a href="<%= url_for(permitted_params.merge(page: @results.next_page)) %>" class="pagination-btn pagination-next">次へ</a>
              <a href="<%= url_for(permitted_params.merge(page: @results.total_pages)) %>" class="pagination-btn pagination-last">最後</a>
            <% else %>
              <span class="pagination-btn pagination-next disabled">次へ</span>
              <span class="pagination-btn pagination-last disabled">最後</span>
            <% end %>
          </div>
        </div>
      <% end %>
    <% else %>
      <div class="no-results">
        <div class="no-results-icon">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
        </div>
        <h2>該当する大学が見つかりませんでした</h2>
        <p>条件を変更して、もう一度お試しください。</p>
        <a href="javascript:history.back()" class="back-button">
          条件を変更する
        </a>
      </div>
    <% end %>

  <!-- Login Modal -->
  <div id="loginModal" class="login-modal-overlay">
    <div class="login-modal">
      <div class="login-modal-header">
        <h3 class="login-modal-title">ログインが必要です</h3>
        <button class="login-modal-close" onclick="closeLoginModal()">&times;</button>
      </div>
      <div class="login-modal-body">
        <p id="modalMessage" class="login-modal-message">
          お気に入り機能を利用するには、ログインまたは新規登録が必要です。
        </p>
        <div class="login-modal-buttons">
          <a href="/login" class="login-modal-btn login-modal-btn-primary">
            <i class="fas fa-sign-in-alt"></i>
            ログイン
          </a>
          <a href="/register" class="login-modal-btn login-modal-btn-secondary">
            <i class="fas fa-user-plus"></i>
            新規登録
          </a>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Modal functions
    function showLoginModal(type = 'favorite') {
      const modal = document.getElementById('loginModal');
      const message = document.getElementById('modalMessage');

      if (type === 'compare') {
        message.textContent = '比較機能を利用するには、ログインまたは新規登録が必要です。';
      } else {
        message.textContent = 'お気に入り機能を利用するには、ログインまたは新規登録が必要です。';
      }

      modal.style.display = 'flex';
    }
    
    function closeLoginModal() {
      document.getElementById('loginModal').style.display = 'none';
    }
    
    // Close modal when clicking overlay
    document.getElementById('loginModal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeLoginModal();
      }
    });

    // インライン関数定義
    function handleFavoriteClick(button, event) {
      event.stopPropagation();
      console.log('Favorite button clicked!');
      
      const conditionId = button.getAttribute('data-condition-id');
      const isLoggedIn = <%= logged_in? ? 'true' : 'false' %>;
      console.log('Condition ID:', conditionId, 'Logged in:', isLoggedIn);
      
      if (!isLoggedIn) {
        showLoginModal('favorite');
        return;
      }
      
      const isFavorited = button.classList.contains('favorited');
      const url = '/favorites';
      const method = isFavorited ? 'DELETE' : 'POST';
      
      button.disabled = true;
      
      fetch(url, {
        method: method,
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
        },
        body: JSON.stringify({
          condition_id: conditionId
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          if (data.favorited) {
            button.classList.add('favorited');
            button.title = 'お気に入り済み';
          } else {
            button.classList.remove('favorited');
            button.title = 'お気に入りに追加';
          }
        }
      })
      .catch(error => {
        console.error('Error:', error);
      })
      .finally(() => {
        button.disabled = false;
      });
    }
    
    function handleCompareClick(button, event) {
      event.stopPropagation();
      console.log('Compare button clicked!');
      
      const conditionId = button.getAttribute('data-condition-id');
      const isLoggedIn = <%= logged_in? ? 'true' : 'false' %>;
      const isAdded = button.classList.contains('added');
      console.log('Condition ID:', conditionId, 'Logged in:', isLoggedIn, 'Is added:', isAdded);
      
      if (!isLoggedIn) {
        showLoginModal('compare');
        return;
      }
      
      const url = '/compare';
      const method = isAdded ? 'DELETE' : 'POST';
      
      button.disabled = true;
      
      fetch(url, {
        method: method,
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
        },
        body: JSON.stringify({
          condition_id: conditionId
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          if (method === 'POST') {
            button.classList.add('added');
            button.title = '比較リストに追加済み';
          } else {
            button.classList.remove('added');
            button.title = '比較リストに追加';
          }
        }
      })
      .catch(error => {
        console.error('Error:', error);
      })
      .finally(() => {
        button.disabled = false;
      });
    }

    function initializeSorting() {
      const table = document.getElementById('resultsTable');
      if (!table) return;

      const tbody = table.querySelector('tbody');
      if (!tbody) return;

      const rows = Array.from(tbody.querySelectorAll('tr'));
      const headers = table.querySelectorAll('th.sortable');
      const perPageSelect = document.getElementById('perPageSelect');

      // URLパラメータから現在のソート状態を取得
      const urlParams = new URLSearchParams(window.location.search);
      const currentSortParam = urlParams.get('sort');
      let currentSort = { column: null, direction: null };

      if (currentSortParam) {
        const [column, direction] = currentSortParam.split('-');
        currentSort = { column, direction };

        // ヘッダーのソート状態を表示
        headers.forEach(header => {
          header.classList.remove('sort-asc', 'sort-desc');
          if (header.getAttribute('data-sort') === column) {
            header.classList.add(`sort-${direction}`);
          }
        });
      }

      // 表示件数変更イベント
      if (perPageSelect) {
        perPageSelect.addEventListener('change', function() {
          const currentUrl = new URL(window.location);
          currentUrl.searchParams.set('per_page', this.value);
          currentUrl.searchParams.set('page', 1); // ページをリセット
          window.location.href = currentUrl.toString();
        });
      }

      // モバイル用ソート変更イベント
      const mobileSortSelect = document.getElementById('mobileSortSelect');
      if (mobileSortSelect) {
        mobileSortSelect.addEventListener('change', function() {
          const value = this.value;
          if (value) {
            const currentUrl = new URL(window.location);
            currentUrl.searchParams.set('sort', value);
            currentUrl.searchParams.set('page', 1); // ページをリセット
            window.location.href = currentUrl.toString();
          }
        });
      }

      // ソート関数
      function sortTable(column, direction) {
        // サーバーサイドソートを実行
        const currentUrl = new URL(window.location);
        currentUrl.searchParams.set('sort', `${column}-${direction}`);
        currentUrl.searchParams.set('page', 1); // ページをリセット
        window.location.href = currentUrl.toString();
      }

      // ヘッダークリックイベント
      headers.forEach(header => {
        header.addEventListener('click', function() {
          const column = this.getAttribute('data-sort');
          let direction = 'asc';

          if (currentSort.column === column && currentSort.direction === 'asc') {
            direction = 'desc';
          }

          sortTable(column, direction);
        });
      });
    }

    // お気に入りと比較ボタンの初期化
    function initializeFavoriteAndCompare() {
      // お気に入りボタンのイベントリスナー
      console.log('Setting up favorite buttons...');
      const favoriteButtons = document.querySelectorAll('.favorite-btn-small');
      console.log('Found favorite buttons:', favoriteButtons.length);
      
      favoriteButtons.forEach(btn => {
        btn.addEventListener('click', function(e) {
          console.log('Favorite button clicked!');
          e.stopPropagation();
          const conditionId = this.getAttribute('data-condition-id');
          const isLoggedIn = <%= logged_in? ? 'true' : 'false' %>;
          console.log('Condition ID:', conditionId, 'Logged in:', isLoggedIn);
          
          if (!isLoggedIn) {
            showLoginModal('favorite');
            return;
          }
          
          const isFavorited = this.classList.contains('favorited');
          const url = '/favorites';
          const method = isFavorited ? 'DELETE' : 'POST';
          
          this.disabled = true;
          
          fetch(url, {
            method: method,
            headers: {
              'Content-Type': 'application/json',
              'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
            },
            body: JSON.stringify({
              condition_id: conditionId
            })
          })
          .then(response => response.json())
          .then(data => {
            if (data.status === 'success') {
              if (data.favorited) {
                this.classList.add('favorited');
                this.title = 'お気に入り済み';
              } else {
                this.classList.remove('favorited');
                this.title = 'お気に入りに追加';
              }
            }
          })
          .catch(error => {
            console.error('Error:', error);
          })
          .finally(() => {
            this.disabled = false;
          });
        });
      });

      // 比較ボタンのイベントリスナー
      console.log('Setting up compare buttons...');
      const compareButtons = document.querySelectorAll('.compare-btn-small');
      console.log('Found compare buttons:', compareButtons.length);
      
      compareButtons.forEach(btn => {
        btn.addEventListener('click', function(e) {
          console.log('Compare button clicked!');
          e.stopPropagation();
          const conditionId = this.getAttribute('data-condition-id');
          const isAdded = this.classList.contains('added');
          console.log('Condition ID:', conditionId, 'Is added:', isAdded);
          const url = '/compare';
          const method = isAdded ? 'DELETE' : 'POST';
          
          this.disabled = true;
          
          fetch(url, {
            method: method,
            headers: {
              'Content-Type': 'application/json',
              'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
            },
            body: JSON.stringify({
              condition_id: conditionId
            })
          })
          .then(response => response.json())
          .then(data => {
            if (data.status === 'success') {
              if (method === 'POST') {
                this.classList.add('added');
                this.title = '比較リストに追加済み';
              } else {
                this.classList.remove('added');
                this.title = '比較リストに追加';
              }
            }
          })
          .catch(error => {
            console.error('Error:', error);
          })
          .finally(() => {
            this.disabled = false;
          });
        });
      });
    }

    // DOMContentLoadedとturbo:loadの両方で初期化
    document.addEventListener('DOMContentLoaded', function() {
      initializeSorting();
      initializeFavoriteAndCompare();
    });
    document.addEventListener('turbo:load', function() {
      initializeSorting();
      initializeFavoriteAndCompare();
    });
  </script>
    </div>
  </section>
</div>