<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">

  <%# SEOÊúÄÈÅ©Âåñ %>
  <% seo_title = @college.seo_title %>
  <% state_name = @college.state %>
  <% tuition_display = @college.tuition.present? ? number_to_currency(@college.tuition, precision: 0) : "N/A" %>
  <% acceptance_display = @college.acceptance_rate.present? ? "#{(@college.acceptance_rate * 100).round(1)}%" : "N/A" %>

  <title><%= seo_title %>„ÅÆÁïôÂ≠¶ÊÉÖÂ†±„ÉªÂ≠¶Ë≤ª„ÉªÂêàÊ†ºÁéá | College Spark</title>
  <meta name="description" content="<%= seo_title %>Ôºà<%= state_name %>Â∑ûÔºâ„ÅÆË©≥Á¥∞ÊÉÖÂ†±„ÄÇÂ≠¶Ë≤ª: <%= tuition_display %>„ÄÅÂêàÊ†ºÁéá: <%= acceptance_display %>„ÄÇÁïôÂ≠¶„Å´ÂøÖË¶Å„Å™ÊÉÖÂ†±„ÇíÂæπÂ∫ïËß£Ë™¨„ÄÇ">
  <meta name="keywords" content="<%= @college.college %>, <%= @college.name_ja %>, <%= state_name %>, „Ç¢„É°„É™„Ç´ÁïôÂ≠¶, Â§ßÂ≠¶ÁïôÂ≠¶, Â≠¶Ë≤ª, ÂêàÊ†ºÁéá">

  <%# OGP %>
  <meta property="og:title" content="<%= seo_title %>„ÅÆÁïôÂ≠¶ÊÉÖÂ†± | College Spark">
  <meta property="og:description" content="<%= seo_title %>Ôºà<%= state_name %>Â∑ûÔºâ„ÅÆÂ≠¶Ë≤ª„ÉªÂêàÊ†ºÁéá„ÉªÂÖ•Â≠¶Êù°‰ª∂„Å™„Å©Ë©≥Á¥∞ÊÉÖÂ†±„ÇíÊé≤Ëºâ„ÄÇ">
  <meta property="og:type" content="article">
  <meta property="og:url" content="<%= request.original_url %>">
  <meta property="og:site_name" content="College Spark">
  <meta property="og:locale" content="ja_JP">

  <%# Twitter Cards %>
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="<%= seo_title %> | College Spark">
  <meta name="twitter:description" content="<%= seo_title %>Ôºà<%= state_name %>Â∑ûÔºâ„ÅÆÁïôÂ≠¶ÊÉÖÂ†±„ÄÇÂ≠¶Ë≤ª„ÉªÂêàÊ†ºÁéá„ÉªÂÖ•Â≠¶Êù°‰ª∂„ÇíÊé≤Ëºâ„ÄÇ">

  <%# Canonical URL %>
  <link rel="canonical" href="<%= conditions_url(@college) %>">

  <%# ÊßãÈÄ†Âåñ„Éá„Éº„Çø (JSON-LD) %>
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "EducationalOrganization",
    "name": "<%= @college.college %>",
    <% if @college.name_ja.present? %>"alternateName": "<%= @college.name_ja %>",<% end %>
    "url": "<%= @college.website.present? ? (@college.website.match?(/^https?:\/\//) ? @college.website : "https://#{@college.website}") : conditions_url(@college) %>",
    "address": {
      "@type": "PostalAddress",
      "addressLocality": "<%= @college.city %>",
      "addressRegion": "<%= @college.state %>",
      "postalCode": "<%= @college.zip %>",
      "addressCountry": "US"
    },
    <% if @college.tuition.present? %>
    "isAccessibleForFree": false,
    <% end %>
    "sameAs": "<%= conditions_url(@college) %>"
  }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Helvetica Neue", Arial, sans-serif;
      line-height: 1.6;
      color: #1c1917;
      background: #f9fafb;
      min-height: 100vh;
    }

    /* „É¢„Éê„Ç§„É´/„Éá„Çπ„ÇØ„Éà„ÉÉ„ÉóË°®Á§∫Âàá„ÇäÊõø„Åà */
    .mobile-text {
      display: none;
    }
    .desktop-text {
      display: inline;
    }

    .page-container {
      min-height: 100vh;
      background: white;
    }

    .hero-section {
      <% if @college_photo && @college_photo[:url] %>
        background: linear-gradient(135deg, rgba(26, 32, 44, 0.85), rgba(45, 55, 72, 0.85)),
                    url('<%= @college_photo[:url] %>') center/cover;
      <% else %>
        background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
      <% end %>
      min-height: 400px;
      padding: 80px 20px 100px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
    }

    .hero-section::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 80px;
      height: 4px;
      background: #f0b13d;
    }
    
    .image-attribution {
      position: absolute;
      bottom: 10px;
      right: 10px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 5px 10px;
      border-radius: 4px;
      font-size: 11px;
      z-index: 10;
    }
    
    .image-attribution a {
      color: white;
      text-decoration: none;
      opacity: 0.8;
    }
    
    .image-attribution a:hover {
      opacity: 1;
      text-decoration: underline;
    }

    .hero-content {
      text-align: center;
      color: white;
      z-index: 2;
      max-width: 800px;
      padding: 0 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }

    .hero-title {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Helvetica Neue", Arial, sans-serif;
      font-size: clamp(1.8rem, 3.5vw, 2.8rem);
      font-weight: 700;
      margin-bottom: 0.3rem;
      text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
      line-height: 1.2;
      word-wrap: break-word;
      overflow-wrap: break-word;
      hyphens: auto;
      max-width: 100%;
      text-align: center;
    }

    .hero-subtitle {
      font-size: 1.2rem;
      margin-bottom: 0.5rem;
      opacity: 0.9;
      text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
    }

    .hero-location {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: rgba(255, 255, 255, 0.15);
      padding: 8px 16px;
      border-radius: 25px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      font-size: 0.9rem;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 20px;
    }

    .main-content {
      background: white;
      margin-top: -60px;
      position: relative;
      z-index: 3;
      border-radius: 16px 16px 0 0;
      box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.08);
    }

    .content-padding {
      padding: 60px 40px 40px;
    }

    .quick-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 60px;
    }

    .stat-card {
      background: white;
      color: #1a1a1a;
      padding: 28px 20px;
      border-radius: 8px;
      text-align: center;
      position: relative;
      overflow: hidden;
      border: 1px solid #e5e5e5;
      transition: all 0.2s ease;
    }

    .stat-card:hover {
      border-color: #1a1a1a;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: rgb(240, 177, 61);
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    .stat-card:hover::before {
      opacity: 1;
    }

    .stat-icon {
      font-size: 1.2rem;
      margin-bottom: 12px;
      color: #999;
      display: block;
      transition: color 0.2s ease;
    }

    .stat-card:hover .stat-icon {
      color: rgb(240, 177, 61);
    }

    .stat-value {
      font-size: 2rem;
      font-weight: 700;
      margin: 0 0 8px 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Helvetica Neue", Arial, sans-serif;
      color: #1a1a1a;
      line-height: 1;
      letter-spacing: -0.02em;
    }

    .stat-label {
      font-size: 0.75rem;
      color: #666;
      font-weight: 500;
      letter-spacing: 0.03em;
      text-transform: uppercase;
      margin: 0;
      display: block;
    }

    .section {
      margin-bottom: 60px;
    }

    .section-title {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Helvetica Neue", Arial, sans-serif;
      font-size: 1.6rem;
      font-weight: 700;
      color: #1a1a1a;
      margin-bottom: 24px;
      position: relative;
      padding-left: 16px;
    }

    .section-title::before {
      content: '';
      position: absolute;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
      width: 4px;
      height: 28px;
      background: rgb(240, 177, 61);
      border-radius: 2px;
    }

    /* Detail Info Section - Terms Style */
    .detail-section-container {
      margin: 40px 0;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    }

    .detail-section-header {
      background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
      padding: 40px 20px;
      text-align: center;
      color: white;
    }

    .detail-section-header h2 {
      font-size: 1.5rem;
      font-weight: 700;
      margin: 0 0 8px 0;
      letter-spacing: 0.02em;
    }

    .detail-section-header p {
      font-size: 0.875rem;
      color: rgba(255, 255, 255, 0.7);
      margin: 0;
    }

    .detail-section-body {
      background: #f9fafb;
      padding: 32px 20px;
    }

    .details-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
      max-width: 800px;
      margin: 0 auto;
    }

    .details-grid-3 {
      grid-template-columns: repeat(3, 1fr);
      max-width: 900px;
    }

    .details-grid-4 {
      grid-template-columns: repeat(4, 1fr);
      max-width: 1000px;
    }

    .details-grid-5 {
      grid-template-columns: repeat(5, 1fr);
      max-width: 1100px;
    }

    .detail-card {
      background: white;
      padding: 24px 20px;
      border-radius: 8px;
      border: 1px solid #e5e5e5;
      text-align: center;
      transition: all 0.2s ease;
    }

    .detail-card:hover {
      border-color: #f0b13d;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    .detail-icon {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, #f0b13d 0%, #e09c2a 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 12px;
      color: white;
      font-size: 1rem;
    }

    .detail-title {
      font-size: 0.75rem;
      color: #78716c;
      margin-bottom: 8px;
      font-weight: 600;
      letter-spacing: 0.05em;
      text-transform: uppercase;
    }

    .detail-value {
      font-size: 1.25rem;
      font-weight: 700;
      color: #1c1917;
      line-height: 1.3;
    }

    /* Major Section - Terms Style */
    .major-section-container {
      margin: 40px 0;
    }

    .major-section-header {
      background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
      padding: 50px 20px;
      text-align: center;
      color: white;
      border-radius: 8px 8px 0 0;
    }

    .major-section-header h2 {
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 8px;
      letter-spacing: -0.5px;
    }

    .major-section-header p {
      font-size: 14px;
      font-weight: 300;
      opacity: 0.8;
      letter-spacing: 2px;
      text-transform: uppercase;
    }

    .major-header-divider {
      width: 50px;
      height: 3px;
      background: rgb(240, 177, 61);
      margin: 20px auto 0;
    }

    .major-card-wrapper {
      padding: 30px 20px;
    }

    .major-card-bg {
      background: #f5f5f5;
    }

    .major-card {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      padding: 32px;
      border-radius: 8px;
      border: 1px solid #e5e5e5;
      position: relative;
      overflow: hidden;
    }

    .major-card-number {
      font-size: 60px;
      font-weight: 700;
      color: rgba(240, 177, 61, 0.1);
      position: absolute;
      top: 10px;
      right: 20px;
      line-height: 1;
    }

    .major-card h3 {
      font-size: 22px;
      font-weight: 700;
      color: #1a1a1a;
      margin-bottom: 16px;
      position: relative;
      z-index: 1;
    }

    .major-card p {
      font-size: 15px;
      line-height: 1.8;
      color: #555;
      margin-bottom: 0;
      position: relative;
      z-index: 1;
    }

    .major-card strong {
      color: rgb(200, 140, 40);
      font-weight: 600;
    }

    /* Major Ranking List */
    .major-ranking-list {
      margin-top: 16px;
    }

    .major-ranking-row {
      display: grid;
      grid-template-columns: 30px 1fr 50px 80px;
      gap: 12px;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid #f0f0f0;
    }

    .major-ranking-row:last-child {
      border-bottom: none;
    }

    .major-rank {
      width: 26px;
      height: 26px;
      background: rgb(240, 177, 61);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 13px;
    }

    .major-field-name {
      font-weight: 500;
      color: #1a1a1a;
      font-size: 14px;
    }

    .major-field-percent {
      font-weight: 600;
      color: rgb(200, 140, 40);
      font-size: 14px;
      text-align: right;
    }

    .major-field-bar {
      height: 6px;
      background: #e5e5e5;
      border-radius: 3px;
      overflow: hidden;
    }

    .major-field-bar-fill {
      height: 100%;
      background: rgb(240, 177, 61);
      border-radius: 3px;
    }

    /* Major Tags Grid */
    .major-tags-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 12px;
    }

    .major-tag {
      display: inline-block;
      padding: 6px 12px;
      background: #f5f5f5;
      border: 1px solid #e5e5e5;
      border-radius: 20px;
      font-size: 13px;
      color: #555;
    }

    /* Major Note Card */
    .major-note-card {
      text-align: center;
      padding: 20px;
    }

    .major-note-card p {
      color: #888;
      font-size: 13px;
    }

    .major-note-card i {
      margin-right: 6px;
      color: #aaa;
    }

    /* Major No Data */
    .major-no-data {
      text-align: center;
      padding: 50px 30px;
    }

    .major-no-data i {
      font-size: 48px;
      color: rgb(240, 177, 61);
      margin-bottom: 16px;
    }

    .major-no-data h3 {
      margin-bottom: 8px;
    }

    /* Mobile Responsive */
    @media (max-width: 480px) {
      .major-section-header {
        padding: 30px 15px;
      }

      .major-section-header h2 {
        font-size: 24px;
      }

      .major-card-wrapper {
        padding: 20px 15px;
      }

      .major-card {
        padding: 20px;
      }

      .major-card-number {
        font-size: 40px;
      }

      .major-card h3 {
        font-size: 18px;
      }

      .major-ranking-row {
        grid-template-columns: 26px 1fr 45px;
        gap: 8px;
      }

      .major-field-bar {
        display: none;
      }

      .major-field-name {
        font-size: 13px;
      }

      .major-tag {
        font-size: 12px;
        padding: 5px 10px;
      }
    }

    .social-section {
      background: #f0b13d;
      color: white;
      padding: 32px;
      border-radius: 12px;
      text-align: center;
      margin-bottom: 40px;
    }

    .social-title {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Helvetica Neue", Arial, sans-serif;
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 20px;
    }

    .social-links {
      display: flex;
      justify-content: center;
      gap: 20px;
      flex-wrap: wrap;
    }

    .social-link {
      width: 50px;
      height: 50px;
      background: rgba(255, 255, 255, 0.15);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 1.3rem;
      text-decoration: none;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .social-link:hover {
      background: rgba(255, 255, 255, 0.25);
      transform: translateY(-2px);
    }

    .back-button {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 12px 28px;
      background: #1a1a1a;
      color: white;
      text-decoration: none;
      border-radius: 25px;
      font-weight: 600;
      transition: all 0.2s ease;
      margin: 40px auto;
      display: flex;
      justify-content: center;
      max-width: 220px;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Helvetica Neue", Arial, sans-serif;
    }

    .back-button:hover {
      background: rgb(240, 177, 61);
      color: white;
      text-decoration: none;
    }

    .website-link {
      color: #f9e5c5;
      text-decoration: none;
      font-weight: 500;
      transition: color 0.3s ease;
    }

    .website-link:hover {
      color: #ffffff;
    }

    .comment-section {
      background: #f8f8f8;
      padding: 32px;
      border-radius: 8px;
      border: 1px solid #e5e5e5;
      border-left: 4px solid rgb(240, 177, 61);
      position: relative;
      margin-bottom: 20px;
    }

    .comment-icon {
      position: absolute;
      top: -10px;
      left: 20px;
      background: #1a1a1a;
      color: white;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
    }

    .comment-content {
      font-size: 1rem;
      line-height: 1.8;
      color: #333;
      font-style: italic;
      padding-top: 10px;
      text-align: justify;
    }

    .action-buttons {
      margin-top: 10px;
      padding-bottom: 20px;
      display: flex;
      gap: 16px;
      justify-content: center;
      flex-wrap: wrap;
      max-width: 500px;
      margin-left: auto;
      margin-right: auto;
    }
    
    .favorite-section, .compare-section {
      flex: 1;
      min-width: 180px;
      max-width: 240px;
    }

    .favorite-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 12px 20px;
      background: transparent;
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Helvetica Neue", Arial, sans-serif;
      width: 100%;
      justify-content: center;
      min-height: 44px;
    }

    .favorite-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: rgba(255, 255, 255, 0.5);
    }

    .favorite-btn.favorited {
      background: rgb(240, 177, 61);
      border-color: rgb(240, 177, 61);
      color: #1a1a1a;
    }

    .favorite-btn.favorited:hover {
      background: rgb(220, 160, 50);
      border-color: rgb(220, 160, 50);
    }

    .favorite-btn i {
      font-size: 14px;
      transition: none;
    }

    .favorite-btn:hover i {
      transform: none;
    }

    .favorite-btn.favorited i {
      color: #1a1a1a;
      filter: none;
    }

    /* ÊØîËºÉ„Éú„Çø„É≥ */
    .compare-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 12px 20px;
      background: transparent;
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Helvetica Neue", Arial, sans-serif;
      width: 100%;
      justify-content: center;
      min-height: 44px;
    }

    .compare-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: rgba(255, 255, 255, 0.5);
    }

    .compare-btn.added {
      background: white;
      border-color: white;
      color: #1a1a1a;
    }

    .compare-btn.added:hover {
      background: #f5f5f5;
      border-color: #f5f5f5;
    }

    .compare-btn i {
      font-size: 14px;
    }

    .compare-btn.added i {
      color: #1a1a1a;
    }

    /* „É≠„Ç∞„Ç§„É≥„É¢„Éº„ÉÄ„É´ */
    .login-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10000;
      backdrop-filter: blur(4px);
    }

    .login-modal-content {
      background: white;
      border-radius: 12px;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
      animation: modalSlideIn 0.25s ease;
      overflow: hidden;
    }

    @keyframes modalSlideIn {
      from {
        transform: translateY(-30px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .login-modal-header {
      background: #1a1a1a;
      color: white;
      padding: 20px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .login-modal-header h3 {
      margin: 0;
      font-size: 17px;
      font-weight: 600;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Helvetica Neue", Arial, sans-serif;
    }

    .login-modal-close {
      background: none;
      border: none;
      color: white;
      font-size: 22px;
      cursor: pointer;
      padding: 0;
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: background 0.2s ease;
      opacity: 0.7;
    }

    .login-modal-close:hover {
      background: rgba(255, 255, 255, 0.15);
      opacity: 1;
    }

    .login-modal-body {
      padding: 32px 24px;
      text-align: center;
    }

    .login-modal-text {
      font-size: 15px;
      color: #333;
      line-height: 1.6;
      margin: 0 0 28px 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Helvetica Neue", Arial, sans-serif;
    }

    .login-modal-actions {
      display: flex;
      gap: 12px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .login-modal-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 12px 24px;
      border-radius: 6px;
      text-decoration: none;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.2s ease;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Helvetica Neue", Arial, sans-serif;
      min-width: 120px;
      justify-content: center;
    }

    .login-btn-primary {
      background: #1a1a1a;
      color: white;
    }

    .login-btn-primary:hover {
      background: #333;
      text-decoration: none;
    }

    .login-btn-secondary {
      background: white;
      color: #1a1a1a;
      border: 1px solid #e5e5e5;
    }

    .login-btn-secondary:hover {
      background: #f5f5f5;
      border-color: #ddd;
      text-decoration: none;
    }

    /* Demographics Charts Styling */
    .demographics-charts,
    .test-scores-charts {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 40px;
      margin-bottom: 40px;
    }

    .chart-container {
      background: white;
      padding: 28px;
      border-radius: 8px;
      border: 1px solid #e5e5e5;
      transition: all 0.2s ease;
    }

    .chart-container:hover {
      border-color: #1a1a1a;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    .chart-header {
      margin-bottom: 24px;
      text-align: center;
    }

    .chart-title {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Helvetica Neue", Arial, sans-serif;
      font-size: 1.2rem;
      font-weight: 700;
      color: #1a1a1a;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin: 0;
    }

    .chart-title i {
      color: rgb(240, 177, 61);
      font-size: 1.1rem;
    }

    .info-icon {
      margin-left: 8px;
      cursor: help;
      color: #6b7280;
      transition: color 0.3s ease;
    }

    .info-icon:hover {
      color: #f0b13d;
    }

    .chart-description {
      margin-top: 12px;
      padding: 12px 16px;
      background: #f8f8f8;
      border-radius: 6px;
      border-left: 3px solid rgb(240, 177, 61);
    }

    .chart-description p {
      margin: 0;
      font-size: 14px;
      color: #666;
      line-height: 1.5;
    }

    .score-details {
      margin-top: 24px;
      padding: 20px;
      background: #f8f8f8;
      border-radius: 8px;
      border: 1px solid #e5e5e5;
    }

    .score-explanation h4 {
      margin: 0 0 16px 0;
      color: #1a1a1a;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Helvetica Neue", Arial, sans-serif;
      font-size: 15px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .score-explanation h4::before {
      content: 'üìä';
      font-size: 16px;
    }

    .score-explanation ul {
      margin: 0;
      padding-left: 20px;
      list-style-type: disc;
    }

    .score-explanation li {
      margin-bottom: 8px;
      font-size: 14px;
      color: #4a5568;
      line-height: 1.5;
    }

    .score-explanation li strong {
      color: #2d3748;
      font-weight: 600;
    }

    /* Campus Info & Special Designations */
    .campus-info-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 40px;
      margin-bottom: 40px;
    }

    .subsection-title {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Helvetica Neue", Arial, sans-serif;
      font-size: 1.2rem;
      font-weight: 600;
      color: #2d3748;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .subsection-title i {
      color: #f0b13d;
      font-size: 1.1rem;
    }

    /* Special Designations Badges */
    .badges-container {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }

    .designation-badge {
      position: relative;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
      color: white;
      cursor: help;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .designation-badge:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .hbcu-badge {
      background: #8B5CF6;
    }

    .hsi-badge {
      background: #F59E0B;
    }

    .tribal-badge {
      background: #10B981;
    }

    .women-badge {
      background: #EC4899;
    }

    .men-badge {
      background: #3B82F6;
    }

    .religious-badge {
      background: #6366F1;
    }

    .no-special-designation {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 500;
      color: #666;
      background: #f8f8f8;
      border: 1px solid #e5e5e5;
    }

    .badge-tooltip {
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      margin-bottom: 8px;
      padding: 6px 12px;
      background: rgba(45, 55, 72, 0.95);
      color: white;
      font-size: 12px;
      font-weight: 500;
      border-radius: 6px;
      white-space: nowrap;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
      z-index: 1000;
    }

    .badge-tooltip::after {
      content: '';
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 4px solid transparent;
      border-top-color: rgba(45, 55, 72, 0.95);
    }

    .designation-badge:hover .badge-tooltip {
      opacity: 1;
      visibility: visible;
    }

    /* Campus Location */
    .location-details {
      display: flex;
      flex-direction: row;
      gap: 12px;
    }

    .location-item {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 16px;
      background: rgba(251, 146, 60, 0.03);
      border-radius: 12px;
      border-left: 4px solid #f0b13d;
      flex: 1;
    }

    .location-item i {
      color: #f0b13d;
      font-size: 1.1rem;
      margin-top: 2px;
      min-width: 20px;
    }

    .location-content {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .location-content strong {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Helvetica Neue", Arial, sans-serif;
      font-weight: 600;
      color: #2d3748;
      font-size: 14px;
    }

    .location-content span {
      color: #4a5568;
      font-size: 14px;
      line-height: 1.5;
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
      .campus-info-grid {
        grid-template-columns: 1fr;
        gap: 30px;
      }

      .badges-container {
        justify-content: center;
      }

      .designation-badge {
        font-size: 12px;
        padding: 6px 12px;
      }

      .location-details {
        flex-direction: column;
        gap: 16px;
      }

      .location-item {
        padding: 12px;
      }
    }

    .chart-wrapper {
      position: relative;
      height: 300px;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      overflow: hidden;
    }

    .chart-wrapper canvas {
      max-height: 300px !important;
      max-width: 100% !important;
      width: auto !important;
      height: auto !important;
    }

    .no-data-message {
      text-align: center;
      padding: 60px 40px;
      background: #fffbf7;
      border-radius: 12px;
      border: 2px dashed #f9e5c5;
    }

    .no-data-message i {
      font-size: 3.5rem;
      color: #f0b13d;
      margin-bottom: 20px;
    }

    .no-data-message h3 {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Helvetica Neue", Arial, sans-serif;
      font-size: 1.5rem;
      color: #2d3748;
      margin-bottom: 12px;
    }

    .no-data-message p {
      color: #6b7280;
      font-size: 1.1rem;
      margin: 0;
      line-height: 1.6;
    }

    /* „É¨„Çπ„Éù„É≥„Ç∑„Éñ„Éá„Ç∂„Ç§„É≥ */
    @media (max-width: 768px) {
      .hero-section {
        min-height: 380px;
        padding: 40px 15px 60px;
      }

      .content-padding {
        padding: 40px 20px 20px;
      }

      .info-sections {
        grid-template-columns: 1fr;
        gap: 30px;
      }

      .info-card {
        padding: 24px;
      }

      .section-title {
        font-size: 1.8rem;
      }

      .hero-title {
        font-size: clamp(1.5rem, 4vw, 2rem);
        line-height: 1.15;
      }

      .social-links {
        gap: 16px;
      }

      .social-link {
        width: 44px;
        height: 44px;
        font-size: 1.1rem;
      }

      .demographics-charts,
      .test-scores-charts {
        grid-template-columns: 1fr;
        gap: 30px;
      }

      .chart-container {
        padding: 24px;
      }

      .chart-wrapper {
        height: 280px;
      }

      .chart-wrapper canvas {
        max-height: 280px !important;
      }

      .chart-title {
        font-size: 1.3rem;
        flex-direction: column;
        gap: 8px;
        text-align: center;
      }

      .chart-description {
        margin-top: 16px;
        padding: 16px;
      }

      .chart-description p {
        font-size: 13px;
        line-height: 1.6;
      }

      .score-details {
        margin-top: 20px;
        padding: 16px;
      }

      .score-explanation h4 {
        font-size: 15px;
        margin-bottom: 12px;
      }

      .score-explanation ul {
        padding-left: 16px;
      }

      .score-explanation li {
        font-size: 13px;
        margin-bottom: 8px;
        line-height: 1.5;
      }
    }

    @media (max-width: 480px) {
      .quick-stats {
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
      }

      .quick-stat {
        padding: 16px 12px;
      }

      .stat-number {
        font-size: 1.5rem;
      }

      .detail-section-header {
        padding: 30px 16px;
      }

      .detail-section-header h2 {
        font-size: 1.25rem;
      }

      .detail-section-body {
        padding: 20px 16px;
      }

      .details-grid,
      .details-grid-3,
      .details-grid-4,
      .details-grid-5 {
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
      }

      .detail-card {
        padding: 16px 12px;
      }

      .detail-icon {
        width: 32px;
        height: 32px;
        font-size: 0.875rem;
        margin-bottom: 8px;
      }

      .detail-title {
        font-size: 10px;
        margin-bottom: 4px;
      }

      .detail-value {
        font-size: 0.95rem;
      }

      /* „É¢„Éê„Ç§„É´/„Éá„Çπ„ÇØ„Éà„ÉÉ„ÉóË°®Á§∫Âàá„ÇäÊõø„Åà */
      .mobile-text {
        display: inline;
      }
      .desktop-text {
        display: none;
      }

      /* Â∞ÇÊîªÂàÜÈáé„Çª„ÇØ„Ç∑„Éß„É≥„ÅÆ„É¢„Éê„Ç§„É´ÊúÄÈÅ©Âåñ */
      .major-summary {
        padding: 14px !important;
        margin-bottom: 16px !important;
      }

      .major-rank-item {
        padding: 10px 12px !important;
        margin-bottom: 8px !important;
        border-left-width: 3px !important;
      }

      .major-rank-number {
        width: 24px !important;
        height: 24px !important;
        margin-right: 10px !important;
        font-size: 0.75rem !important;
      }

      .major-name {
        font-size: 0.85rem !important;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .major-note {
        padding: 12px !important;
        border-left-width: 3px !important;
      }

      .major-note > div:first-child {
        display: none;
      }

      .no-major-data {
        padding: 24px 16px !important;
      }

      .no-major-data i {
        font-size: 2rem !important;
      }

      .no-major-data h4 {
        font-size: 0.95rem !important;
      }

      .content-padding {
        padding: 30px 15px 15px;
      }

      .comment-section {
        padding: 24px 20px;
      }

      .comment-content {
        font-size: 1rem;
        text-align: left;
      }

      .action-buttons {
        flex-direction: column;
        gap: 12px;
      }
      
      .favorite-btn, .compare-btn {
        font-size: 13px;
        padding: 10px 20px;
      }
      
      .login-modal-content {
        max-width: 350px;
        margin: 20px;
      }
      
      .login-modal-body {
        padding: 24px 20px;
      }
      
      .login-modal-actions {
        flex-direction: column;
      }
      
      .login-modal-btn {
        width: 100%;
      }

      .demographics-charts,
      .test-scores-charts {
        grid-template-columns: 1fr;
        gap: 20px;
      }

      .chart-container {
        padding: 20px;
      }

      .chart-wrapper {
        height: 250px;
      }

      .chart-wrapper canvas {
        max-height: 250px !important;
      }

      .chart-title {
        font-size: 1.1rem;
        flex-direction: column;
        gap: 6px;
        line-height: 1.3;
      }

      .chart-title i {
        font-size: 1.1rem;
      }

      .chart-description {
        margin-top: 12px;
        padding: 12px;
      }

      .chart-description p {
        font-size: 12px;
        line-height: 1.5;
      }

      .score-details {
        margin-top: 16px;
        padding: 12px;
      }

      .score-explanation h4 {
        font-size: 14px;
        margin-bottom: 10px;
      }

      .score-explanation h4::before {
        font-size: 16px;
      }

      .score-explanation ul {
        padding-left: 14px;
      }

      .score-explanation li {
        font-size: 12px;
        margin-bottom: 6px;
        line-height: 1.4;
      }

      .no-data-message {
        padding: 40px 20px;
      }

      .no-data-message i {
        font-size: 2.5rem;
      }

      .no-data-message h3 {
        font-size: 1.3rem;
      }

      .no-data-message p {
        font-size: 1rem;
      }

      /* Major Programs Grid - Mobile Responsive */
      .major-programs-grid {
        grid-template-columns: 1fr !important;
        gap: 16px !important;
      }

      .major-program-card {
        padding: 16px !important;
      }

      .major-program-tags {
        grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)) !important;
        gap: 8px !important;
      }

      .major-program-tag {
        font-size: 0.8rem !important;
        padding: 6px 8px !important;
        text-align: center !important;
      }
    }
  </style>

  <style>
    /* Major Field Information Styles */
    .major-programs-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
    }

    .major-program-card {
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .major-program-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
    }

    .major-program-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #8b5cf6;
    }

    .major-program-title {
      margin: 0;
      color: #2d3748;
      font-weight: 600;
      font-size: 1rem;
    }

    .major-program-tags {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 6px;
    }

    .major-program-tag {
      font-size: 0.85rem;
      color: #6b7280;
      background: #f8fafc;
      padding: 4px 8px;
      border-radius: 4px;
      text-align: center;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Mobile Responsive for Major Programs */
    @media (max-width: 768px) {
      .major-programs-grid {
        grid-template-columns: 1fr;
        gap: 16px;
      }

      .major-program-card {
        padding: 16px;
      }

      .major-program-tags {
        grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
        gap: 8px;
      }

      .major-program-tag {
        font-size: 0.8rem;
        padding: 6px 8px;
      }
    }

    @media (max-width: 480px) {
      .major-programs-grid {
        gap: 12px;
      }

      .major-program-card {
        padding: 12px;
      }

      .major-program-tags {
        grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
        gap: 6px;
      }

      .major-program-tag {
        font-size: 0.75rem;
        padding: 4px 6px;
      }
    }

    /* Èñ¢ÈÄ£Â§ßÂ≠¶„Çª„ÇØ„Ç∑„Éß„É≥ */
    .related-colleges-section {
      background: #f8f9fa;
      padding: 60px 20px;
      margin-top: 40px;
    }

    .related-section-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: #1a202c;
      margin-bottom: 30px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .related-section-title i {
      color: #f59e0b;
    }

    .related-colleges-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
    }

    .related-college-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      text-decoration: none;
      color: inherit;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      transition: all 0.3s ease;
      display: block;
    }

    .related-college-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
    }

    .related-college-name {
      margin-bottom: 12px;
    }

    .related-name-ja {
      display: block;
      font-size: 1.1rem;
      font-weight: 600;
      color: #1a202c;
      margin-bottom: 4px;
    }

    .related-name-en {
      display: block;
      font-size: 0.85rem;
      color: #718096;
    }

    .related-name-en-only {
      font-size: 1rem;
      font-weight: 600;
      color: #1a202c;
    }

    .related-college-info {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }

    .related-info-item {
      font-size: 0.85rem;
      color: #4a5568;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .related-info-item i {
      color: #f59e0b;
      font-size: 0.75rem;
    }

    @media (max-width: 768px) {
      .related-colleges-section {
        padding: 40px 15px;
      }

      .related-colleges-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <%# „Éë„É≥„Åè„Åö„É™„Çπ„Éà %>
  <%= render 'shared/breadcrumb', items: [
    { name: '„Éõ„Éº„É†', path: root_path },
    { name: '„Ç¢„É°„É™„Ç´Â§ßÂ≠¶Ê§úÁ¥¢', path: '/results' },
    { name: @college.name_ja || @college.college }
  ] %>

  <div class="page-container">
    <!-- Hero Section -->
    <section class="hero-section">
      <div class="hero-content">
        <h1 class="hero-title">
          <% if @college.name_ja.present? %>
            <%= @college.name_ja %><br>
            <span style="font-size: 0.7em; opacity: 0.9;"><%= @college.college %></span>
          <% else %>
            <%= @college.college %>
          <% end %>
        </h1>
        <p class="hero-subtitle">
          <% if @college.website.present? %>
            <% url = @college.website.gsub(/\/$/, '') %>
            <% href_url = url.match?(/^https?:\/\//) ? url : "https://#{url}" %>
            <a href="<%= href_url %>" target="_blank" class="website-link"><%= url %></a>
          <% else %>
            „Ç¢„É°„É™„Ç´„ÅÆÂ§ßÂ≠¶
          <% end %>
        </p>
        <%# Address display hidden per user request %>

        <!-- „ÅäÊ∞ó„Å´ÂÖ•„Çä„Éú„Çø„É≥„ÉªÊØîËºÉ„Éú„Çø„É≥ -->
        <div class="action-buttons">
          <div class="favorite-section">
            <% if logged_in? %>
              <button id="favoriteBtn" class="favorite-btn <%= 'favorited' if current_user.favorite?(@college) %>" data-condition-id="<%= @college.id %>">
                <i class="fas fa-heart"></i>
                <span class="favorite-text">
                  <%= current_user.favorite?(@college) ? '„ÅäÊ∞ó„Å´ÂÖ•„ÇäÊ∏à„Åø' : '„ÅäÊ∞ó„Å´ÂÖ•„Çä„Å´ËøΩÂä†' %>
                </span>
              </button>
            <% else %>
              <button id="loginPromptBtn" class="favorite-btn" data-condition-id="<%= @college.id %>">
                <i class="fas fa-heart"></i>
                <span class="favorite-text">„ÅäÊ∞ó„Å´ÂÖ•„Çä„Å´ËøΩÂä†</span>
              </button>
            <% end %>
          </div>
          
          <div class="compare-section">
            <% if logged_in? %>
              <% comparison_list = current_user.comparison_list %>
              <button id="compareBtn" class="compare-btn <%= 'added' if comparison_list.include?(@college.id) %>" data-condition-id="<%= @college.id %>">
                <i class="fas fa-balance-scale"></i>
                <span class="compare-text">
                  <%= comparison_list.include?(@college.id) ? 'ËøΩÂä†Ê∏à„Åø' : 'ÊØîËºÉ„Å´ËøΩÂä†' %>
                </span>
              </button>
            <% else %>
              <button id="compareBtn" class="compare-btn" data-condition-id="<%= @college.id %>">
                <i class="fas fa-balance-scale"></i>
                <span class="compare-text">ÊØîËºÉ„Å´ËøΩÂä†</span>
              </button>
            <% end %>
          </div>
        </div>
      </div>
      
    </section>

    <!-- Main Content -->
    <div class="container">
      <div class="main-content">
        <div class="content-padding">
          
          <!-- Campus Location - Terms Style -->
          <div class="detail-section-container">
            <div class="detail-section-header">
              <h2>„Ç≠„É£„É≥„Éë„ÇπÊÉÖÂ†±</h2>
              <p>ÊâÄÂú®Âú∞„Å®Áí∞Â¢É</p>
            </div>
            <div class="detail-section-body">
              <div class="details-grid details-grid-3">
                <div class="detail-card">
                  <div class="detail-icon"><i class="fas fa-map-marker-alt"></i></div>
                  <div class="detail-title">Â∑û</div>
                  <div class="detail-value"><%=
                    if @college.state
                      case @college.state.gsub(/\s*\(.*?\)/, '')
                      when 'AL' then '„Ç¢„É©„Éê„ÉûÂ∑û'
                      when 'AK' then '„Ç¢„É©„Çπ„Ç´Â∑û'
                      when 'AZ' then '„Ç¢„É™„Çæ„ÉäÂ∑û'
                      when 'AR' then '„Ç¢„Éº„Ç´„É≥„ÇΩ„ÉºÂ∑û'
                      when 'CA' then '„Ç´„É™„Éï„Ç©„É´„Éã„Ç¢Â∑û'
                      when 'CO' then '„Ç≥„É≠„É©„ÉâÂ∑û'
                      when 'CT' then '„Ç≥„Éç„ÉÅ„Ç´„ÉÉ„ÉàÂ∑û'
                      when 'DE' then '„Éá„É©„Ç¶„Çß„Ç¢Â∑û'
                      when 'FL' then '„Éï„É≠„É™„ÉÄÂ∑û'
                      when 'GA' then '„Ç∏„Éß„Éº„Ç∏„Ç¢Â∑û'
                      when 'HI' then '„Éè„ÉØ„Ç§Â∑û'
                      when 'ID' then '„Ç¢„Ç§„ÉÄ„ÉõÂ∑û'
                      when 'IL' then '„Ç§„É™„Éé„Ç§Â∑û'
                      when 'IN' then '„Ç§„É≥„Éá„Ç£„Ç¢„ÉäÂ∑û'
                      when 'IA' then '„Ç¢„Ç§„Ç™„ÉØÂ∑û'
                      when 'KS' then '„Ç´„É≥„Ç∂„ÇπÂ∑û'
                      when 'KY' then '„Ç±„É≥„Çø„ÉÉ„Ç≠„ÉºÂ∑û'
                      when 'LA' then '„É´„Ç§„Ç∏„Ç¢„ÉäÂ∑û'
                      when 'ME' then '„É°„Ç§„É≥Â∑û'
                      when 'MD' then '„É°„É™„Éº„É©„É≥„ÉâÂ∑û'
                      when 'MA' then '„Éû„Çµ„ÉÅ„É•„Éº„Çª„ÉÉ„ÉÑÂ∑û'
                      when 'MI' then '„Éü„Ç∑„Ç¨„É≥Â∑û'
                      when 'MN' then '„Éü„Éç„ÇΩ„ÇøÂ∑û'
                      when 'MS' then '„Éü„Ç∑„Ç∑„ÉÉ„ÉîÂ∑û'
                      when 'MO' then '„Éü„Ç∫„Éº„É™Â∑û'
                      when 'MT' then '„É¢„É≥„Çø„ÉäÂ∑û'
                      when 'NE' then '„Éç„Éñ„É©„Çπ„Ç´Â∑û'
                      when 'NV' then '„Éç„Éê„ÉÄÂ∑û'
                      when 'NH' then '„Éã„É•„Éº„Éè„É≥„Éó„Ç∑„É£„ÉºÂ∑û'
                      when 'NJ' then '„Éã„É•„Éº„Ç∏„É£„Éº„Ç∏„ÉºÂ∑û'
                      when 'NM' then '„Éã„É•„Éº„É°„Ç≠„Ç∑„Ç≥Â∑û'
                      when 'NY' then '„Éã„É•„Éº„É®„Éº„ÇØÂ∑û'
                      when 'NC' then '„Éé„Éº„Çπ„Ç´„É≠„É©„Ç§„ÉäÂ∑û'
                      when 'ND' then '„Éé„Éº„Çπ„ÉÄ„Ç≥„ÇøÂ∑û'
                      when 'OH' then '„Ç™„Éè„Ç§„Ç™Â∑û'
                      when 'OK' then '„Ç™„ÇØ„É©„Éõ„ÉûÂ∑û'
                      when 'OR' then '„Ç™„É¨„Ç¥„É≥Â∑û'
                      when 'PA' then '„Éö„É≥„Ç∑„É´„Éô„Éã„Ç¢Â∑û'
                      when 'RI' then '„É≠„Éº„Éâ„Ç¢„Ç§„É©„É≥„ÉâÂ∑û'
                      when 'SC' then '„Çµ„Ç¶„Çπ„Ç´„É≠„É©„Ç§„ÉäÂ∑û'
                      when 'SD' then '„Çµ„Ç¶„Çπ„ÉÄ„Ç≥„ÇøÂ∑û'
                      when 'TN' then '„ÉÜ„Éç„Ç∑„ÉºÂ∑û'
                      when 'TX' then '„ÉÜ„Ç≠„Çµ„ÇπÂ∑û'
                      when 'UT' then '„É¶„ÇøÂ∑û'
                      when 'VT' then '„Éê„Éº„É¢„É≥„ÉàÂ∑û'
                      when 'VA' then '„Éê„Éº„Ç∏„Éã„Ç¢Â∑û'
                      when 'WA' then '„ÉØ„Ç∑„É≥„Éà„É≥Â∑û'
                      when 'WV' then '„Ç¶„Çß„Çπ„Éà„Éê„Éº„Ç∏„Éã„Ç¢Â∑û'
                      when 'WI' then '„Ç¶„Ç£„Çπ„Ç≥„É≥„Ç∑„É≥Â∑û'
                      when 'WY' then '„ÉØ„Ç§„Ç™„Éü„É≥„Ç∞Â∑û'
                      when 'DC' then '„ÉØ„Ç∑„É≥„Éà„É≥D.C.'
                      when 'PR' then '„Éó„Ç®„É´„Éà„É™„Ç≥'
                      else @college.state
                      end
                    else
                      'N/A'
                    end
                  %></div>
                </div>
                <div class="detail-card">
                  <div class="detail-icon"><i class="fas fa-university"></i></div>
                  <div class="detail-title">Ë®≠Á´ãÂΩ¢ÊÖã</div>
                  <div class="detail-value">
                    <% if @college.privateorpublic == "ÁßÅÁ´ã" || @college.privateorpublic == "Private" %>
                      ÁßÅÁ´ã
                    <% elsif @college.privateorpublic == "Â∑ûÁ´ã" || @college.privateorpublic == "Public" %>
                      Â∑ûÁ´ã
                    <% elsif @college.privateorpublic == "Âñ∂Âà©" %>
                      Âñ∂Âà©
                    <% else %>
                      <%= @college.privateorpublic || "N/A" %>
                    <% end %>
                  </div>
                </div>
                <div class="detail-card">
                  <div class="detail-icon"><i class="fas fa-building"></i></div>
                  <div class="detail-title">Áí∞Â¢É</div>
                  <div class="detail-value"><%=
                    case @college.urbanicity&.to_i
                    when 11
                      "Â§ßÈÉΩÂ∏Ç"
                    when 12
                      "‰∏≠ÈÉΩÂ∏Ç"
                    when 13
                      "Â∞èÈÉΩÂ∏Ç"
                    when 21
                      "Â§ßÈÉΩÂ∏ÇÈÉäÂ§ñ"
                    when 22
                      "‰∏≠ÈÉΩÂ∏ÇÈÉäÂ§ñ"
                    when 23
                      "Â∞èÈÉΩÂ∏ÇÈÉäÂ§ñ"
                    when 31
                      "ËøëÈö£Áî∫"
                    when 32
                      "ÈÅ†ÊñπÁî∫"
                    when 33
                      "ÂÉªÂú∞Áî∫"
                    when 41
                      "ËøëÈö£Âú∞Êñπ"
                    when 42
                      "ÈÅ†ÊñπÂú∞Êñπ"
                    when 43
                      "ÂÉªÂú∞"
                    else
                      "N/A"
                    end
                  %></div>
                </div>
              </div>
            </div>
          </div>

          <!-- University Comment Section (no title) -->
          <% if @college.comment.present? %>
          <div class="comment-section" style="margin: 40px 0;">
            <div class="comment-icon">
              <i class="fas fa-quote-left"></i>
            </div>
            <div class="comment-content">
              <%= @college.comment %>
            </div>
          </div>
          <% end %>

          <!-- Combined Stats Section - Terms Style -->
          <div class="detail-section-container">
            <div class="detail-section-header">
              <h2>Âü∫Êú¨ÊÉÖÂ†±</h2>
              <p>Â§ßÂ≠¶„ÅÆ‰∏ªË¶Å„Éá„Éº„Çø</p>
            </div>
            <div class="detail-section-body">
              <div class="details-grid details-grid-5">
                <div class="detail-card">
                  <div class="detail-icon"><i class="fas fa-users"></i></div>
                  <div class="detail-title">Â≠¶ÁîüÊï∞</div>
                  <div class="detail-value"><%= @college.students ? number_with_delimiter(@college.students) : "N/A" %></div>
                </div>
                <div class="detail-card">
                  <div class="detail-icon"><i class="fas fa-percentage"></i></div>
                  <div class="detail-title">ÂêàÊ†ºÁéá</div>
                  <div class="detail-value"><%= @college.acceptance_rate ? "#{(@college.acceptance_rate * 100).round}%" : "N/A" %></div>
                </div>
                <div class="detail-card">
                  <div class="detail-icon"><i class="fas fa-dollar-sign"></i></div>
                  <div class="detail-title">Âπ¥ÈñìÊéàÊ•≠Êñô</div>
                  <div class="detail-value">
                    <%=
                      if @college.privateorpublic == "Â∑ûÁ´ã" || @college.privateorpublic == "Public"
                        if @college.tuition_out_state.present?
                          "$#{number_with_delimiter(@college.tuition_out_state)}"
                        elsif @college.tuition.present?
                          "$#{number_with_delimiter(@college.tuition)}"
                        else
                          "N/A"
                        end
                      else
                        @college.tuition ? "$#{number_with_delimiter(@college.tuition)}" : "N/A"
                      end
                    %>
                  </div>
                </div>
                <div class="detail-card">
                  <div class="detail-icon"><i class="fas fa-graduation-cap"></i></div>
                  <div class="detail-title">ÂçíÊ•≠Áéá</div>
                  <div class="detail-value"><%= @college.graduation_rate ? "#{(@college.graduation_rate * 100).round}%" : "N/A" %></div>
                </div>
                <div class="detail-card">
                  <div class="detail-icon"><i class="fas fa-city"></i></div>
                  <div class="detail-title">Â∏Ç</div>
                  <div class="detail-value"><%= @college.city || "N/A" %></div>
                </div>
              </div>
            </div>
          </div>

          <!-- Demographics Section -->
          <div class="section">
            <h2 class="section-title">Â≠¶Áîü„ÅÆ‰∫∫Âè£Áµ±Ë®à</h2>
            
            <% 
              # Check if any demographic data is available
              has_ethnicity_data = @college.percent_white.present? || @college.percent_black.present? || 
                                   @college.percent_hispanic.present? || @college.percent_asian.present? || 
                                   @college.percent_non_resident_alien.present?
              has_gender_data = @college.percent_men.present? || @college.percent_women.present?
            %>
            
            <% if has_ethnicity_data || has_gender_data %>
              <div class="demographics-charts">
                <% if has_ethnicity_data %>
                  <div class="chart-container">
                    <div class="chart-header">
                      <h3 class="chart-title">
                        <i class="fas fa-globe-americas"></i>
                        Ê∞ëÊóèÊßãÊàê
                      </h3>
                    </div>
                    <div class="chart-wrapper">
                      <canvas id="ethnicityChart"></canvas>
                    </div>
                  </div>
                <% end %>
                
                <% if has_gender_data %>
                  <div class="chart-container">
                    <div class="chart-header">
                      <h3 class="chart-title">
                        <i class="fas fa-users"></i>
                        ÊÄßÂà•ÊßãÊàê
                      </h3>
                    </div>
                    <div class="chart-wrapper">
                      <canvas id="genderChart"></canvas>
                    </div>
                  </div>
                <% end %>
              </div>
            <% else %>
              <div class="no-data-message">
                <i class="fas fa-chart-pie"></i>
                <h3>‰∫∫Âè£Áµ±Ë®à„Éá„Éº„Çø„ÅØÁèæÂú®Âà©Áî®„Åß„Åç„Åæ„Åõ„Çì</h3>
                <p>„Åì„ÅÆÂ§ßÂ≠¶„ÅÆË©≥Á¥∞„Å™‰∫∫Âè£Áµ±Ë®à„Éá„Éº„Çø„ÅØÊ∫ñÂÇô‰∏≠„Åß„Åô„ÄÇ</p>
              </div>
            <% end %>
          </div>

          <!-- Test Scores Section -->
          <div class="section">
            <h2 class="section-title">„ÉÜ„Çπ„Éà„Çπ„Ç≥„Ç¢</h2>
            
            <% 
              # Check if any test score data is available
              has_sat_data = @college.sat_math_25.present? || @college.sat_math_75.present? || 
                            @college.sat_reading_25.present? || @college.sat_reading_75.present?
              has_act_data = @college.act_composite_25.present? || @college.act_composite_75.present?
            %>
            
            <% if has_sat_data || has_act_data %>
              <div class="test-scores-charts">
                <% if has_sat_data %>
                  <div class="chart-container">
                    <div class="chart-header">
                      <h3 class="chart-title">
                        <i class="fas fa-chart-bar"></i>
                        SAT„Çπ„Ç≥„Ç¢ÁØÑÂõ≤Ôºà25th-75th percentileÔºâ
                        <span class="info-icon" title="SAT„Çπ„Ç≥„Ç¢„ÅÆË©≥Á¥∞ÊÉÖÂ†±">
                          <i class="fas fa-info-circle"></i>
                        </span>
                      </h3>
                      <div class="chart-description">
                        <p>ÂÖ•Â≠¶ËÄÖ„ÅÆ‰∏≠Â§Æ50%„ÅÆ„Çπ„Ç≥„Ç¢ÁØÑÂõ≤„ÄÇ25th percentileÔºö‰∏ã‰Ωç25%„ÅÆÂ≠¶Áîü„ÅÆ„Çπ„Ç≥„Ç¢„ÄÅ75th percentileÔºö‰∏ä‰Ωç25%„ÅÆÂ≠¶Áîü„ÅÆ„Çπ„Ç≥„Ç¢</p>
                      </div>
                    </div>
                    <div class="chart-wrapper">
                      <canvas id="satChart"></canvas>
                    </div>
                    <div class="score-details">
                      <div class="score-explanation">
                        <h4>SAT„Å´„Å§„ÅÑ„Å¶</h4>
                        <ul>
                          <li><strong>Êï∞Â≠¶„Çª„ÇØ„Ç∑„Éß„É≥:</strong> 200-800ÁÇπÔºà‰ª£Êï∞„ÄÅÂπæ‰ΩïÂ≠¶„ÄÅ‰∏âËßíÊ≥ï„ÄÅ„Éá„Éº„ÇøÂàÜÊûêÔºâ</li>
                          <li><strong>Ë™≠Ëß£„Çª„ÇØ„Ç∑„Éß„É≥:</strong> 200-800ÁÇπÔºàË™≠Ëß£Âäõ„ÄÅÊñáÊ≥ï„ÄÅË™ûÂΩôÔºâ</li>
                          <li><strong>Á∑èÂêà„Çπ„Ç≥„Ç¢:</strong> 400-1600ÁÇπÔºàÊï∞Â≠¶+Ë™≠Ëß£Ôºâ</li>
                          <li><strong>ÂÖ®Á±≥Âπ≥Âùá:</strong> Êï∞Â≠¶ 520ÁÇπ„ÄÅË™≠Ëß£ 530ÁÇπ„ÄÅÁ∑èÂêà 1050ÁÇπ</li>
                          <li><strong>„ÉÅ„É£„Éº„ÉàÂÜÖ„ÅÆÈªÑËâ≤„ÅÑÊ£í:</strong> ÂÖ®Á±≥Âπ≥Âùá„ÇíÁ§∫„ÅôÂü∫Ê∫ñ</li>
                        </ul>
                      </div>
                    </div>
                  </div>
                <% end %>
                
                <% if has_act_data %>
                  <div class="chart-container">
                    <div class="chart-header">
                      <h3 class="chart-title">
                        <i class="fas fa-chart-bar"></i>
                        ACT„Çπ„Ç≥„Ç¢ÁØÑÂõ≤Ôºà25th-75th percentileÔºâ
                        <span class="info-icon" title="ACT„Çπ„Ç≥„Ç¢„ÅÆË©≥Á¥∞ÊÉÖÂ†±">
                          <i class="fas fa-info-circle"></i>
                        </span>
                      </h3>
                      <div class="chart-description">
                        <p>ÂÖ•Â≠¶ËÄÖ„ÅÆ‰∏≠Â§Æ50%„ÅÆ„Çπ„Ç≥„Ç¢ÁØÑÂõ≤„ÄÇ25th percentileÔºö‰∏ã‰Ωç25%„ÅÆÂ≠¶Áîü„ÅÆ„Çπ„Ç≥„Ç¢„ÄÅ75th percentileÔºö‰∏ä‰Ωç25%„ÅÆÂ≠¶Áîü„ÅÆ„Çπ„Ç≥„Ç¢</p>
                      </div>
                    </div>
                    <div class="chart-wrapper">
                      <canvas id="actChart"></canvas>
                    </div>
                    <div class="score-details">
                      <div class="score-explanation">
                        <h4>ACT„Å´„Å§„ÅÑ„Å¶</h4>
                        <ul>
                          <li><strong>Á∑èÂêà„Çπ„Ç≥„Ç¢:</strong> 1-36ÁÇπÔºà4„Å§„ÅÆ„Çª„ÇØ„Ç∑„Éß„É≥„ÅÆÂπ≥ÂùáÔºâ</li>
                          <li><strong>Ëã±Ë™û„Çª„ÇØ„Ç∑„Éß„É≥:</strong> 1-36ÁÇπÔºàÊñáÊ≥ï„ÄÅ‰øÆËæûÊäÄÊ≥ïÔºâ</li>
                          <li><strong>Êï∞Â≠¶„Çª„ÇØ„Ç∑„Éß„É≥:</strong> 1-36ÁÇπÔºà‰ª£Êï∞„ÄÅÂπæ‰ΩïÂ≠¶„ÄÅ‰∏âËßíÊ≥ïÔºâ</li>
                          <li><strong>Ë™≠Ëß£„Çª„ÇØ„Ç∑„Éß„É≥:</strong> 1-36ÁÇπÔºàÊï£Êñá„ÄÅ‰∫∫ÊñáÁßëÂ≠¶„ÄÅÁ§æ‰ºöÁßëÂ≠¶„ÄÅËá™ÁÑ∂ÁßëÂ≠¶Ôºâ</li>
                          <li><strong>ÁßëÂ≠¶„Çª„ÇØ„Ç∑„Éß„É≥:</strong> 1-36ÁÇπÔºà„Éá„Éº„ÇøËß£Èáà„ÄÅÁ†îÁ©∂Ë¶ÅÁ¥Ñ„ÄÅÂØæÁ´ã„Åô„ÇãË¶ñÁÇπÔºâ</li>
                          <li><strong>ÂÖ®Á±≥Âπ≥Âùá:</strong> Á¥Ñ21ÁÇπ</li>
                          <li><strong>„ÉÅ„É£„Éº„ÉàÂÜÖ„ÅÆÈªÑËâ≤„ÅÑÊ£í:</strong> ÂÖ®Á±≥Âπ≥Âùá„ÇíÁ§∫„ÅôÂü∫Ê∫ñ</li>
                        </ul>
                      </div>
                    </div>
                  </div>
                <% end %>
              </div>
            <% else %>
              <div class="no-data-message">
                <i class="fas fa-chart-bar"></i>
                <h3>„ÉÜ„Çπ„Éà„Çπ„Ç≥„Ç¢„Éá„Éº„Çø„ÅØÁèæÂú®Âà©Áî®„Åß„Åç„Åæ„Åõ„Çì</h3>
                <p>„Åì„ÅÆÂ§ßÂ≠¶„ÅÆSAT„ÉªACT„Çπ„Ç≥„Ç¢ÊÉÖÂ†±„ÅØÊ∫ñÂÇô‰∏≠„Åß„Åô„ÄÇ</p>
              </div>
            <% end %>
          </div>

          <!-- Post-Graduation Earnings Section -->
          <div class="section">
            <h2 class="section-title">ÂçíÊ•≠Âæå„ÅÆÂèéÂÖ•</h2>
            
            <% 
              # Check if any earnings data is available
              has_earnings_data = @college.earnings_6yr_median.present? || @college.earnings_10yr_median.present?
            %>
            
            <% if has_earnings_data %>
              <div class="test-scores-charts">
                <div class="chart-container">
                  <div class="chart-header">
                    <h3 class="chart-title">
                      <i class="fas fa-dollar-sign"></i>
                      ÂçíÊ•≠Âæå„ÅÆÂπ¥ÂèéÊé®Áßª
                      <span class="info-icon" title="ÂçíÊ•≠Âæå„ÅÆÂèéÂÖ•„Éá„Éº„Çø„ÅÆË©≥Á¥∞ÊÉÖÂ†±">
                        <i class="fas fa-info-circle"></i>
                      </span>
                    </h3>
                    <div class="chart-description">
                      <p>„Åì„ÅÆÂ§ßÂ≠¶„ÅÆÂçíÊ•≠Áîü„ÅÆÂπ¥Âèé‰∏≠Â§ÆÂÄ§„ÄÇ6Âπ¥Âæå„ÅØÂÖ•Â≠¶„Åã„Çâ6Âπ¥ÁµåÈÅéÊôÇÁÇπ„ÄÅ10Âπ¥Âæå„ÅØÂÖ•Â≠¶„Åã„Çâ10Âπ¥ÁµåÈÅéÊôÇÁÇπ„ÅÆÂèéÂÖ•„ÇíÁ§∫„Åó„Å¶„ÅÑ„Åæ„Åô</p>
                    </div>
                  </div>
                  <div class="chart-wrapper">
                    <canvas id="earningsChart"></canvas>
                  </div>
                  <div class="score-details">
                    <div class="score-explanation">
                      <h4>ÂèéÂÖ•„Éá„Éº„Çø„Å´„Å§„ÅÑ„Å¶</h4>
                      <ul>
                        <li><strong>6Âπ¥ÂæåÂèéÂÖ•:</strong> ÂÖ•Â≠¶„Åã„Çâ6Âπ¥Âæå„ÅÆÂπ¥Âèé‰∏≠Â§ÆÂÄ§ÔºàÂ§ö„Åè„ÅÆÂ†¥Âêà„ÄÅÂçíÊ•≠„Åã„Çâ2Âπ¥ÂæåÔºâ</li>
                        <li><strong>10Âπ¥ÂæåÂèéÂÖ•:</strong> ÂÖ•Â≠¶„Åã„Çâ10Âπ¥Âæå„ÅÆÂπ¥Âèé‰∏≠Â§ÆÂÄ§ÔºàÂ§ö„Åè„ÅÆÂ†¥Âêà„ÄÅÂçíÊ•≠„Åã„Çâ6Âπ¥ÂæåÔºâ</li>
                        <li><strong>„Éá„Éº„ÇøÂÖÉ:</strong> ÈÄ£ÈÇ¶ÊîøÂ∫ú„ÅÆÁ®éÂãô„ÉªÂ≠¶Áîü„É≠„Éº„É≥„Éá„Éº„Çø„Å´Âü∫„Å•„Åè</li>
                        <li><strong>ÂÖ®Á±≥Âπ≥ÂùáÔºàÂ≠¶Â£´Âè∑Ôºâ:</strong> 6Âπ¥Âæå Á¥Ñ$35,000„ÄÅ10Âπ¥Âæå Á¥Ñ$45,000</li>
                        <li><strong>„ÉÅ„É£„Éº„ÉàÂÜÖ„ÅÆÈªÑËâ≤„ÅÑÊ£í:</strong> ÂÖ®Á±≥Âπ≥Âùá„ÇíÁ§∫„ÅôÂü∫Ê∫ñ</li>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>
            <% else %>
              <div class="no-data-message">
                <i class="fas fa-dollar-sign"></i>
                <h3>ÂèéÂÖ•„Éá„Éº„Çø„ÅØÁèæÂú®Âà©Áî®„Åß„Åç„Åæ„Åõ„Çì</h3>
                <p>„Åì„ÅÆÂ§ßÂ≠¶„ÅÆÂçíÊ•≠ÂæåÂèéÂÖ•ÊÉÖÂ†±„ÅØÊ∫ñÂÇô‰∏≠„Åß„Åô„ÄÇ</p>
              </div>
            <% end %>
          </div>

          <!-- Financial Aid & Costs Section -->
          <div class="section">
            <h2 class="section-title">Â≠¶Ë≤ª„ÉªÁµåÊ∏àÊè¥Âä©</h2>
            
            <% 
              # Check if any financial aid data is available
              has_aid_data = @college.pell_grant_rate.present? || @college.federal_loan_rate.present? || @college.room_board_cost.present?
            %>
            
            <% if has_aid_data %>
              <div class="test-scores-charts">
                <% if @college.pell_grant_rate.present? || @college.federal_loan_rate.present? %>
                  <div class="chart-container">
                    <div class="chart-header">
                      <h3 class="chart-title">
                        <i class="fas fa-chart-pie"></i>
                        ÁµåÊ∏àÊè¥Âä©Âà©Áî®Áä∂Ê≥Å
                        <span class="info-icon" title="ÁµåÊ∏àÊè¥Âä©„ÅÆË©≥Á¥∞ÊÉÖÂ†±">
                          <i class="fas fa-info-circle"></i>
                        </span>
                      </h3>
                      <div class="chart-description">
                        <p>Â≠¶Áîü„ÅÆÁµåÊ∏àÊè¥Âä©Âà©Áî®Áéá„ÄÇPell Grant„ÅØ‰ΩéÊâÄÂæó‰∏ñÂ∏ØÂêë„Åë„ÄÅFederal Loan„ÅØÈÄ£ÈÇ¶Â≠¶Áîü„É≠„Éº„É≥„ÅÆÂà©Áî®Áéá„ÇíÁ§∫„Åó„Åæ„Åô</p>
                      </div>
                    </div>
                    <div class="chart-wrapper">
                      <canvas id="financialAidChart"></canvas>
                    </div>
                    <div class="score-details">
                      <div class="score-explanation">
                        <h4>ÁµåÊ∏àÊè¥Âä©„Å´„Å§„ÅÑ„Å¶</h4>
                        <ul>
                          <li><strong>Pell Grant:</strong> ËøîÊ∏à‰∏çË¶Å„ÅÆÈÄ£ÈÇ¶ÊîøÂ∫úÂ•®Â≠¶ÈáëÔºàÂπ¥ÂèéÁ¥Ñ$50,000‰ª•‰∏ã„ÅÆ‰∏ñÂ∏Ø„ÅåÂØæË±°Ôºâ</li>
                          <li><strong>Federal Loan:</strong> ÈÄ£ÈÇ¶Â≠¶Áîü„É≠„Éº„É≥Ôºà‰ΩéÈáëÂà©„ÅßËøîÊ∏àÊù°‰ª∂„ÅåËâØ„ÅÑÔºâ</li>
                          <li><strong>ÂÖ®Á±≥Âπ≥Âùá:</strong> Pell Grant Á¥Ñ35%„ÄÅFederal Loan Á¥Ñ50%</li>
                          <li><strong>È´ò„ÅÑÂà©Áî®Áéá:</strong> ÁµåÊ∏àÁöÑ„Å´Â§öÊßò„Å™Â≠¶Áîü„ÅåÂú®Á±ç„Åó„Å¶„ÅÑ„Çã„Åì„Å®„ÇíÁ§∫„Åô</li>
                        </ul>
                      </div>
                    </div>
                  </div>
                <% end %>
                
                <% if @college.room_board_cost.present? %>
                  <div class="chart-container">
                    <div class="chart-header">
                      <h3 class="chart-title">
                        <i class="fas fa-home"></i>
                        Âπ¥ÈñìË≤ªÁî®ÂÜÖË®≥
                        <span class="info-icon" title="Âπ¥ÈñìË≤ªÁî®„ÅÆË©≥Á¥∞ÊÉÖÂ†±">
                          <i class="fas fa-info-circle"></i>
                        </span>
                      </h3>
                      <div class="chart-description">
                        <p>Âπ¥Èñì„ÅÆ‰∏ªË¶ÅË≤ªÁî®È†ÖÁõÆ„ÄÇÊéàÊ•≠Êñô„Å®ÂØÆË≤ª„ÉªÈ£üË≤ª„ÇíÊØîËºÉ„Åó„Å¶Á∑èË≤ªÁî®„ÇíÊääÊè°„Åß„Åç„Åæ„Åô</p>
                      </div>
                    </div>
                    <div class="chart-wrapper">
                      <canvas id="costsChart"></canvas>
                    </div>
                    <div class="score-details">
                      <div class="score-explanation">
                        <h4>Ë≤ªÁî®„Å´„Å§„ÅÑ„Å¶</h4>
                        <ul>
                          <li><strong>ÊéàÊ•≠Êñô:</strong> Âπ¥Èñì„ÅÆÂ≠¶Ë≤ªÔºàÂ∑ûÁ´ãÂ§ßÂ≠¶„ÅØÂ∑ûÂ§ñÂ≠¶ÁîüÂêë„ÅëÊñôÈáë„ÇíË°®Á§∫Ôºâ</li>
                          <li><strong>ÂØÆË≤ª„ÉªÈ£üË≤ª:</strong> „Ç≠„É£„É≥„Éë„ÇπÂÜÖÂ±Ö‰Ωè„ÅÆÂπ¥ÈñìË≤ªÁî®</li>
                          <li><strong>Á∑èË≤ªÁî®:</strong> ÊéàÊ•≠Êñô + ÂØÆË≤ª„ÉªÈ£üË≤ªÔºàÊïôÊùêË≤ª„ÉªÈõëË≤ª„ÅØÂê´„Åæ„ÅöÔºâ</li>
                          <li><strong>ÂÖ®Á±≥Âπ≥Âùá:</strong> Â∑ûÁ´ãÂ§ßÂ≠¶ Á¥Ñ$25,000„ÄÅÁßÅÁ´ãÂ§ßÂ≠¶ Á¥Ñ$55,000</li>
                        </ul>
                      </div>
                    </div>
                  </div>
                <% end %>
              </div>
            <% else %>
              <div class="no-data-message">
                <i class="fas fa-dollar-sign"></i>
                <h3>Â≠¶Ë≤ª„ÉªÁµåÊ∏àÊè¥Âä©„Éá„Éº„Çø„ÅØÁèæÂú®Âà©Áî®„Åß„Åç„Åæ„Åõ„Çì</h3>
                <p>„Åì„ÅÆÂ§ßÂ≠¶„ÅÆÁµåÊ∏àÊè¥Âä©ÊÉÖÂ†±„ÅØÊ∫ñÂÇô‰∏≠„Åß„Åô„ÄÇ</p>
              </div>
            <% end %>
          </div>

          <!-- Student Support & Retention Section -->
          <div class="section">
            <h2 class="section-title">Â≠¶Áîü„Çµ„Éù„Éº„Éà„ÉªÁ∂ôÁ∂öÁéá</h2>
            
            <% 
              # Check if retention data is available
              has_retention_data = @college.retention_rate.present?
            %>
            
            <% if has_retention_data %>
              <div class="test-scores-charts">
                <div class="chart-container">
                  <div class="chart-header">
                    <h3 class="chart-title">
                      <i class="fas fa-user-graduate"></i>
                      1Âπ¥ÁîüÁ∂ôÁ∂öÁéá
                      <span class="info-icon" title="Á∂ôÁ∂öÁéá„ÅÆË©≥Á¥∞ÊÉÖÂ†±">
                        <i class="fas fa-info-circle"></i>
                      </span>
                    </h3>
                    <div class="chart-description">
                      <p>1Âπ¥Áîü„Åå2Âπ¥Áîü„Å´ÈÄ≤Á¥ö„Åô„ÇãÂâ≤Âêà„ÄÇÂ≠¶Áîü„Çµ„Éù„Éº„Éà„ÅÆË≥™„ÇÑÊ∫ÄË∂≥Â∫¶„ÇíÁ§∫„ÅôÈáçË¶Å„Å™ÊåáÊ®ô„Åß„Åô</p>
                    </div>
                  </div>
                  <div class="chart-wrapper">
                    <canvas id="retentionChart"></canvas>
                  </div>
                  <div class="score-details">
                    <div class="score-explanation">
                      <h4>Á∂ôÁ∂öÁéá„Å´„Å§„ÅÑ„Å¶</h4>
                      <ul>
                        <li><strong>Á∂ôÁ∂öÁéá:</strong> 1Âπ¥Áîü„ÅåÁøåÂπ¥„ÇÇÂú®Á±ç„Åó„Å¶„ÅÑ„ÇãÂâ≤Âêà</li>
                        <li><strong>ÂÖ®Á±≥Âπ≥Âùá:</strong> Á¥Ñ81%Ôºà4Âπ¥Âà∂Â§ßÂ≠¶Ôºâ</li>
                        <li><strong>È´ò„ÅÑÁ∂ôÁ∂öÁéá:</strong> ÂÖÖÂÆü„Åó„ÅüÂ≠¶Áîü„Çµ„Éù„Éº„Éà„ÄÅÊ∫ÄË∂≥Â∫¶„ÅÆÈ´ò„Åï„ÇíÁ§∫„Åô</li>
                        <li><strong>‰Ωé„ÅÑÁ∂ôÁ∂öÁéá:</strong> ÁµåÊ∏àÁöÑÂõ∞Èõ£„ÄÅÂ≠¶Áøí„Çµ„Éù„Éº„Éà‰∏çË∂≥Á≠â„ÅåÂéüÂõ†„ÅÆÂèØËÉΩÊÄß</li>
                        <li><strong>Âà§Êñ≠Âü∫Ê∫ñ:</strong> 80%‰ª•‰∏ä„ÅØËâØÂ•Ω„ÄÅ70%Êú™Ê∫Ä„ÅØË¶ÅÊ≥®ÊÑè</li>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>
            <% else %>
              <div class="no-data-message">
                <i class="fas fa-user-graduate"></i>
                <h3>Á∂ôÁ∂öÁéá„Éá„Éº„Çø„ÅØÁèæÂú®Âà©Áî®„Åß„Åç„Åæ„Åõ„Çì</h3>
                <p>„Åì„ÅÆÂ§ßÂ≠¶„ÅÆÂ≠¶ÁîüÁ∂ôÁ∂öÁéáÊÉÖÂ†±„ÅØÊ∫ñÂÇô‰∏≠„Åß„Åô„ÄÇ</p>
              </div>
            <% end %>
          </div>

          <!-- Major Information Section - Terms Style -->
          <div class="major-section-container">
            <%
              majors = []
              if @college.pcip_agriculture && @college.pcip_agriculture > 0
                majors << { name: "Ëæ≤Ê•≠„ÉªËæ≤Â≠¶", percentage: (@college.pcip_agriculture * 100).round(1) }
              end
              if @college.pcip_natural_resources && @college.pcip_natural_resources > 0
                majors << { name: "Â§©ÁÑ∂Ë≥áÊ∫ê„ÉªÁí∞Â¢ÉÁßëÂ≠¶", percentage: (@college.pcip_natural_resources * 100).round(1) }
              end
              if @college.pcip_communication && @college.pcip_communication > 0
                majors << { name: "„Ç≥„Éü„É•„Éã„Ç±„Éº„Ç∑„Éß„É≥Â≠¶", percentage: (@college.pcip_communication * 100).round(1) }
              end
              if @college.pcip_computer_science && @college.pcip_computer_science > 0
                majors << { name: "„Ç≥„É≥„Éî„É•„Éº„Çø„Éº„Çµ„Ç§„Ç®„É≥„Çπ", percentage: (@college.pcip_computer_science * 100).round(1) }
              end
              if @college.pcip_education && @college.pcip_education > 0
                majors << { name: "ÊïôËÇ≤Â≠¶", percentage: (@college.pcip_education * 100).round(1) }
              end
              if @college.pcip_engineering && @college.pcip_engineering > 0
                majors << { name: "Â∑•Â≠¶", percentage: (@college.pcip_engineering * 100).round(1) }
              end
              if @college.pcip_foreign_languages && @college.pcip_foreign_languages > 0
                majors << { name: "Â§ñÂõΩË™û„ÉªÊñáÂ≠¶", percentage: (@college.pcip_foreign_languages * 100).round(1) }
              end
              if @college.pcip_english && @college.pcip_english > 0
                majors << { name: "Ëã±Ë™û„ÉªÊñáÂ≠¶", percentage: (@college.pcip_english * 100).round(1) }
              end
              if @college.pcip_biology && @college.pcip_biology > 0
                majors << { name: "ÁîüÁâ©Â≠¶", percentage: (@college.pcip_biology * 100).round(1) }
              end
              if @college.pcip_mathematics && @college.pcip_mathematics > 0
                majors << { name: "Êï∞Â≠¶„ÉªÁµ±Ë®àÂ≠¶", percentage: (@college.pcip_mathematics * 100).round(1) }
              end
              if @college.pcip_psychology && @college.pcip_psychology > 0
                majors << { name: "ÂøÉÁêÜÂ≠¶", percentage: (@college.pcip_psychology * 100).round(1) }
              end
              if @college.pcip_sociology && @college.pcip_sociology > 0
                majors << { name: "Á§æ‰ºöÂ≠¶", percentage: (@college.pcip_sociology * 100).round(1) }
              end
              if @college.pcip_social_sciences && @college.pcip_social_sciences > 0
                majors << { name: "Á§æ‰ºöÁßëÂ≠¶", percentage: (@college.pcip_social_sciences * 100).round(1) }
              end
              if @college.pcip_visual_arts && @college.pcip_visual_arts > 0
                majors << { name: "Ë¶ñË¶ö„ÉªËàûÂè∞Ëä∏Ë°ì", percentage: (@college.pcip_visual_arts * 100).round(1) }
              end
              if @college.pcip_business && @college.pcip_business > 0
                majors << { name: "ÁµåÂñ∂Â≠¶", percentage: (@college.pcip_business * 100).round(1) }
              end
              if @college.pcip_health_professions && @college.pcip_health_professions > 0
                majors << { name: "ÂÅ•Â∫∑„ÉªÂåªÁôÇ", percentage: (@college.pcip_health_professions * 100).round(1) }
              end
              if @college.pcip_history && @college.pcip_history > 0
                majors << { name: "Ê≠¥Âè≤Â≠¶", percentage: (@college.pcip_history * 100).round(1) }
              end
              if @college.pcip_philosophy && @college.pcip_philosophy > 0
                majors << { name: "Âì≤Â≠¶„ÉªÂÆóÊïôÂ≠¶", percentage: (@college.pcip_philosophy * 100).round(1) }
              end
              if @college.pcip_physical_sciences && @college.pcip_physical_sciences > 0
                majors << { name: "Áâ©ÁêÜÁßëÂ≠¶", percentage: (@college.pcip_physical_sciences * 100).round(1) }
              end
              if @college.pcip_law && @college.pcip_law > 0
                majors << { name: "Ê≥ïÂ≠¶„ÉªÂàë‰∫ãÂè∏Ê≥ï", percentage: (@college.pcip_law * 100).round(1) }
              end
              majors = majors.sort_by { |m| -m[:percentage] }
            %>

            <!-- Section Header -->
            <div class="major-section-header">
              <h2>Â∞ÇÊîªÂàÜÈáéÊÉÖÂ†±</h2>
              <p>Programs of Study</p>
              <div class="major-header-divider"></div>
            </div>

            <% if majors.any? %>
              <!-- Overview Card -->
              <div class="major-card-wrapper">
                <div class="major-card">
                  <div class="major-card-number">01</div>
                  <h3>Ê¶ÇË¶Å</h3>
                  <p>
                    „Åì„ÅÆÂ§ßÂ≠¶„Åß„ÅØ<strong><%= majors.length %>„Å§„ÅÆÂ∞ÇÊîªÂàÜÈáé</strong>„ÅßÂ≠¶‰Ωç„ÇíÊéà‰∏é„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ
                    ÊúÄ„ÇÇ‰∫∫Ê∞ó„ÅÆÂàÜÈáé„ÅØ<strong><%= majors.first[:name] %></strong>Ôºà<%= majors.first[:percentage] %>%Ôºâ„Åß„Åô„ÄÇ
                  </p>
                </div>
              </div>

              <!-- Ranking Card -->
              <div class="major-card-wrapper major-card-bg">
                <div class="major-card">
                  <div class="major-card-number">02</div>
                  <h3>‰∫∫Ê∞óÂ∞ÇÊîª„É©„É≥„Ç≠„É≥„Ç∞</h3>
                  <div class="major-ranking-list">
                    <% majors.first(5).each_with_index do |major, index| %>
                      <div class="major-ranking-row">
                        <span class="major-rank"><%= index + 1 %></span>
                        <span class="major-field-name"><%= major[:name] %></span>
                        <span class="major-field-percent"><%= major[:percentage] %>%</span>
                        <div class="major-field-bar">
                          <div class="major-field-bar-fill" style="width: <%= [major[:percentage] * 2, 100].min %>%;"></div>
                        </div>
                      </div>
                    <% end %>
                  </div>
                </div>
              </div>

              <!-- All Majors Card -->
              <div class="major-card-wrapper">
                <div class="major-card">
                  <div class="major-card-number">03</div>
                  <h3>ÂÖ®Â∞ÇÊîªÂàÜÈáé‰∏ÄË¶ß</h3>
                  <div class="major-tags-grid">
                    <% majors.each do |major| %>
                      <span class="major-tag"><%= major[:name] %> (<%= major[:percentage] %>%)</span>
                    <% end %>
                  </div>
                </div>
              </div>

              <!-- Note Card -->
              <div class="major-card-wrapper major-card-bg">
                <div class="major-card major-note-card">
                  <p>
                    <i class="fas fa-info-circle"></i>
                    „Éá„Éº„Çø„ÅØÁ±≥ÂõΩÊïôËÇ≤ÁúÅ College Scorecard Êèê‰æõ„ÄÇÊéàÊ•≠„ÅØËã±Ë™û„ÅßÂÆüÊñΩ„Åï„Çå„Åæ„Åô„ÄÇ
                  </p>
                </div>
              </div>
            <% else %>
              <!-- No Data Card -->
              <div class="major-card-wrapper">
                <div class="major-card major-no-data">
                  <i class="fas fa-graduation-cap"></i>
                  <h3>Â∞ÇÊîªÂàÜÈáé„Éá„Éº„ÇøÊ∫ñÂÇô‰∏≠</h3>
                  <p>Ë©≥Á¥∞„Å™Â∞ÇÊîªÂàÜÈáé„Éá„Éº„Çø„ÅØËøëÊó•ËøΩÂä†‰∫àÂÆö„Åß„Åô„ÄÇ</p>
                </div>
              </div>
            <% end %>
          </div>

          <!-- Social Media Section -->
          <div class="social-section">
            <h3 class="social-title">„ÇΩ„Éº„Ç∑„É£„É´„É°„Éá„Ç£„Ç¢</h3>
            <div class="social-links">
              <a href="https://www.instagram.com/" target="_blank" class="social-link">
                <i class="fab fa-instagram"></i>
              </a>
              <a href="https://www.facebook.com/" target="_blank" class="social-link">
                <i class="fab fa-facebook"></i>
              </a>
              <a href="https://twitter.com/" target="_blank" class="social-link">
                <i class="fab fa-twitter"></i>
              </a>
              <a href="https://www.youtube.com/" target="_blank" class="social-link">
                <i class="fab fa-youtube"></i>
              </a>
              <a href="https://www.linkedin.com/" target="_blank" class="social-link">
                <i class="fab fa-linkedin"></i>
              </a>
            </div>
          </div>

          <!-- Back Button -->
          <% 
            back_url = session[:search_results_url] || results_path
            # Clear the session after using it to prevent stale URLs
            session.delete(:search_results_url) if session[:search_results_url]
          %>
          <%= link_to back_url, class: "back-button" do %>
            <i class="fas fa-arrow-left"></i>
            Ê§úÁ¥¢ÁµêÊûú„Å´Êàª„Çã
          <% end %>

        </div>
      </div>
    </div>

    <!-- Èñ¢ÈÄ£Â§ßÂ≠¶„Çª„ÇØ„Ç∑„Éß„É≥ -->
    <% if @related_colleges.present? %>
    <section class="related-colleges-section">
      <div class="container">
        <h2 class="related-section-title">
          <i class="fas fa-university"></i>
          <%= @college.state %>Â∑û„ÅÆ‰ªñ„ÅÆÂ§ßÂ≠¶
        </h2>
        <div class="related-colleges-grid">
          <% @related_colleges.each do |related| %>
            <a href="<%= conditions_path(related) %>" class="related-college-card">
              <div class="related-college-name">
                <% if related.name_ja.present? %>
                  <span class="related-name-ja"><%= related.name_ja %></span>
                  <span class="related-name-en"><%= related.college %></span>
                <% else %>
                  <span class="related-name-en-only"><%= related.college %></span>
                <% end %>
              </div>
              <div class="related-college-info">
                <% if related.tuition.present? %>
                  <span class="related-info-item">
                    <i class="fas fa-dollar-sign"></i>
                    <%= number_to_currency(related.tuition, precision: 0) %>
                  </span>
                <% end %>
                <% if related.acceptance_rate.present? %>
                  <span class="related-info-item">
                    <i class="fas fa-percentage"></i>
                    ÂêàÊ†ºÁéá <%= (related.acceptance_rate * 100).round(1) %>%
                  </span>
                <% end %>
              </div>
            </a>
          <% end %>
        </div>
      </div>
    </section>
    <% end %>
  </div>

  <!-- „É≠„Ç∞„Ç§„É≥Ë™òÂ∞é„É¢„Éº„ÉÄ„É´ -->
  <div id="loginModal" class="login-modal-overlay" style="display: none;">
    <div class="login-modal-content">
      <div class="login-modal-header">
        <h3>„É≠„Ç∞„Ç§„É≥„ÅåÂøÖË¶Å„Åß„Åô</h3>
        <button class="login-modal-close" onclick="hideLoginModal()">&times;</button>
      </div>
      <div class="login-modal-body">
        <p id="modalMessage" class="login-modal-text">„ÅäÊ∞ó„Å´ÂÖ•„ÇäÊ©üËÉΩ„ÇíÂà©Áî®„Åô„Çã„Å´„ÅØ„ÄÅ„É≠„Ç∞„Ç§„É≥„Åæ„Åü„ÅØÊñ∞Ë¶èÁôªÈå≤„ÅåÂøÖË¶Å„Åß„Åô„ÄÇ</p>
        <div class="login-modal-actions">
          <a href="/login" class="login-modal-btn login-btn-primary">
            <i class="fas fa-sign-in-alt"></i>
            „É≠„Ç∞„Ç§„É≥
          </a>
          <a href="/register" class="login-modal-btn login-btn-secondary">
            <i class="fas fa-user-plus"></i>
            Êñ∞Ë¶èÁôªÈå≤
          </a>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const favoriteBtn = document.getElementById('favoriteBtn');
      const loginPromptBtn = document.getElementById('loginPromptBtn');
      const compareBtn = document.getElementById('compareBtn');
      
      if (favoriteBtn) {
        favoriteBtn.addEventListener('click', function() {
          const conditionId = this.getAttribute('data-condition-id');
          const isFavorited = this.classList.contains('favorited');
          const url = '/favorites';
          const method = isFavorited ? 'DELETE' : 'POST';
          
          // „Éú„Çø„É≥„ÇíÁÑ°ÂäπÂåñ
          this.disabled = true;
          
          fetch(url, {
            method: method,
            headers: {
              'Content-Type': 'application/json',
              'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
            },
            body: JSON.stringify({
              condition_id: conditionId
            })
          })
          .then(response => response.json())
          .then(data => {
            if (data.status === 'success') {
              // „Éú„Çø„É≥„ÅÆÁä∂ÊÖã„ÇíÊõ¥Êñ∞
              if (data.favorited) {
                this.classList.add('favorited');
                this.querySelector('.favorite-text').textContent = '„ÅäÊ∞ó„Å´ÂÖ•„ÇäÊ∏à„Åø';
              } else {
                this.classList.remove('favorited');
                this.querySelector('.favorite-text').textContent = '„ÅäÊ∞ó„Å´ÂÖ•„Çä„Å´ËøΩÂä†';
              }
              
              // ÊàêÂäü„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫ÔºàÂâäÈô§Ôºâ
              // showNotification(data.message, 'success');
            } else {
              showNotification(data.message, 'error');
            }
          })
          .catch(error => {
            console.error('Error:', error);
            showNotification('„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü', 'error');
          })
          .finally(() => {
            // „Éú„Çø„É≥„ÇíÂÜçÊúâÂäπÂåñ
            this.disabled = false;
          });
        });
      }
      
      // ÈÄöÁü•„É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫
      function showNotification(message, type) {
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.textContent = message;
        notification.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          padding: 12px 24px;
          border-radius: 8px;
          color: white;
          font-weight: 600;
          z-index: 10000;
          font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Helvetica Neue", Arial, sans-serif;
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
          transition: all 0.3s ease;
          ${type === 'success' ? 'background: #10b981;' : 'background: #ef4444;'}
        `;
        
        document.body.appendChild(notification);
        
        // „Éï„Çß„Éº„Éâ„Ç§„É≥
        setTimeout(() => {
          notification.style.opacity = '1';
          notification.style.transform = 'translateY(0)';
        }, 100);
        
        // 3ÁßíÂæå„Å´ÂâäÈô§
        setTimeout(() => {
          notification.style.opacity = '0';
          notification.style.transform = 'translateY(-20px)';
          setTimeout(() => {
            if (notification.parentNode) {
              notification.parentNode.removeChild(notification);
            }
          }, 300);
        }, 3000);
      }
      
      // „É≠„Ç∞„Ç¢„Ç¶„Éà‰∏≠„ÅÆ„ÅäÊ∞ó„Å´ÂÖ•„Çä„Éú„Çø„É≥„ÇØ„É™„ÉÉ„ÇØÂá¶ÁêÜ
      if (loginPromptBtn) {
        loginPromptBtn.addEventListener('click', function() {
          showLoginModal('favorite');
        });
      }
      
      // ÊØîËºÉ„Éú„Çø„É≥„ÇØ„É™„ÉÉ„ÇØÂá¶ÁêÜ
      if (compareBtn) {
        compareBtn.addEventListener('click', function() {
          const conditionId = this.getAttribute('data-condition-id');
          const isLoggedIn = <%= logged_in? ? 'true' : 'false' %>;
          
          if (!isLoggedIn) {
            showLoginModal('compare');
            return;
          }
          
          const isAdded = this.classList.contains('added');
          const url = '/compare';
          const method = isAdded ? 'DELETE' : 'POST';
          
          // „Éú„Çø„É≥„ÇíÁÑ°ÂäπÂåñ
          this.disabled = true;
          
          fetch(url, {
            method: method,
            headers: {
              'Content-Type': 'application/json',
              'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
            },
            body: JSON.stringify({
              condition_id: conditionId
            })
          })
          .then(response => response.json())
          .then(data => {
            if (data.status === 'success') {
              // „Éú„Çø„É≥„ÅÆÁä∂ÊÖã„ÇíÊõ¥Êñ∞
              if (method === 'POST') {
                this.classList.add('added');
                this.querySelector('.compare-text').textContent = 'ËøΩÂä†Ê∏à„Åø';
              } else {
                this.classList.remove('added');
                this.querySelector('.compare-text').textContent = 'ÊØîËºÉ„Å´ËøΩÂä†';
              }
              
              // ÊàêÂäü„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫ÔºàÂâäÈô§Ôºâ
              // showNotification(data.message, 'success');
              
              // „Éò„ÉÉ„ÉÄ„Éº„ÅÆÊØîËºÉÊï∞„ÇíÊõ¥Êñ∞ÔºàÂæå„ÅßÂÆüË£ÖÔºâ
              updateCompareCount(data.count);
            } else {
              showNotification(data.message, 'error');
            }
          })
          .catch(error => {
            console.error('Error:', error);
            showNotification('„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü', 'error');
          })
          .finally(() => {
            // „Éú„Çø„É≥„ÇíÂÜçÊúâÂäπÂåñ
            this.disabled = false;
          });
        });
        
        // „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇ„Å´ÊØîËºÉ„É™„Çπ„Éà„ÅÆÁä∂ÊÖã„ÇíÁ¢∫Ë™ç
        checkCompareStatus(compareBtn);
      }

      // Charts will be initialized by the separate Chart.js initialization code
    });
    
    // „É≠„Ç∞„Ç§„É≥„É¢„Éº„ÉÄ„É´Ë°®Á§∫
    function showLoginModal(type = 'favorite') {
      const modal = document.getElementById('loginModal');
      const message = document.getElementById('modalMessage');

      if (type === 'compare') {
        message.textContent = 'ÊØîËºÉÊ©üËÉΩ„ÇíÂà©Áî®„Åô„Çã„Å´„ÅØ„ÄÅ„É≠„Ç∞„Ç§„É≥„Åæ„Åü„ÅØÊñ∞Ë¶èÁôªÈå≤„ÅåÂøÖË¶Å„Åß„Åô„ÄÇ';
      } else {
        message.textContent = '„ÅäÊ∞ó„Å´ÂÖ•„ÇäÊ©üËÉΩ„ÇíÂà©Áî®„Åô„Çã„Å´„ÅØ„ÄÅ„É≠„Ç∞„Ç§„É≥„Åæ„Åü„ÅØÊñ∞Ë¶èÁôªÈå≤„ÅåÂøÖË¶Å„Åß„Åô„ÄÇ';
      }

      modal.style.display = 'flex';
    }
    
    // „É≠„Ç∞„Ç§„É≥„É¢„Éº„ÉÄ„É´ÈùûË°®Á§∫
    function hideLoginModal() {
      document.getElementById('loginModal').style.display = 'none';
    }
    
    // „É¢„Éº„ÉÄ„É´Â§ñ„ÇØ„É™„ÉÉ„ÇØ„ÅßÈñâ„Åò„Çã
    document.getElementById('loginModal').addEventListener('click', function(e) {
      if (e.target === this) {
        hideLoginModal();
      }
    });
    
    // ÊØîËºÉ„É™„Çπ„Éà„ÅÆÁä∂ÊÖã„Çí„ÉÅ„Çß„ÉÉ„ÇØ
    function checkCompareStatus(compareBtn) {
      const conditionId = compareBtn.getAttribute('data-condition-id');
      
      fetch('/compare', {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json'
        }
      })
      .then(response => response.text())
      .then(html => {
        // „Çª„ÉÉ„Ç∑„Éß„É≥„Åã„ÇâÊØîËºÉ„É™„Çπ„Éà„ÇíÁ¢∫Ë™çÔºàÁ∞°ÊòìÂÆüË£ÖÔºâ
        // ÂÆüÈöõ„Å´„ÅØÂ∞ÇÁî®„ÅÆAPI„Ç®„É≥„Éâ„Éù„Ç§„É≥„Éà„Çí‰ΩúÊàê„Åô„Çã„Åì„Å®„ÇíÊé®Â•®
      })
      .catch(error => {
        console.error('Error checking compare status:', error);
      });
    }
    
    // ÊØîËºÉÊï∞„ÇíÊõ¥Êñ∞Ôºà„Éò„ÉÉ„ÉÄ„Éº„Å´Ë°®Á§∫Áî®Ôºâ
    function updateCompareCount(count) {
      // Âæå„Åß„Éò„ÉÉ„ÉÄ„Éº„Å´ÊØîËºÉÊï∞Ë°®Á§∫„ÇíÂÆüË£Ö‰∫àÂÆö
      console.log('Compare count:', count);
    }

    // Helper function to get ACT percentile approximation
    function getACTPercentile(score) {
      const percentiles = {
        36: 99, 35: 99, 34: 99, 33: 98, 32: 97,
        31: 95, 30: 93, 29: 91, 28: 88, 27: 85,
        26: 82, 25: 79, 24: 76, 23: 73, 22: 69,
        21: 65, 20: 61, 19: 57, 18: 53, 17: 49,
        16: 45, 15: 40, 14: 36, 13: 32, 12: 28,
        11: 24, 10: 20, 9: 16, 8: 13, 7: 10,
        6: 7, 5: 5, 4: 3, 3: 2, 2: 1, 1: 1
      };
      return percentiles[score] || 0;
    }

    // Demographics Charts
    function initializeDemographicsCharts() {
      <% if has_ethnicity_data %>
        // Prepare ethnicity data
        const ethnicityData = {
          labels: [],
          data: [],
          colors: []
        };

        <% if @college.percent_white.present? && @college.percent_white > 0 %>
          ethnicityData.labels.push('ÁôΩ‰∫∫');
          ethnicityData.data.push(<%= (@college.percent_white * 100).round(1) %>);
          ethnicityData.colors.push('#2C5282');
        <% end %>

        <% if @college.percent_black.present? && @college.percent_black > 0 %>
          ethnicityData.labels.push('Èªí‰∫∫');
          ethnicityData.data.push(<%= (@college.percent_black * 100).round(1) %>);
          ethnicityData.colors.push('#4A5568');
        <% end %>

        <% if @college.percent_hispanic.present? && @college.percent_hispanic > 0 %>
          ethnicityData.labels.push('„Éí„Çπ„Éë„Éã„ÉÉ„ÇØÁ≥ª');
          ethnicityData.data.push(<%= (@college.percent_hispanic * 100).round(1) %>);
          ethnicityData.colors.push('#2C7A7B');
        <% end %>

        <% if @college.percent_asian.present? && @college.percent_asian > 0 %>
          ethnicityData.labels.push('„Ç¢„Ç∏„Ç¢Á≥ª');
          ethnicityData.data.push(<%= (@college.percent_asian * 100).round(1) %>);
          ethnicityData.colors.push('#9C8B7A');
        <% end %>

        <% if @college.percent_non_resident_alien.present? && @college.percent_non_resident_alien > 0 %>
          ethnicityData.labels.push('ÁïôÂ≠¶Áîü');
          ethnicityData.data.push(<%= (@college.percent_non_resident_alien * 100).round(1) %>);
          ethnicityData.colors.push('#f0b13d');
        <% end %>

        // Create ethnicity chart
        if (ethnicityData.labels.length > 0) {
          const ethnicityCtx = document.getElementById('ethnicityChart');
          if (ethnicityCtx) {
            new Chart(ethnicityCtx, {
              type: 'pie',
              data: {
                labels: ethnicityData.labels,
                datasets: [{
                  data: ethnicityData.data,
                  backgroundColor: ethnicityData.colors,
                  borderColor: '#ffffff',
                  borderWidth: 3,
                  hoverBorderWidth: 4,
                  hoverOffset: 8
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: {
                    position: 'bottom',
                    labels: {
                      padding: 20,
                      fontSize: 12,
                      fontFamily: 'Inter, sans-serif',
                      fontWeight: '500',
                      color: '#4a5568',
                      usePointStyle: true,
                      pointStyle: 'circle'
                    }
                  },
                  tooltip: {
                    backgroundColor: 'rgba(45, 55, 72, 0.95)',
                    titleColor: '#ffffff',
                    bodyColor: '#ffffff',
                    borderColor: '#f0b13d',
                    borderWidth: 1,
                    cornerRadius: 8,
                    displayColors: true,
                    callbacks: {
                      label: function(context) {
                        return context.label + ': ' + context.parsed + '%';
                      }
                    }
                  }
                },
                animation: {
                  animateScale: true,
                  animateRotate: true,
                  duration: 1000
                },
                layout: {
                  padding: 20
                }
              }
            });
          }
        }
      <% end %>

      <% if has_gender_data %>
        // Prepare gender data
        const genderData = {
          labels: [],
          data: [],
          colors: []
        };

        <% if @college.percent_men.present? && @college.percent_men > 0 %>
          genderData.labels.push('Áî∑ÊÄß');
          genderData.data.push(<%= (@college.percent_men * 100).round(1) %>);
          genderData.colors.push('#2C5282');
        <% end %>

        <% if @college.percent_women.present? && @college.percent_women > 0 %>
          genderData.labels.push('Â•≥ÊÄß');
          genderData.data.push(<%= (@college.percent_women * 100).round(1) %>);
          genderData.colors.push('#2C7A7B');
        <% end %>

        // Create gender chart
        if (genderData.labels.length > 0) {
          const genderCtx = document.getElementById('genderChart');
          if (genderCtx) {
            new Chart(genderCtx, {
              type: 'pie',
              data: {
                labels: genderData.labels,
                datasets: [{
                  data: genderData.data,
                  backgroundColor: genderData.colors,
                  borderColor: '#ffffff',
                  borderWidth: 3,
                  hoverBorderWidth: 4,
                  hoverOffset: 8
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: {
                    position: 'bottom',
                    labels: {
                      padding: 20,
                      fontSize: 12,
                      fontFamily: 'Inter, sans-serif',
                      fontWeight: '500',
                      color: '#4a5568',
                      usePointStyle: true,
                      pointStyle: 'circle'
                    }
                  },
                  tooltip: {
                    backgroundColor: 'rgba(45, 55, 72, 0.95)',
                    titleColor: '#ffffff',
                    bodyColor: '#ffffff',
                    borderColor: '#f0b13d',
                    borderWidth: 1,
                    cornerRadius: 8,
                    displayColors: true,
                    callbacks: {
                      label: function(context) {
                        return context.label + ': ' + context.parsed + '%';
                      }
                    }
                  }
                },
                animation: {
                  animateScale: true,
                  animateRotate: true,
                  duration: 1000
                },
                layout: {
                  padding: 20
                }
              }
            });
          }
        }
      <% end %>

      // Test Scores Charts
      <% if has_sat_data %>
        const satData = {
          labels: [],
          data: []
        };

        <% if @college.sat_math_25.present? && @college.sat_math_75.present? %>
          satData.labels.push('Êï∞Â≠¶');
          satData.data.push([<%= @college.sat_math_25 %>, <%= @college.sat_math_75 %>]);
        <% end %>

        <% if @college.sat_reading_25.present? && @college.sat_reading_75.present? %>
          satData.labels.push('Ë™≠Ëß£');
          satData.data.push([<%= @college.sat_reading_25 %>, <%= @college.sat_reading_75 %>]);
        <% end %>

        if (satData.labels.length > 0) {
          const satCtx = document.getElementById('satChart');
          if (satCtx) {
            // SAT national averages (Math: ~520, Reading: ~530)
            const satAverages = {
              'Êï∞Â≠¶': 520,
              'Ë™≠Ëß£': 530
            };

            new Chart(satCtx, {
              type: 'bar',
              data: {
                labels: satData.labels,
                datasets: [{
                  label: '25th percentile',
                  data: satData.data.map(range => range[0]),
                  backgroundColor: 'rgba(44, 82, 130, 0.8)',
                  borderColor: 'rgba(44, 82, 130, 1)',
                  borderWidth: 2
                }, {
                  label: '75th percentile',
                  data: satData.data.map(range => range[1]),
                  backgroundColor: 'rgba(74, 85, 104, 0.8)',
                  borderColor: 'rgba(74, 85, 104, 1)',
                  borderWidth: 2
                }, {
                  label: 'ÂÖ®Á±≥Âπ≥Âùá',
                  data: satData.labels.map(label => satAverages[label]),
                  backgroundColor: 'rgba(240, 177, 61, 0.7)',
                  borderColor: 'rgba(240, 177, 61, 1)',
                  borderWidth: 2,
                  type: 'bar'
                }]
              },
              options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: {
                    position: 'top',
                    labels: {
                      padding: 20,
                      fontSize: 12,
                      fontFamily: 'Inter, sans-serif',
                      fontWeight: '500',
                      color: '#4a5568'
                    }
                  },
                  datalabels: {
                    display: true,
                    anchor: 'end',
                    align: 'right',
                    color: '#2d3748',
                    font: {
                      family: 'Inter, sans-serif',
                      weight: '600',
                      size: 12
                    },
                    formatter: function(value, context) {
                      return value + ' ÁÇπ';
                    },
                    offset: 4
                  },
                  tooltip: {
                    backgroundColor: 'rgba(45, 55, 72, 0.95)',
                    titleColor: '#ffffff',
                    bodyColor: '#ffffff',
                    borderColor: '#f0b13d',
                    borderWidth: 1,
                    cornerRadius: 8,
                    padding: 12,
                    callbacks: {
                      title: function(context) {
                        return 'SAT ' + context[0].label + ' „Çª„ÇØ„Ç∑„Éß„É≥';
                      },
                      label: function(context) {
                        const score = context.parsed.x;
                        const percentile = context.dataset.label;
                        let interpretation = '';
                        let comparison = '';
                        
                        if (context.label === 'Êï∞Â≠¶') {
                          const average = 520;
                          const diff = score - average;
                          comparison = diff > 0 ? `ÂÖ®Á±≥Âπ≥Âùá„Çà„Çä${diff}ÁÇπÈ´ò„ÅÑ` : diff < 0 ? `ÂÖ®Á±≥Âπ≥Âùá„Çà„Çä${Math.abs(diff)}ÁÇπ‰Ωé„ÅÑ` : 'ÂÖ®Á±≥Âπ≥Âùá„Å®Âêå„Åò';
                          
                          if (score >= 700) interpretation = 'ÈùûÂ∏∏„Å´È´ò„ÅÑÔºàÈõ£Èñ¢Â§ßÂ≠¶„É¨„Éô„É´Ôºâ';
                          else if (score >= 600) interpretation = 'È´ò„ÅÑÔºà‰∏≠‰∏ä‰ΩçÂ§ßÂ≠¶„É¨„Éô„É´Ôºâ';
                          else if (score >= 500) interpretation = 'Âπ≥ÂùáÁöÑ';
                          else interpretation = 'Âπ≥Âùá‰ª•‰∏ã';
                        } else if (context.label === 'Ë™≠Ëß£') {
                          const average = 530;
                          const diff = score - average;
                          comparison = diff > 0 ? `ÂÖ®Á±≥Âπ≥Âùá„Çà„Çä${diff}ÁÇπÈ´ò„ÅÑ` : diff < 0 ? `ÂÖ®Á±≥Âπ≥Âùá„Çà„Çä${Math.abs(diff)}ÁÇπ‰Ωé„ÅÑ` : 'ÂÖ®Á±≥Âπ≥Âùá„Å®Âêå„Åò';
                          
                          if (score >= 700) interpretation = 'ÈùûÂ∏∏„Å´È´ò„ÅÑÔºàÈõ£Èñ¢Â§ßÂ≠¶„É¨„Éô„É´Ôºâ';
                          else if (score >= 600) interpretation = 'È´ò„ÅÑÔºà‰∏≠‰∏ä‰ΩçÂ§ßÂ≠¶„É¨„Éô„É´Ôºâ';
                          else if (score >= 500) interpretation = 'Âπ≥ÂùáÁöÑ';
                          else interpretation = 'Âπ≥Âùá‰ª•‰∏ã';
                        }
                        
                        return [
                          percentile + ': ' + score + ' ÁÇπ',
                          'Ë©ï‰æ°: ' + interpretation,
                          comparison
                        ];
                      },
                      footer: function(context) {
                        return ['', '„Åì„ÅÆ„Çπ„Ç≥„Ç¢ÁØÑÂõ≤ÂÜÖ„Å´ÂÖ•Â≠¶ËÄÖ„ÅÆ50%„ÅåÂê´„Åæ„Çå„Åæ„Åô'];
                      }
                    }
                  }
                },
                scales: {
                  x: {
                    beginAtZero: true,
                    max: 800,
                    grid: {
                      color: 'rgba(0, 0, 0, 0.1)'
                    },
                    ticks: {
                      color: '#4a5568',
                      font: {
                        family: 'Inter, sans-serif'
                      }
                    }
                  },
                  y: {
                    grid: {
                      color: 'rgba(0, 0, 0, 0.1)'
                    },
                    ticks: {
                      color: '#4a5568',
                      font: {
                        family: 'Inter, sans-serif',
                        weight: '500'
                      }
                    }
                  }
                },
                animation: {
                  duration: 1000,
                  easing: 'easeOutCubic'
                },
                layout: {
                  padding: 20
                }
              }
            });
          }
        }
      <% end %>

      <% if has_act_data %>
        const actData = {
          labels: ['ACTÁ∑èÂêà'],
          data: []
        };

        <% if @college.act_composite_25.present? && @college.act_composite_75.present? %>
          actData.data.push([<%= @college.act_composite_25 %>, <%= @college.act_composite_75 %>]);
        <% end %>

        if (actData.data.length > 0) {
          const actCtx = document.getElementById('actChart');
          if (actCtx) {
            // ACT national average (~21)
            const actAverage = 21;

            new Chart(actCtx, {
              type: 'bar',
              data: {
                labels: actData.labels,
                datasets: [{
                  label: '25th percentile',
                  data: actData.data.map(range => range[0]),
                  backgroundColor: 'rgba(44, 82, 130, 0.8)',
                  borderColor: 'rgba(44, 82, 130, 1)',
                  borderWidth: 2
                }, {
                  label: '75th percentile',
                  data: actData.data.map(range => range[1]),
                  backgroundColor: 'rgba(74, 85, 104, 0.8)',
                  borderColor: 'rgba(74, 85, 104, 1)',
                  borderWidth: 2
                }, {
                  label: 'ÂÖ®Á±≥Âπ≥Âùá',
                  data: [actAverage],
                  backgroundColor: 'rgba(240, 177, 61, 0.7)',
                  borderColor: 'rgba(240, 177, 61, 1)',
                  borderWidth: 2,
                  type: 'bar'
                }]
              },
              options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: {
                    position: 'top',
                    labels: {
                      padding: 20,
                      fontSize: 12,
                      fontFamily: 'Inter, sans-serif',
                      fontWeight: '500',
                      color: '#4a5568'
                    }
                  },
                  datalabels: {
                    display: true,
                    anchor: 'end',
                    align: 'right',
                    color: '#2d3748',
                    font: {
                      family: 'Inter, sans-serif',
                      weight: '600',
                      size: 12
                    },
                    formatter: function(value, context) {
                      return value + ' ÁÇπ';
                    },
                    offset: 4
                  },
                  tooltip: {
                    backgroundColor: 'rgba(45, 55, 72, 0.95)',
                    titleColor: '#ffffff',
                    bodyColor: '#ffffff',
                    borderColor: '#f0b13d',
                    borderWidth: 1,
                    cornerRadius: 8,
                    padding: 12,
                    callbacks: {
                      title: function(context) {
                        return 'ACT Á∑èÂêà„Çπ„Ç≥„Ç¢';
                      },
                      label: function(context) {
                        const score = context.parsed.x;
                        const percentile = context.dataset.label;
                        let interpretation = '';
                        
                        // ACT average comparison
                        const average = 21;
                        const diff = score - average;
                        const comparison = diff > 0 ? `ÂÖ®Á±≥Âπ≥Âùá„Çà„Çä${diff}ÁÇπÈ´ò„ÅÑ` : diff < 0 ? `ÂÖ®Á±≥Âπ≥Âùá„Çà„Çä${Math.abs(diff)}ÁÇπ‰Ωé„ÅÑ` : 'ÂÖ®Á±≥Âπ≥Âùá„Å®Âêå„Åò';
                        
                        if (score >= 30) interpretation = 'ÈùûÂ∏∏„Å´È´ò„ÅÑÔºàÈõ£Èñ¢Â§ßÂ≠¶„É¨„Éô„É´Ôºâ';
                        else if (score >= 24) interpretation = 'È´ò„ÅÑÔºà‰∏≠‰∏ä‰ΩçÂ§ßÂ≠¶„É¨„Éô„É´Ôºâ';
                        else if (score >= 20) interpretation = 'Âπ≥ÂùáÁöÑ';
                        else interpretation = 'Âπ≥Âùá‰ª•‰∏ã';
                        
                        return [
                          percentile + ': ' + score + ' ÁÇπ',
                          'Ë©ï‰æ°: ' + interpretation,
                          comparison,
                          'ÂÖ®Á±≥„Åß„ÅÆÈ†Ü‰Ωç: Á¥Ñ' + getACTPercentile(score) + '%ile'
                        ];
                      },
                      footer: function(context) {
                        return ['', '„Åì„ÅÆ„Çπ„Ç≥„Ç¢ÁØÑÂõ≤ÂÜÖ„Å´ÂÖ•Â≠¶ËÄÖ„ÅÆ50%„ÅåÂê´„Åæ„Çå„Åæ„Åô'];
                      }
                    }
                  }
                },
                scales: {
                  x: {
                    beginAtZero: true,
                    max: 36,
                    grid: {
                      color: 'rgba(0, 0, 0, 0.1)'
                    },
                    ticks: {
                      color: '#4a5568',
                      font: {
                        family: 'Inter, sans-serif'
                      }
                    }
                  },
                  y: {
                    grid: {
                      color: 'rgba(0, 0, 0, 0.1)'
                    },
                    ticks: {
                      color: '#4a5568',
                      font: {
                        family: 'Inter, sans-serif',
                        weight: '500'
                      }
                    }
                  }
                },
                animation: {
                  duration: 1000,
                  easing: 'easeOutCubic'
                },
                layout: {
                  padding: 20
                }
              }
            });
          }
        }
      <% end %>

      // Earnings Chart
      <% if has_earnings_data %>
        const earningsData = {
          labels: [],
          data: []
        };

        <% if @college.earnings_6yr_median.present? %>
          earningsData.labels.push('6Âπ¥Âæå');
          earningsData.data.push(<%= @college.earnings_6yr_median %>);
        <% end %>

        <% if @college.earnings_10yr_median.present? %>
          earningsData.labels.push('10Âπ¥Âæå');
          earningsData.data.push(<%= @college.earnings_10yr_median %>);
        <% end %>

        if (earningsData.labels.length > 0) {
          const earningsCtx = document.getElementById('earningsChart');
          if (earningsCtx) {
            // US national averages for bachelor's degree holders
            const nationalAverages = {
              '6Âπ¥Âæå': 35000,
              '10Âπ¥Âæå': 45000
            };

            new Chart(earningsCtx, {
              type: 'bar',
              data: {
                labels: earningsData.labels,
                datasets: [{
                  label: '„Åì„ÅÆÂ§ßÂ≠¶„ÅÆÂçíÊ•≠Áîü',
                  data: earningsData.data,
                  backgroundColor: 'rgba(44, 122, 123, 0.8)',
                  borderColor: 'rgba(44, 122, 123, 1)',
                  borderWidth: 2
                }, {
                  label: 'ÂÖ®Á±≥Âπ≥Âùá',
                  data: earningsData.labels.map(label => nationalAverages[label]),
                  backgroundColor: 'rgba(240, 177, 61, 0.7)',
                  borderColor: 'rgba(240, 177, 61, 1)',
                  borderWidth: 2,
                  type: 'bar'
                }]
              },
              options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: {
                    position: 'top',
                    labels: {
                      padding: 20,
                      fontSize: 12,
                      fontFamily: 'Inter, sans-serif',
                      fontWeight: '500',
                      color: '#4a5568'
                    }
                  },
                  datalabels: {
                    display: true,
                    anchor: 'end',
                    align: 'right',
                    color: '#2d3748',
                    font: {
                      family: 'Inter, sans-serif',
                      weight: '600',
                      size: 12
                    },
                    formatter: function(value, context) {
                      return '$' + (value / 1000).toFixed(0) + 'K';
                    },
                    offset: 4
                  },
                  tooltip: {
                    backgroundColor: 'rgba(45, 55, 72, 0.95)',
                    titleColor: '#ffffff',
                    bodyColor: '#ffffff',
                    borderColor: '#f0b13d',
                    borderWidth: 1,
                    cornerRadius: 8,
                    padding: 12,
                    callbacks: {
                      title: function(context) {
                        return 'ÂçíÊ•≠' + context[0].label + '„ÅÆÂπ¥Âèé';
                      },
                      label: function(context) {
                        const earnings = context.parsed.x;
                        const dataset = context.dataset.label;
                        
                        // Comparison with national average
                        let comparison = '';
                        if (dataset === '„Åì„ÅÆÂ§ßÂ≠¶„ÅÆÂçíÊ•≠Áîü') {
                          const avgKey = context.label;
                          const average = nationalAverages[avgKey];
                          const diff = earnings - average;
                          comparison = diff > 0 ? `ÂÖ®Á±≥Âπ≥Âùá„Çà„Çä$${diff.toLocaleString()}È´ò„ÅÑ` : 
                                     diff < 0 ? `ÂÖ®Á±≥Âπ≥Âùá„Çà„Çä$${Math.abs(diff).toLocaleString()}‰Ωé„ÅÑ` : 
                                     'ÂÖ®Á±≥Âπ≥Âùá„Å®Âêå„Åò';
                        }
                        
                        return [
                          dataset + ': $' + earnings.toLocaleString(),
                          comparison
                        ].filter(Boolean);
                      },
                      footer: function(context) {
                        return ['', 'Âπ¥Âèé‰∏≠Â§ÆÂÄ§ÔºàÁ®éËæº„ÅøÔºâ'];
                      }
                    }
                  }
                },
                scales: {
                  x: {
                    beginAtZero: true,
                    grid: {
                      color: 'rgba(0, 0, 0, 0.1)'
                    },
                    ticks: {
                      color: '#4a5568',
                      font: {
                        family: 'Inter, sans-serif'
                      },
                      callback: function(value) {
                        return '$' + (value / 1000) + 'K';
                      }
                    }
                  },
                  y: {
                    grid: {
                      color: 'rgba(0, 0, 0, 0.1)'
                    },
                    ticks: {
                      color: '#4a5568',
                      font: {
                        family: 'Inter, sans-serif',
                        weight: '500'
                      }
                    }
                  }
                },
                animation: {
                  duration: 1000,
                  easing: 'easeOutCubic'
                },
                layout: {
                  padding: 20
                }
              }
            });
          }
        }
      <% end %>

      // Financial Aid Chart
      <% if has_aid_data && (@college.pell_grant_rate.present? || @college.federal_loan_rate.present?) %>
        const aidData = {
          labels: [],
          data: [],
          colors: []
        };

        <% if @college.pell_grant_rate.present? %>
          aidData.labels.push('Pell GrantÂà©Áî®');
          aidData.data.push(<%= (@college.pell_grant_rate * 100).round(1) %>);
          aidData.colors.push('#2C5282');
        <% end %>

        <% if @college.federal_loan_rate.present? %>
          aidData.labels.push('ÈÄ£ÈÇ¶„É≠„Éº„É≥Âà©Áî®');
          aidData.data.push(<%= (@college.federal_loan_rate * 100).round(1) %>);
          aidData.colors.push('#4A5568');
        <% end %>

        if (aidData.labels.length > 0) {
          const aidCtx = document.getElementById('financialAidChart');
          if (aidCtx) {
            new Chart(aidCtx, {
              type: 'pie',
              data: {
                labels: aidData.labels,
                datasets: [{
                  data: aidData.data,
                  backgroundColor: aidData.colors,
                  borderColor: '#ffffff',
                  borderWidth: 3,
                  hoverBorderWidth: 4,
                  hoverOffset: 8
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: {
                    position: 'bottom',
                    labels: {
                      padding: 20,
                      fontSize: 12,
                      fontFamily: 'Inter, sans-serif',
                      fontWeight: '500',
                      color: '#4a5568',
                      usePointStyle: true,
                      pointStyle: 'circle'
                    }
                  },
                  tooltip: {
                    backgroundColor: 'rgba(45, 55, 72, 0.95)',
                    titleColor: '#ffffff',
                    bodyColor: '#ffffff',
                    borderColor: '#f0b13d',
                    borderWidth: 1,
                    cornerRadius: 8,
                    callbacks: {
                      label: function(context) {
                        const percentage = context.parsed;
                        const label = context.label;
                        let nationalAvg = '';
                        
                        if (label.includes('Pell Grant')) {
                          nationalAvg = 'ÔºàÂÖ®Á±≥Âπ≥Âùá: 35%Ôºâ';
                        } else if (label.includes('ÈÄ£ÈÇ¶„É≠„Éº„É≥')) {
                          nationalAvg = 'ÔºàÂÖ®Á±≥Âπ≥Âùá: 50%Ôºâ';
                        }
                        
                        return [
                          label + ': ' + percentage + '%',
                          nationalAvg
                        ];
                      }
                    }
                  }
                },
                animation: {
                  animateScale: true,
                  animateRotate: true,
                  duration: 1000
                },
                layout: {
                  padding: 20
                }
              }
            });
          }
        }
      <% end %>

      // Costs Chart
      <% if has_aid_data && @college.room_board_cost.present? %>
        const costsCtx = document.getElementById('costsChart');
        if (costsCtx) {
          const tuitionCost = <%= @college.tuition_out_state || @college.tuition || 0 %>;
          const roomBoardCost = <%= @college.room_board_cost %>;
          
          new Chart(costsCtx, {
            type: 'bar',
            data: {
              labels: ['Âπ¥ÈñìË≤ªÁî®'],
              datasets: [{
                label: 'ÊéàÊ•≠Êñô',
                data: [tuitionCost],
                backgroundColor: 'rgba(44, 82, 130, 0.8)',
                borderColor: 'rgba(44, 82, 130, 1)',
                borderWidth: 2
              }, {
                label: 'ÂØÆË≤ª„ÉªÈ£üË≤ª',
                data: [roomBoardCost],
                backgroundColor: 'rgba(44, 122, 123, 0.8)',
                borderColor: 'rgba(44, 122, 123, 1)',
                borderWidth: 2
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                x: {
                  stacked: true,
                  grid: {
                    color: 'rgba(0, 0, 0, 0.1)'
                  },
                  ticks: {
                    color: '#4a5568',
                    font: {
                      family: 'Inter, sans-serif'
                    }
                  }
                },
                y: {
                  stacked: true,
                  beginAtZero: true,
                  grid: {
                    color: 'rgba(0, 0, 0, 0.1)'
                  },
                  ticks: {
                    color: '#4a5568',
                    font: {
                      family: 'Inter, sans-serif'
                    },
                    callback: function(value) {
                      return '$' + (value / 1000) + 'K';
                    }
                  }
                }
              },
              plugins: {
                legend: {
                  position: 'top',
                  labels: {
                    padding: 20,
                    fontSize: 12,
                    fontFamily: 'Inter, sans-serif',
                    fontWeight: '500',
                    color: '#4a5568'
                  }
                },
                datalabels: {
                  display: true,
                  anchor: 'center',
                  align: 'center',
                  color: '#ffffff',
                  font: {
                    family: 'Inter, sans-serif',
                    weight: '600',
                    size: 11
                  },
                  formatter: function(value, context) {
                    return '$' + (value / 1000).toFixed(0) + 'K';
                  }
                },
                tooltip: {
                  backgroundColor: 'rgba(45, 55, 72, 0.95)',
                  titleColor: '#ffffff',
                  bodyColor: '#ffffff',
                  borderColor: '#f0b13d',
                  borderWidth: 1,
                  cornerRadius: 8,
                  callbacks: {
                    label: function(context) {
                      const cost = context.parsed.y;
                      return context.dataset.label + ': $' + cost.toLocaleString();
                    },
                    footer: function(context) {
                      const total = tuitionCost + roomBoardCost;
                      return ['', 'Âπ¥ÈñìÁ∑èË≤ªÁî®: $' + total.toLocaleString()];
                    }
                  }
                }
              },
              animation: {
                duration: 1000,
                easing: 'easeOutCubic'
              },
              layout: {
                padding: 20
              }
            }
          });
        }
      <% end %>

      // Retention Rate Chart
      <% if has_retention_data %>
        const retentionCtx = document.getElementById('retentionChart');
        if (retentionCtx) {
          const retentionRate = <%= (@college.retention_rate * 100).round(1) %>;
          const nationalAverage = 81;
          
          new Chart(retentionCtx, {
            type: 'bar',
            data: {
              labels: ['1Âπ¥ÁîüÁ∂ôÁ∂öÁéá'],
              datasets: [{
                label: '„Åì„ÅÆÂ§ßÂ≠¶',
                data: [retentionRate],
                backgroundColor: retentionRate >= 80 ? 'rgba(44, 122, 123, 0.8)' :
                                  retentionRate >= 70 ? 'rgba(156, 139, 122, 0.8)' : 'rgba(139, 92, 92, 0.8)',
                borderColor: retentionRate >= 80 ? 'rgba(44, 122, 123, 1)' :
                            retentionRate >= 70 ? 'rgba(156, 139, 122, 1)' : 'rgba(139, 92, 92, 1)',
                borderWidth: 2
              }, {
                label: 'ÂÖ®Á±≥Âπ≥Âùá',
                data: [nationalAverage],
                backgroundColor: 'rgba(240, 177, 61, 0.7)',
                borderColor: 'rgba(240, 177, 61, 1)',
                borderWidth: 2
              }]
            },
            options: {
              indexAxis: 'y',
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  position: 'top',
                  labels: {
                    padding: 20,
                    fontSize: 12,
                    fontFamily: 'Inter, sans-serif',
                    fontWeight: '500',
                    color: '#4a5568'
                  }
                },
                datalabels: {
                  display: true,
                  anchor: 'end',
                  align: 'right',
                  color: '#2d3748',
                  font: {
                    family: 'Inter, sans-serif',
                    weight: '600',
                    size: 12
                  },
                  formatter: function(value, context) {
                    return value + '%';
                  },
                  offset: 4
                },
                tooltip: {
                  backgroundColor: 'rgba(45, 55, 72, 0.95)',
                  titleColor: '#ffffff',
                  bodyColor: '#ffffff',
                  borderColor: '#f0b13d',
                  borderWidth: 1,
                  cornerRadius: 8,
                  callbacks: {
                    label: function(context) {
                      const rate = context.parsed.x;
                      const dataset = context.dataset.label;
                      
                      let evaluation = '';
                      if (dataset === '„Åì„ÅÆÂ§ßÂ≠¶') {
                        if (rate >= 80) evaluation = 'ËâØÂ•Ω';
                        else if (rate >= 70) evaluation = 'Âπ≥ÂùáÁöÑ';
                        else evaluation = 'Ë¶ÅÊ≥®ÊÑè';
                        
                        const diff = rate - nationalAverage;
                        const comparison = diff > 0 ? `ÂÖ®Á±≥Âπ≥Âùá„Çà„Çä${diff.toFixed(1)}%È´ò„ÅÑ` : 
                                         diff < 0 ? `ÂÖ®Á±≥Âπ≥Âùá„Çà„Çä${Math.abs(diff).toFixed(1)}%‰Ωé„ÅÑ` : 
                                         'ÂÖ®Á±≥Âπ≥Âùá„Å®Âêå„Åò';
                        
                        return [
                          dataset + ': ' + rate + '%',
                          'Ë©ï‰æ°: ' + evaluation,
                          comparison
                        ];
                      }
                      
                      return dataset + ': ' + rate + '%';
                    }
                  }
                }
              },
              scales: {
                x: {
                  beginAtZero: true,
                  max: 100,
                  grid: {
                    color: 'rgba(0, 0, 0, 0.1)'
                  },
                  ticks: {
                    color: '#4a5568',
                    font: {
                      family: 'Inter, sans-serif'
                    },
                    callback: function(value) {
                      return value + '%';
                    }
                  }
                },
                y: {
                  grid: {
                    color: 'rgba(0, 0, 0, 0.1)'
                  },
                  ticks: {
                    color: '#4a5568',
                    font: {
                      family: 'Inter, sans-serif',
                      weight: '500'
                    }
                  }
                }
              },
              animation: {
                duration: 1000,
                easing: 'easeOutCubic'
              },
              layout: {
                padding: 20
              }
            }
          });
        }
      <% end %>
    }

    // Function to safely initialize charts with proper timing
    function safelyInitializeCharts() {
      if (typeof Chart === 'undefined') {
        console.log('Chart.js not yet loaded, retrying...');
        setTimeout(safelyInitializeCharts, 100);
        return;
      }
      
      try {
        // Register Chart.js plugins
        if (typeof ChartDataLabels !== 'undefined') {
          Chart.register(ChartDataLabels);
        }
        
        initializeDemographicsCharts();
        console.log('Charts initialized successfully');
      } catch (error) {
        console.error('Error initializing charts:', error);
      }
    }

    // Initialize charts when DOM is loaded
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', safelyInitializeCharts);
    } else {
      safelyInitializeCharts();
    }
  </script>
</body>
</html>


