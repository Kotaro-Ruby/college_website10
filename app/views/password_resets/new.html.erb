<div class="main">
  <div class="container">
    <div class="reset-container">
      <div class="reset-header">
        <h1>
          <i class="fas fa-key me-2"></i>
          パスワードリセット
        </h1>
        <p>登録されたメールアドレスにリセット用のリンクを送信します</p>
      </div>
      
      <div class="reset-form">
        <% if flash[:alert] %>
          <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <%= flash[:alert] %>
          </div>
        <% end %>
        
        <%= form_with url: password_resets_path, local: true, class: "needs-validation password-reset-form", novalidate: true, id: "passwordResetForm" do |f| %>
          <div class="mb-4">
            <label for="email" class="form-label">
              <i class="fas fa-envelope me-2"></i>メールアドレス
            </label>
            <%= f.email_field :email, 
                class: "form-control", 
                id: "email",
                placeholder: "example@email.com",
                required: true,
                autocomplete: "email" %>
            <div class="invalid-feedback">
              有効なメールアドレスを入力してください
            </div>
            <div id="email-error" class="error-message" style="display: none; color: #dc3545; font-size: 14px; margin-top: 5px; font-weight: 500;">
              <i class="fas fa-exclamation-circle"></i>
              <span id="error-text"></span>
            </div>
          </div>
          
          <div class="d-grid mb-4">
            <%= f.submit "リセットメールを送信", class: "btn btn-reset", id: "submitBtn", data: { loading_text: "送信中..." } %>
          </div>
        <% end %>
        
        <div class="text-center">
          <p class="mb-2">
            <i class="fas fa-arrow-left me-2"></i>
            <%= link_to "ログインページに戻る", login_path, class: "back-link" %>
          </p>
          <p class="mb-0">
            <i class="fas fa-user-plus me-2"></i>
            <%= link_to "新規登録はこちら", register_path, class: "back-link" %>
          </p>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .main {
    min-height: calc(100vh - 80px);
    padding: 40px 0;
    background: #f8f9fa;
  }
  
  .reset-container {
    background: white;
    border-radius: 20px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.05);
    overflow: hidden;
    max-width: 500px;
    margin: 0 auto;
  }
  
  .reset-header {
    background: linear-gradient(135deg, #f39c12, #e67e22);
    color: white;
    padding: 30px;
    text-align: center;
  }
  
  .reset-header h1 {
    margin-bottom: 10px;
    font-size: 28px;
    font-weight: 700;
  }
  
  .reset-header p {
    margin: 0;
    font-size: 16px;
    opacity: 0.9;
  }
  
  .reset-form {
    padding: 40px 30px;
  }
  
  .form-label {
    color: #333;
    font-weight: 600;
    margin-bottom: 8px;
  }
  
  .form-control {
    border-radius: 10px;
    border: 2px solid #e9ecef;
    padding: 12px 16px;
    font-size: 16px;
    transition: all 0.3s ease;
  }
  
  .form-control:focus {
    border-color: #f39c12;
    box-shadow: 0 0 0 0.2rem rgba(243, 156, 18, 0.25);
  }
  
  .btn-reset {
    background: linear-gradient(135deg, #f39c12, #e67e22);
    border: none;
    color: white;
    padding: 14px;
    border-radius: 10px;
    font-size: 16px;
    font-weight: 600;
    transition: all 0.3s ease;
  }
  
  .btn-reset:hover {
    background: linear-gradient(135deg, #e67e22, #d35400);
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(243, 156, 18, 0.3);
    color: white;
  }
  
  .back-link {
    color: #f39c12;
    text-decoration: none;
    font-weight: 500;
    transition: color 0.3s ease;
  }
  
  .back-link:hover {
    color: #e67e22;
    text-decoration: underline;
  }
  
  .alert {
    border-radius: 10px;
  }
  
  /* Shake animation for error */
  @keyframes shake {
    0%, 100% { transform: translateX(0); }
    10%, 30%, 50%, 70%, 90% { transform: translateX(-10px); }
    20%, 40%, 60%, 80% { transform: translateX(10px); }
  }
  
  .shake {
    animation: shake 0.6s;
  }
  
  /* Error state for input */
  .form-control.error {
    border-color: #dc3545 !important;
  }
  
  /* Mobile responsiveness */
  @media (max-width: 768px) {
    .main {
      padding: 20px 15px;
    }
    
    .reset-header {
      padding: 25px 20px;
    }
    
    .reset-header h1 {
      font-size: 24px;
    }
    
    .reset-form {
      padding: 30px 20px;
    }
  }
</style>

<script>
  // Password Reset Form Handler
  document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('passwordResetForm');
    const submitBtn = document.getElementById('submitBtn');
    const originalText = submitBtn.textContent;
    const loadingText = submitBtn.dataset.loadingText;
    const emailField = document.getElementById('email');
    const errorDiv = document.getElementById('email-error');
    
    // Clear error message when user starts typing
    emailField.addEventListener('input', function() {
      errorDiv.style.display = 'none';
      emailField.classList.remove('error');
    });

    form.addEventListener('submit', function(e) {
      e.preventDefault();
      
      // Validation check
      if (!form.checkValidity()) {
        form.classList.add('was-validated');
        return;
      }

      // Show loading state
      submitBtn.disabled = true;
      submitBtn.textContent = loadingText;
      submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>' + loadingText;

      // Get form data
      const formData = new FormData(form);
      const email = formData.get('email');

      // Send Ajax request
      fetch(form.action, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content,
          'Accept': 'application/json'
        },
        body: JSON.stringify({ email: email })
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          // Hide any error messages
          document.getElementById('email-error').style.display = 'none';
          showModal('success', '送信完了', data.message, function() {
            window.location.href = '/login';
          });
        } else {
          // Show inline error message only (no modal)
          const errorDiv = document.getElementById('email-error');
          const errorText = document.getElementById('error-text');
          errorText.textContent = data.message;
          errorDiv.style.display = 'block';
          
          // Add shake animation and error class to email field
          const emailField = document.getElementById('email');
          emailField.classList.add('shake', 'error');
          setTimeout(() => emailField.classList.remove('shake'), 600);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        showModal('error', 'エラー', 'ネットワークエラーが発生しました。しばらく後でもう一度お試しください。');
      })
      .finally(() => {
        // Reset button state
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
        submitBtn.innerHTML = originalText;
      });
    });

    // Bootstrap form validation
    (function() {
      'use strict';
      var forms = document.getElementsByClassName('needs-validation');
      Array.prototype.filter.call(forms, function(form) {
        form.addEventListener('submit', function(event) {
          if (form.checkValidity() === false) {
            event.preventDefault();
            event.stopPropagation();
          }
          form.classList.add('was-validated');
        }, false);
      });
    })();
  });

  // Modal function
  function showModal(type, title, message, callback) {
    const modal = document.createElement('div');
    modal.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10000;
      animation: fadeIn 0.3s ease;
    `;
    
    const iconClass = type === 'success' ? 'fas fa-check-circle' : 'fas fa-exclamation-triangle';
    const iconColor = type === 'success' ? '#28a745' : '#dc3545';
    
    const modalContent = document.createElement('div');
    modalContent.style.cssText = `
      background: white;
      padding: 40px;
      border-radius: 15px;
      text-align: center;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      animation: slideIn 0.3s ease;
    `;
    
    modalContent.innerHTML = `
      <div style="font-size: 3rem; margin-bottom: 20px; color: ${iconColor};">
        <i class="${iconClass}"></i>
      </div>
      <h3 style="margin: 0 0 15px 0; color: #2c3e50; font-size: 1.5rem;">${title}</h3>
      <p style="margin: 0 0 25px 0; color: ${type === 'error' ? '#dc3545' : '#666'}; line-height: 1.6; font-weight: ${type === 'error' ? '500' : 'normal'};">
        ${message}
      </p>
      <button onclick="this.closest('.modal-overlay').remove(); ${callback ? 'callback()' : ''}" 
              style="
                background: #f39c12;
                color: white;
                border: none;
                padding: 12px 30px;
                border-radius: 25px;
                font-size: 16px;
                font-weight: 600;
                cursor: pointer;
                transition: background 0.3s ease;
              " 
              onmouseover="this.style.background='#e67e22'" 
              onmouseout="this.style.background='#f39c12'">
        了解しました
      </button>
    `;
    
    modal.className = 'modal-overlay';
    modal.appendChild(modalContent);
    document.body.appendChild(modal);
    
    // Add CSS animations
    const style = document.createElement('style');
    style.textContent = `
      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }
      @keyframes slideIn {
        from { transform: translateY(-50px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
      }
    `;
    document.head.appendChild(style);
    
    modal.addEventListener('click', function(e) {
      if (e.target === modal) {
        modal.remove();
        if (callback) callback();
      }
    });

    // Set up callback function if needed
    if (callback) {
      window.callback = callback;
    }
  }
</script>