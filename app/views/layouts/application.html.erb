<!DOCTYPE html>
<html>
  <head>
    <title><%= content_for(:title) || "College Spark - ã‚¢ãƒ¡ãƒªã‚«å¤§å­¦æ¤œç´¢ã‚µã‚¤ãƒˆ" %></title>
    <meta name="description" content="<%= content_for(:description) || "6,300æ ¡ä»¥ä¸Šã®ã‚¢ãƒ¡ãƒªã‚«ã®å¤§å­¦ã‹ã‚‰ã€ã‚ãªãŸã®æ¡ä»¶ã«åˆã£ãŸå¤§å­¦ã‚’æ¤œç´¢ã§ãã¾ã™ã€‚å­¦è²»ã€åˆæ ¼ç‡ã€å°‚æ”»ãªã©è©³ç´°ãªæƒ…å ±ã§å¤§å­¦é¸ã³ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¾ã™ã€‚" %>">
    <meta name="keywords" content="<%= content_for(:keywords) || "ã‚¢ãƒ¡ãƒªã‚«å¤§å­¦, å¤§å­¦æ¤œç´¢, ç•™å­¦, æµ·å¤–å¤§å­¦, College Spark, å¤§å­¦é¸ã³, å­¦è²», åˆæ ¼ç‡" %>">
    <meta name="author" content="College Spark">
    <meta name="robots" content="index, follow">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>
    
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-PRDMMDCHWX"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-PRDMMDCHWX');
    </script>

    <!-- OGP Tags -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="<%= content_for(:og_title) || content_for(:title) || "College Spark - ã‚¢ãƒ¡ãƒªã‚«å¤§å­¦æ¤œç´¢ã‚µã‚¤ãƒˆ" %>">
    <meta property="og:description" content="<%= content_for(:og_description) || content_for(:description) || "6,300æ ¡ä»¥ä¸Šã®ã‚¢ãƒ¡ãƒªã‚«ã®å¤§å­¦ã‹ã‚‰ã€ã‚ãªãŸã®æ¡ä»¶ã«åˆã£ãŸå¤§å­¦ã‚’æ¤œç´¢ã§ãã¾ã™ã€‚å­¦è²»ã€åˆæ ¼ç‡ã€å°‚æ”»ãªã©è©³ç´°ãªæƒ…å ±ã§å¤§å­¦é¸ã³ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¾ã™ã€‚" %>">
    <meta property="og:url" content="<%= request.original_url %>">
    <meta property="og:site_name" content="College Spark">
    <meta property="og:image" content="<%= content_for(:og_image) || "#{request.base_url}/icon.png" %>">
    <meta property="og:locale" content="ja_JP">
    
    <!-- Twitter Cards -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="<%= content_for(:twitter_title) || content_for(:og_title) || content_for(:title) || "College Spark - ã‚¢ãƒ¡ãƒªã‚«å¤§å­¦æ¤œç´¢ã‚µã‚¤ãƒˆ" %>">
    <meta name="twitter:description" content="<%= content_for(:twitter_description) || content_for(:og_description) || content_for(:description) || "6,300æ ¡ä»¥ä¸Šã®ã‚¢ãƒ¡ãƒªã‚«ã®å¤§å­¦ã‹ã‚‰ã€ã‚ãªãŸã®æ¡ä»¶ã«åˆã£ãŸå¤§å­¦ã‚’æ¤œç´¢ã§ãã¾ã™ã€‚" %>">
    <meta name="twitter:image" content="<%= content_for(:twitter_image) || content_for(:og_image) || "#{request.base_url}/icon.png" %>">
    
    <!-- Canonical URL -->
    <link rel="canonical" href="<%= content_for(:canonical_url) || request.original_url %>">

    <!-- Structured Data (JSON-LD) -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebSite",
      "name": "College Spark",
      "url": "<%= request.base_url %>",
      "description": "6,300æ ¡ä»¥ä¸Šã®ã‚¢ãƒ¡ãƒªã‚«ã®å¤§å­¦ã‹ã‚‰ã€ã‚ãªãŸã®æ¡ä»¶ã«åˆã£ãŸå¤§å­¦ã‚’æ¤œç´¢ãƒ»æ¯”è¼ƒã§ãã‚‹ã‚µã‚¤ãƒˆ",
      "potentialAction": {
        "@type": "SearchAction",
        "target": {
          "@type": "EntryPoint",
          "urlTemplate": "<%= request.base_url %>/results?college_name={search_term_string}"
        },
        "query-input": "required name=search_term_string"
      },
      "publisher": {
        "@type": "Organization",
        "name": "College Spark",
        "url": "<%= request.base_url %>"
      }
    }
    </script>

    <%= yield :head %>

    <%# Enable PWA manifest for installable apps (make sure to enable in config/routes.rb too!) %>
    <%#= tag.link rel: "manifest", href: pwa_manifest_path(format: :json) %>

    <link rel="icon" href="/icon.svg" type="image/svg+xml">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" href="/icon.svg">

    <%# Bootstrap CSS %>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <%# Includes all stylesheet files in app/assets/stylesheets %>
    <%= stylesheet_link_tag "application", "data-turbo-track": "reload", rel: "stylesheet" %>
    
    <%# Bootstrap JavaScript %>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>
    
    <%= javascript_importmap_tags %>
  </head>

  <body style="margin: 0; min-height: 100vh; display: flex; flex-direction: column;">
    <%= render 'shared/header' %>
    <main style="flex: 1;">
      <%= yield %>
    </main>
    <%= render 'shared/footer' %>
    
    <!-- Star Rating Widget -->
    <div id="ratingWidget" class="rating-widget">
      <div class="rating-content">
        <div class="rating-text">æº€è¶³åº¦èª¿æŸ»ã«ã”å”åŠ›ãã ã•ã„ï¼</div>
        <div class="star-rating">
          <button class="star" data-rating="1" onclick="setRating(1)">â­</button>
          <button class="star" data-rating="2" onclick="setRating(2)">â­</button>
          <button class="star" data-rating="3" onclick="setRating(3)">â­</button>
          <button class="star" data-rating="4" onclick="setRating(4)">â­</button>
          <button class="star" data-rating="5" onclick="setRating(5)">â­</button>
        </div>
        <div class="rating-message" id="ratingMessage" style="display: none;">
          <p>ã”å›ç­”ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼</p>
        </div>
      </div>
    </div>
    
    <!-- Detailed Survey Popup -->
    <div id="detailedSurvey" class="survey-overlay" style="display: none;">
      <div class="survey-popup">
        <button class="survey-close" onclick="closeDetailedSurvey()">&times;</button>
        <div class="survey-header">
          <h3>ğŸ¯ è©³ç´°ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ</h3>
          <p>ã•ã‚‰ã«è©³ã—ããŠèã‹ã›ãã ã•ã„ï¼ˆä»»æ„ï¼‰</p>
        </div>
        
        <form id="detailedSurveyForm" class="survey-form">
          <div class="survey-question">
            <label>ã©ã®ã‚ˆã†ãªç›®çš„ã§ã‚µã‚¤ãƒˆã‚’è¨ªå•ã•ã‚Œã¾ã—ãŸã‹ï¼Ÿ</label>
            <div class="survey-options">
              <label class="survey-option">
                <input type="radio" name="purpose" value="research">
                <span>ç•™å­¦ã®æƒ…å ±åé›†</span>
              </label>
              <label class="survey-option">
                <input type="radio" name="purpose" value="specific">
                <span>ç‰¹å®šã®å¤§å­¦ã‚’æ¢ã—ã¦ã„ã‚‹</span>
              </label>
              <label class="survey-option">
                <input type="radio" name="purpose" value="browsing">
                <span>ãªã‚“ã¨ãªãè¦‹ã¦ã„ã‚‹</span>
              </label>
              <label class="survey-option">
                <input type="radio" name="purpose" value="other">
                <span>ãã®ä»–</span>
              </label>
            </div>
          </div>
          
          <div class="survey-question">
            <label>æ”¹å–„ã—ã¦ã»ã—ã„ç‚¹ãŒã‚ã‚Œã°æ•™ãˆã¦ãã ã•ã„ï¼ˆä»»æ„ï¼‰</label>
            <textarea name="feedback" rows="3" placeholder="ã”æ„è¦‹ãƒ»ã”è¦æœ›ã‚’ãŠèã‹ã›ãã ã•ã„"></textarea>
          </div>
          
          <div class="survey-buttons">
            <button type="button" class="survey-skip" onclick="closeDetailedSurvey()">ã‚¹ã‚­ãƒƒãƒ—</button>
            <button type="submit" class="survey-submit">é€ä¿¡ã™ã‚‹</button>
          </div>
        </form>
        
        <div class="survey-thanks" style="display: none;">
          <div class="thanks-icon">ğŸ‰</div>
          <h3>ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸï¼</h3>
          <p>è²´é‡ãªã”æ„è¦‹ã‚’ã„ãŸã ãã€ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚<br>ã‚µãƒ¼ãƒ“ã‚¹ã®æ”¹å–„ã«æ´»ç”¨ã•ã›ã¦ã„ãŸã ãã¾ã™ã€‚</p>
        </div>
      </div>
    </div>
    
    <style>
      .rating-widget {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1000;
        background: white;
        border-radius: 12px;
        padding: 10px 15px;
        box-shadow: 0 3px 15px rgba(0, 0, 0, 0.12);
        border: 1px solid #e5e7eb;
        max-width: 220px;
      }
      
      .rating-content {
        text-align: center;
      }
      
      .rating-text {
        font-size: 0.75rem;
        color: #374151;
        font-weight: 500;
        margin-bottom: 8px;
        line-height: 1.2;
      }
      
      .star-rating {
        display: flex;
        gap: 2px;
        justify-content: center;
        margin-bottom: 6px;
      }
      
      .star {
        background: none;
        border: none;
        font-size: 1.2rem;
        cursor: pointer;
        color: #d1d5db;
        transition: all 0.2s ease;
        padding: 1px;
        border-radius: 2px;
      }
      
      .star:hover,
      .star.active {
        color: #fbbf24;
        transform: scale(1.1);
      }
      
      .star.active {
        animation: starGlow 0.3s ease;
      }
      
      @keyframes starGlow {
        0% { transform: scale(1); }
        50% { transform: scale(1.2); }
        100% { transform: scale(1.1); }
      }
      
      .rating-message {
        text-align: center;
        color: #059669;
        font-weight: 600;
        animation: fadeIn 0.3s ease;
      }
      
      .rating-message p {
        margin: 0;
        font-size: 0.7rem;
      }
      
      /* Detailed Survey Popup Styles */
      .survey-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10000;
        animation: fadeIn 0.3s ease;
      }
      
      .survey-popup {
        background: white;
        border-radius: 16px;
        padding: 25px;
        max-width: 450px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
        position: relative;
        animation: slideIn 0.3s ease;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      }
      
      @keyframes slideIn {
        from { transform: translateY(-20px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
      }
      
      .survey-close {
        position: absolute;
        top: 12px;
        right: 12px;
        width: 28px;
        height: 28px;
        border: none;
        background: #f3f4f6;
        border-radius: 50%;
        font-size: 18px;
        cursor: pointer;
        color: #6b7280;
        transition: all 0.2s ease;
      }
      
      .survey-close:hover {
        background: #e5e7eb;
        color: #374151;
      }
      
      .survey-header {
        text-align: center;
        margin-bottom: 25px;
      }
      
      .survey-header h3 {
        font-size: 1.3rem;
        color: #1f2937;
        margin-bottom: 8px;
        font-weight: 700;
      }
      
      .survey-header p {
        color: #6b7280;
        font-size: 0.9rem;
      }
      
      .survey-question {
        margin-bottom: 20px;
      }
      
      .survey-question label {
        display: block;
        font-weight: 600;
        color: #374151;
        margin-bottom: 10px;
        font-size: 0.9rem;
      }
      
      .survey-options {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      
      .survey-option {
        display: flex;
        align-items: center;
        padding: 10px 12px;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 0.85rem;
      }
      
      .survey-option:hover {
        border-color: #fbbf24;
        background: #fef3c7;
      }
      
      .survey-option input[type="radio"] {
        margin-right: 8px;
        cursor: pointer;
      }
      
      .survey-option input[type="radio"]:checked + span {
        font-weight: 600;
        color: #d97706;
      }
      
      .survey-question textarea {
        width: 100%;
        padding: 10px;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        resize: vertical;
        font-family: inherit;
        font-size: 0.85rem;
      }
      
      .survey-question textarea:focus {
        outline: none;
        border-color: #fbbf24;
      }
      
      .survey-buttons {
        display: flex;
        gap: 10px;
        margin-top: 20px;
      }
      
      .survey-skip {
        flex: 1;
        padding: 12px;
        background: #f3f4f6;
        color: #6b7280;
        border: none;
        border-radius: 8px;
        font-size: 0.9rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
      }
      
      .survey-skip:hover {
        background: #e5e7eb;
        color: #374151;
      }
      
      .survey-submit {
        flex: 2;
        padding: 12px;
        background: linear-gradient(135deg, #fbbf24, #f59e0b);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 0.9rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
      }
      
      .survey-submit:hover {
        background: linear-gradient(135deg, #f59e0b, #d97706);
        transform: translateY(-1px);
        box-shadow: 0 6px 15px rgba(245, 158, 11, 0.3);
      }
      
      .survey-thanks {
        text-align: center;
        padding: 30px 20px;
      }
      
      .thanks-icon {
        font-size: 3rem;
        margin-bottom: 15px;
      }
      
      .survey-thanks h3 {
        font-size: 1.3rem;
        color: #1f2937;
        margin-bottom: 8px;
      }
      
      .survey-thanks p {
        color: #6b7280;
        font-size: 0.9rem;
        line-height: 1.5;
      }
      
      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }
      
      @media (max-width: 768px) {
        .rating-widget {
          bottom: 15px;
          right: 15px;
          padding: 8px 12px;
          max-width: 200px;
        }
        
        .rating-text {
          font-size: 0.7rem;
        }
        
        .star {
          font-size: 1.1rem;
        }
        
        .survey-popup {
          padding: 20px;
          margin: 20px;
        }
      }
      
      @media (max-width: 480px) {
        .rating-widget {
          bottom: 10px;
          right: 10px;
          padding: 6px 10px;
          max-width: 180px;
        }
        
        .rating-text {
          font-size: 0.65rem;
        }
        
        .star {
          font-size: 1rem;
        }
        
        .survey-popup {
          padding: 15px;
        }
      }
    </style>
    
    <script>
      // Star Rating Widget
      let selectedRating = 0;
      let hasRated = localStorage.getItem('collegeSparkRating') !== null;
      
      // æ˜Ÿã®è©•ä¾¡ã‚’è¨­å®š
      function setRating(rating) {
        if (hasRated) return; // æ—¢ã«è©•ä¾¡æ¸ˆã¿ã®å ´åˆã¯ç„¡åŠ¹
        
        selectedRating = rating;
        localStorage.setItem('collegeSparkRating', rating);
        localStorage.setItem('collegeSparkRatingDate', new Date().toISOString());
        
        hasRated = true;
        updateStarDisplay();
        showThankYouMessage();
      }
      
      // æ˜Ÿã®è¡¨ç¤ºã‚’æ›´æ–°
      function updateStarDisplay() {
        const stars = document.querySelectorAll('.star');
        const savedRating = localStorage.getItem('collegeSparkRating');
        const displayRating = savedRating || selectedRating;
        
        stars.forEach((star, index) => {
          const starRating = index + 1;
          if (starRating <= displayRating) {
            star.classList.add('active');
          } else {
            star.classList.remove('active');
          }
          
          // æ—¢ã«è©•ä¾¡æ¸ˆã¿ã®å ´åˆã¯ç„¡åŠ¹åŒ–
          if (hasRated) {
            star.style.cursor = 'default';
          }
        });
      }
      
      // ãŠç¤¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
      function showThankYouMessage() {
        const message = document.getElementById('ratingMessage');
        const text = document.querySelector('.rating-text');
        
        text.style.display = 'none';
        message.style.display = 'block';
        
        // 2ç§’å¾Œã«è©³ç´°ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã‚’è¡¨ç¤º
        setTimeout(() => {
          showDetailedSurvey();
        }, 2000);
        
        // 5ç§’å¾Œã«ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆå…¨ä½“ã‚’éè¡¨ç¤º
        setTimeout(() => {
          const widget = document.getElementById('ratingWidget');
          widget.style.display = 'none';
        }, 5000);
      }
      
      // è©³ç´°ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã‚’è¡¨ç¤º
      function showDetailedSurvey() {
        const detailedSurvey = localStorage.getItem('collegeSparkDetailedSurvey');
        if (detailedSurvey) return; // æ—¢ã«å›ç­”æ¸ˆã¿
        
        document.getElementById('detailedSurvey').style.display = 'flex';
        document.body.style.overflow = 'hidden';
      }
      
      // è©³ç´°ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã‚’é–‰ã˜ã‚‹
      function closeDetailedSurvey() {
        document.getElementById('detailedSurvey').style.display = 'none';
        document.body.style.overflow = '';
        localStorage.setItem('collegeSparkDetailedSurvey', 'skipped');
      }
      
      // æ˜Ÿã®ãƒ›ãƒãƒ¼åŠ¹æœ
      document.addEventListener('DOMContentLoaded', function() {
        const stars = document.querySelectorAll('.star');
        
        stars.forEach((star, index) => {
          star.addEventListener('mouseenter', function() {
            if (hasRated) return;
            
            stars.forEach((s, i) => {
              if (i <= index) {
                s.style.color = '#fbbf24';
              } else {
                s.style.color = '#d1d5db';
              }
            });
          });
          
          star.addEventListener('mouseleave', function() {
            if (hasRated) return;
            updateStarDisplay();
          });
        });
        
        // æ—¢ã«è©•ä¾¡æ¸ˆã¿ã‹ãƒã‚§ãƒƒã‚¯
        if (hasRated) {
          const widget = document.getElementById('ratingWidget');
          widget.style.display = 'none';
        }
        
        // è©³ç´°ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å‡¦ç†
        const detailedForm = document.getElementById('detailedSurveyForm');
        detailedForm.addEventListener('submit', function(e) {
          e.preventDefault();
          
          // ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’åé›†
          const formData = new FormData(detailedForm);
          const data = {
            purpose: formData.get('purpose'),
            feedback: formData.get('feedback'),
            rating: localStorage.getItem('collegeSparkRating'),
            timestamp: new Date().toISOString()
          };
          
          // ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡
          fetch('/surveys', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
            },
            body: JSON.stringify(data)
          })
          .then(response => response.json())
          .then(result => {
            if (result.status === 'success') {
              localStorage.setItem('collegeSparkDetailedSurvey', 'completed');
              console.log('Survey data saved successfully');
            } else {
              console.error('Survey save failed:', result.message);
            }
          })
          .catch(error => {
            console.error('Survey submission error:', error);
            // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
            localStorage.setItem('collegeSparkDetailedSurveyData', JSON.stringify(data));
            localStorage.setItem('collegeSparkDetailedSurvey', 'completed');
          });
          
          // Thank youãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
          detailedForm.style.display = 'none';
          document.querySelector('.survey-header').style.display = 'none';
          document.querySelector('.survey-thanks').style.display = 'block';
          
          // 3ç§’å¾Œã«è‡ªå‹•çš„ã«é–‰ã˜ã‚‹
          setTimeout(() => {
            closeDetailedSurvey();
          }, 3000);
        });
        
        // èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§è©³ç´°ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã‚’é–‰ã˜ã‚‹
        document.getElementById('detailedSurvey').addEventListener('click', function(e) {
          if (e.target === this) {
            closeDetailedSurvey();
          }
        });
      });
    </script>
  </body>
</html>
