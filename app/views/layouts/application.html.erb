<!DOCTYPE html>
<html>
  <head>
    <title><%= content_for(:title) || "College Spark - ã‚¢ãƒ¡ãƒªã‚«å¤§å­¦æ¤œç´¢ã‚µã‚¤ãƒˆ" %></title>
    <meta name="description" content="<%= content_for(:description) || "6,300æ ¡ä»¥ä¸Šã®ã‚¢ãƒ¡ãƒªã‚«ã®å¤§å­¦ã‹ã‚‰ã€ã‚ãªãŸã®æ¡ä»¶ã«åˆã£ãŸå¤§å­¦ã‚’æ¤œç´¢ã§ãã¾ã™ã€‚å­¦è²»ã€åˆæ ¼ç‡ã€å°‚æ”»ãªã©è©³ç´°ãªæƒ…å ±ã§å¤§å­¦é¸ã³ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¾ã™ã€‚" %>">
    <meta name="keywords" content="<%= content_for(:keywords) || "ã‚¢ãƒ¡ãƒªã‚«å¤§å­¦, å¤§å­¦æ¤œç´¢, ç•™å­¦, æµ·å¤–å¤§å­¦, College Spark, å¤§å­¦é¸ã³, å­¦è²», åˆæ ¼ç‡" %>">
    <meta name="author" content="College Spark">
    <meta name="robots" content="index, follow">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>
    
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-PRDMMDCHWX"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-PRDMMDCHWX');
    </script>

    <!-- OGP Tags -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="<%= content_for(:og_title) || content_for(:title) || "College Spark - ã‚¢ãƒ¡ãƒªã‚«å¤§å­¦æ¤œç´¢ã‚µã‚¤ãƒˆ" %>">
    <meta property="og:description" content="<%= content_for(:og_description) || content_for(:description) || "6,300æ ¡ä»¥ä¸Šã®ã‚¢ãƒ¡ãƒªã‚«ã®å¤§å­¦ã‹ã‚‰ã€ã‚ãªãŸã®æ¡ä»¶ã«åˆã£ãŸå¤§å­¦ã‚’æ¤œç´¢ã§ãã¾ã™ã€‚å­¦è²»ã€åˆæ ¼ç‡ã€å°‚æ”»ãªã©è©³ç´°ãªæƒ…å ±ã§å¤§å­¦é¸ã³ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¾ã™ã€‚" %>">
    <meta property="og:url" content="<%= request.original_url %>">
    <meta property="og:image" content="<%= content_for(:og_image) || "#{request.base_url}/favicon.ico" %>">
    <meta property="og:site_name" content="College Spark">
    <meta property="og:locale" content="ja_JP">
    
    <!-- Twitter Cards -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="@college__spark">
    <meta name="twitter:creator" content="@college__spark">
    <meta name="twitter:title" content="<%= content_for(:twitter_title) || content_for(:og_title) || content_for(:title) || "College Spark - ã‚¢ãƒ¡ãƒªã‚«å¤§å­¦æ¤œç´¢ã‚µã‚¤ãƒˆ" %>">
    <meta name="twitter:description" content="<%= content_for(:twitter_description) || content_for(:og_description) || content_for(:description) || "6,300æ ¡ä»¥ä¸Šã®ã‚¢ãƒ¡ãƒªã‚«ã®å¤§å­¦ã‹ã‚‰ã€ã‚ãªãŸã®æ¡ä»¶ã«åˆã£ãŸå¤§å­¦ã‚’æ¤œç´¢ã§ãã¾ã™ã€‚" %>">
    <meta name="twitter:image" content="<%= content_for(:twitter_image) || content_for(:og_image) || "#{request.base_url}/favicon.ico" %>">
    
    <!-- Canonical URL -->
    <link rel="canonical" href="<%= content_for(:canonical_url) || request.original_url %>">

    <!-- Structured Data (JSON-LD) -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebSite",
      "name": "College Spark",
      "url": "<%= request.base_url %>",
      "description": "6,300æ ¡ä»¥ä¸Šã®ã‚¢ãƒ¡ãƒªã‚«ã®å¤§å­¦ã‹ã‚‰ã€ã‚ãªãŸã®æ¡ä»¶ã«åˆã£ãŸå¤§å­¦ã‚’æ¤œç´¢ãƒ»æ¯”è¼ƒã§ãã‚‹ã‚µã‚¤ãƒˆ",
      "potentialAction": {
        "@type": "SearchAction",
        "target": {
          "@type": "EntryPoint",
          "urlTemplate": "<%= request.base_url %>/results?college_name={search_term_string}"
        },
        "query-input": "required name=search_term_string"
      },
      "publisher": {
        "@type": "Organization",
        "name": "College Spark",
        "url": "<%= request.base_url %>"
      }
    }
    </script>

    <%= yield :head %>

    <%# Enable PWA manifest for installable apps (make sure to enable in config/routes.rb too!) %>
    <%#= tag.link rel: "manifest", href: pwa_manifest_path(format: :json) %>

    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" href="/favicon.ico">

    <%# Bootstrap CSS %>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <%# Includes all stylesheet files in app/assets/stylesheets %>
    <%= stylesheet_link_tag "application", "data-turbo-track": "reload", rel: "stylesheet" %>
    
    <%# Bootstrap JavaScript %>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>
    
    <%= javascript_importmap_tags %>
  </head>

  <body style="margin: 0; min-height: 100vh; display: flex; flex-direction: column;">
    <%= render 'shared/header' %>
    <main style="flex: 1;">
      <%= yield %>
    </main>
    <%= render 'shared/footer' %>
    
    <!-- Star Rating Widget -->

    <!-- Rating Widget -->
    <div id="ratingWidget" class="rating-widget" style="display: none;">
      <button class="widget-close" onclick="closeSurveyWidget()">&times;</button>
      <div class="rating-content">
        <div class="emoji-icon">ğŸ†</div>
        <p class="rating-text">âœ¨ ã”æ„è¦‹ã‚’ãŠèã‹ã›ãã ã•ã„ï¼</p>
        <div class="star-rating">
          <span class="star" onclick="setRating(1)">â­</span>
          <span class="star" onclick="setRating(2)">â­</span>
          <span class="star" onclick="setRating(3)">â­</span>
          <span class="star" onclick="setRating(4)">â­</span>
          <span class="star" onclick="setRating(5)">â­</span>
        </div>
        <p class="rating-subtext">ã‚µãƒ¼ãƒ“ã‚¹æ”¹å–„ã«ã”å”åŠ›ãã ã•ã„ ğŸš€</p>
      </div>
    </div>
    
    <!-- Detailed Survey Popup -->
    <div id="detailedSurvey" class="survey-overlay" style="display: none;">
      <div class="survey-popup">
        <button class="survey-close" onclick="closeDetailedSurvey()">&times;</button>
        <div class="survey-header">
          <h3>ğŸ¯ è©³ç´°ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ</h3>
          <p>ã•ã‚‰ã«è©³ã—ããŠèã‹ã›ãã ã•ã„ï¼ˆä»»æ„ï¼‰</p>
        </div>
        
        <form id="detailedSurveyForm" class="survey-form">
          <div class="survey-question">
            <label>ã©ã®ã‚ˆã†ãªç›®çš„ã§ã‚µã‚¤ãƒˆã‚’è¨ªå•ã•ã‚Œã¾ã—ãŸã‹ï¼Ÿ</label>
            <div class="survey-options">
              <label class="survey-option">
                <input type="radio" name="purpose" value="research">
                <span>ç•™å­¦ã®æƒ…å ±åé›†</span>
              </label>
              <label class="survey-option">
                <input type="radio" name="purpose" value="specific">
                <span>ç‰¹å®šã®å¤§å­¦ã‚’æ¢ã—ã¦ã„ã‚‹</span>
              </label>
              <label class="survey-option">
                <input type="radio" name="purpose" value="browsing">
                <span>ãªã‚“ã¨ãªãè¦‹ã¦ã„ã‚‹</span>
              </label>
              <label class="survey-option">
                <input type="radio" name="purpose" value="other">
                <span>ãã®ä»–</span>
              </label>
            </div>
          </div>
          
          <div class="survey-question">
            <label>æ”¹å–„ã—ã¦ã»ã—ã„ç‚¹ãŒã‚ã‚Œã°æ•™ãˆã¦ãã ã•ã„ï¼ˆä»»æ„ï¼‰</label>
            <textarea name="feedback" rows="3" placeholder="ã”æ„è¦‹ãƒ»ã”è¦æœ›ã‚’ãŠèã‹ã›ãã ã•ã„"></textarea>
          </div>
          
          <div class="survey-buttons">
            <button type="button" class="survey-skip" onclick="closeDetailedSurvey()">ã‚¹ã‚­ãƒƒãƒ—</button>
            <button type="submit" class="survey-submit">é€ä¿¡ã™ã‚‹</button>
          </div>
        </form>
        
        <div class="survey-thanks" style="display: none;">
          <div class="thanks-icon">ğŸ‰âœ¨</div>
          <h3>å¿ƒã‚ˆã‚Šæ„Ÿè¬ç”³ã—ä¸Šã’ã¾ã™ï¼</h3>
          <p>ã‚ãªãŸã®è²´é‡ãªã”æ„è¦‹ã¯ã€ã‚ˆã‚Šè‰¯ã„ã‚µãƒ¼ãƒ“ã‚¹ä½œã‚Šã®åŸå‹•åŠ›ã¨ãªã‚Šã¾ã™ã€‚<br>
          <strong>College Spark</strong>ã‚’ã‚ˆã‚Šä½¿ã„ã‚„ã™ãã€ã‚ˆã‚Šä¾¡å€¤ã®ã‚ã‚‹ã‚‚ã®ã«ã™ã‚‹ãŸã‚ã«<br>
          å¤§åˆ‡ã«æ´»ç”¨ã•ã›ã¦ã„ãŸã ãã¾ã™ã€‚</p>
          <div class="thanks-message">
            <p>ğŸš€ ä»Šå¾Œã¨ã‚‚ã‚ˆã‚ã—ããŠé¡˜ã„ã„ãŸã—ã¾ã™</p>
          </div>
        </div>
      </div>
    </div>
    
    <style>
      .rating-widget {
        position: fixed;
        bottom: 20px;
        left: 20px;
        z-index: 1000;
        background: linear-gradient(135deg, rgba(255, 146, 36, 0.7) 0%, rgba(255, 122, 0, 0.7) 100%);
        border-radius: 20px;
        padding: 20px;
        box-shadow: 0 10px 30px rgba(255, 122, 0, 0.3), 0 0 0 2px rgba(255, 255, 255, 0.2);
        max-width: 320px;
        color: white;
        animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        border: 2px solid rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        display: none; /* åˆæœŸçŠ¶æ…‹ã§éè¡¨ç¤º */
      }
      
      /* ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ */
      @media (max-width: 768px) {
        .rating-widget {
          bottom: 10px;
          left: 10px;
          right: 10px;
          max-width: none;
          padding: 16px;
          border-radius: 16px;
        }
      }
      
      @media (max-width: 480px) {
        .rating-widget {
          bottom: 8px;
          left: 8px;
          right: 8px;
          padding: 14px;
          border-radius: 14px;
        }
      }
      
      .rating-widget.show {
        display: block !important;
      }
      
      .rating-widget.hidden {
        display: none !important;
      }
      
      @keyframes pulse {
        0%, 100% {
          transform: scale(1);
          box-shadow: 0 10px 30px rgba(255, 122, 0, 0.3), 0 0 0 2px rgba(255, 255, 255, 0.2);
        }
        50% {
          transform: scale(1.02);
          box-shadow: 0 15px 40px rgba(255, 122, 0, 0.4), 0 0 0 4px rgba(255, 255, 255, 0.3);
        }
      }
      
      .widget-close {
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        font-size: 18px;
        cursor: pointer;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        backdrop-filter: blur(10px);
      }
      
      .widget-close:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: rotate(90deg) scale(1.1);
      }
      
      .rating-content {
        text-align: center;
        position: relative;
      }
      
      .emoji-icon {
        font-size: 40px;
        margin-bottom: 10px;
        animation: bounce 1s ease-in-out infinite;
      }
      
      @media (max-width: 480px) {
        .emoji-icon {
          font-size: 32px;
          margin-bottom: 8px;
        }
      }
      
      @keyframes bounce {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-10px); }
      }
      
      .rating-subtext {
        margin-top: 12px;
        font-size: 12px;
        opacity: 0.9;
        font-weight: 500;
        animation: fadeIn 1s ease-out 0.5s both;
      }
      
      @media (max-width: 480px) {
        .rating-subtext {
          font-size: 11px;
          margin-top: 8px;
        }
      }
      
      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 0.9; }
      }
      
      @keyframes fadeOut {
        from { 
          opacity: 1;
          transform: scale(1);
        }
        to { 
          opacity: 0;
          transform: scale(0.8);
        }
      }
      
      /* ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ */
      .toast-notification {
        position: fixed;
        bottom: 100px;
        left: 50%;
        transform: translateX(-50%) translateY(100px);
        background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
        color: white;
        padding: 16px 32px;
        border-radius: 50px;
        font-weight: 600;
        font-size: 16px;
        box-shadow: 0 8px 24px rgba(76, 175, 80, 0.3);
        z-index: 10001;
        opacity: 0;
        transition: all 0.3s ease-out;
      }
      
      .toast-notification.show {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
      }
      
      
      .rating-text {
        margin: 0 0 16px 0;
        font-size: 16px;
        font-weight: 700;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        letter-spacing: 0.5px;
        animation: slideIn 0.6s ease-out;
      }
      
      @media (max-width: 480px) {
        .rating-text {
          font-size: 14px;
          margin: 0 0 12px 0;
        }
      }
      
      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateX(-20px);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }
      
      .star-rating {
        display: flex;
        gap: 8px;
        justify-content: center;
      }
      
      .star {
        font-size: 28px;
        cursor: pointer;
        opacity: 0.7;
        transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
        animation: starBounce 0.5s ease-out;
        animation-delay: calc(var(--star-index) * 0.1s);
      }
      
      @media (max-width: 480px) {
        .star {
          font-size: 24px;
        }
      }
      
      .star:nth-child(1) { --star-index: 0; }
      .star:nth-child(2) { --star-index: 1; }
      .star:nth-child(3) { --star-index: 2; }
      .star:nth-child(4) { --star-index: 3; }
      .star:nth-child(5) { --star-index: 4; }
      
      @keyframes starBounce {
        0% {
          transform: scale(0);
          opacity: 0;
        }
        50% {
          transform: scale(1.2);
        }
        100% {
          transform: scale(1);
          opacity: 0.7;
        }
      }
      
      .star:hover {
        opacity: 1;
        transform: scale(1.3) rotate(15deg);
        filter: drop-shadow(0 4px 8px rgba(255, 255, 0, 0.5));
      }
      
      .star:active {
        transform: scale(1.5) rotate(30deg);
      }
      
      /* Detailed Survey Popup Styles */
      .survey-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10000;
        animation: fadeIn 0.3s ease;
      }
      
      .survey-popup {
        background: white;
        border-radius: 16px;
        padding: 25px;
        max-width: 450px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
        position: relative;
        animation: slideIn 0.3s ease;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      }
      
      @media (max-width: 480px) {
        .survey-popup {
          width: 95%;
          padding: 20px;
          border-radius: 12px;
          max-height: 85vh;
        }
      }
      
      @keyframes slideIn {
        from { transform: translateY(-20px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
      }
      
      .survey-close {
        position: absolute;
        top: 12px;
        right: 12px;
        width: 28px;
        height: 28px;
        border: none;
        background: #f3f4f6;
        border-radius: 50%;
        font-size: 18px;
        cursor: pointer;
        color: #6b7280;
        transition: all 0.2s ease;
      }
      
      .survey-close:hover {
        background: #e5e7eb;
        color: #374151;
      }
      
      .survey-header {
        text-align: center;
        margin-bottom: 25px;
      }
      
      .survey-header h3 {
        font-size: 1.3rem;
        color: #1f2937;
        margin-bottom: 8px;
        font-weight: 700;
      }
      
      .survey-header p {
        color: #6b7280;
        font-size: 0.9rem;
      }
      
      .survey-question {
        margin-bottom: 20px;
      }
      
      .survey-question label {
        display: block;
        font-weight: 600;
        color: #374151;
        margin-bottom: 10px;
        font-size: 0.9rem;
      }
      
      .survey-options {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      
      .survey-option {
        display: flex;
        align-items: center;
        padding: 10px 12px;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 0.85rem;
      }
      
      .survey-option:hover {
        border-color: #fbbf24;
        background: #fef3c7;
      }
      
      .survey-option input[type="radio"] {
        margin-right: 8px;
        cursor: pointer;
      }
      
      .survey-option input[type="radio"]:checked + span {
        font-weight: 600;
        color: #d97706;
      }
      
      .survey-question textarea {
        width: 100%;
        padding: 10px;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        resize: vertical;
        font-family: inherit;
        font-size: 0.85rem;
      }
      
      .survey-question textarea:focus {
        outline: none;
        border-color: #fbbf24;
      }
      
      .survey-buttons {
        display: flex;
        gap: 10px;
        margin-top: 20px;
      }
      
      .survey-skip {
        flex: 1;
        padding: 12px;
        background: #f3f4f6;
        color: #6b7280;
        border: none;
        border-radius: 8px;
        font-size: 0.9rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
      }
      
      .survey-skip:hover {
        background: #e5e7eb;
        color: #374151;
      }
      
      .survey-submit {
        flex: 2;
        padding: 12px;
        background: linear-gradient(135deg, #fbbf24, #f59e0b);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 0.9rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
      }
      
      .survey-submit:hover {
        background: linear-gradient(135deg, #f59e0b, #d97706);
        transform: translateY(-1px);
        box-shadow: 0 6px 15px rgba(245, 158, 11, 0.3);
      }
      
      .survey-thanks {
        text-align: center;
        padding: 40px 20px;
        background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
        border-radius: 12px;
        animation: thanksFadeIn 0.6s ease-out;
      }
      
      @keyframes thanksFadeIn {
        from {
          opacity: 0;
          transform: scale(0.9);
        }
        to {
          opacity: 1;
          transform: scale(1);
        }
      }
      
      .thanks-icon {
        font-size: 4rem;
        margin-bottom: 20px;
        animation: thanksIconBounce 1s ease-out;
      }
      
      @keyframes thanksIconBounce {
        0%, 20%, 50%, 80%, 100% {
          transform: translateY(0);
        }
        40% {
          transform: translateY(-10px);
        }
        60% {
          transform: translateY(-5px);
        }
      }
      
      .survey-thanks h3 {
        font-size: 1.5rem;
        color: #0f172a;
        margin-bottom: 16px;
        font-weight: 700;
      }
      
      .survey-thanks p {
        color: #475569;
        font-size: 1rem;
        line-height: 1.6;
        margin-bottom: 20px;
      }
      
      .thanks-message {
        background: rgba(59, 130, 246, 0.1);
        padding: 16px;
        border-radius: 8px;
        border-left: 4px solid #3b82f6;
      }
      
      .thanks-message p {
        color: #1e40af;
        font-weight: 600;
        margin: 0;
        font-size: 1.1rem;
      }
      
      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }
      
      @media (max-width: 768px) {
        .rating-widget {
          bottom: 15px;
          right: 15px;
          padding: 8px 12px;
          max-width: 200px;
        }
        
        .rating-text {
          font-size: 12px;
        }
        
        .star {
          font-size: 20px;
        }
        
        .survey-popup {
          padding: 20px;
          margin: 20px;
        }
        
        .test-reset-button {
          top: 10px;
          right: 10px;
        }
        
        .test-reset-button button {
          padding: 8px 12px;
          font-size: 12px;
        }
      }
      
      @media (max-width: 480px) {
        .rating-widget {
          bottom: 10px;
          right: 10px;
          padding: 6px 10px;
          max-width: 180px;
        }
        
        .rating-text {
          font-size: 11px;
        }
        
        .star {
          font-size: 18px;
        }
        
        .survey-popup {
          padding: 15px;
        }
      }
    </style>
    
    <script>
      // æ˜Ÿè©•ä¾¡ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆ
      function setRating(rating) {
        // æ˜Ÿã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
        const stars = document.querySelectorAll('.star');
        stars.forEach((star, index) => {
          if (index < rating) {
            star.style.color = '#FFD700';
            star.style.transform = 'scale(1.5) rotate(360deg)';
            setTimeout(() => {
              star.style.transform = 'scale(1.2)';
            }, 300);
          }
        });
        
        // è©•ä¾¡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        const messages = [
          'è²´é‡ãªã”æ„è¦‹ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼',
          'ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼',
          'ã”è©•ä¾¡ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼',
          'ç´ æ™´ã‚‰ã—ã„è©•ä¾¡ã‚’ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼',
          'æœ€é«˜è©•ä¾¡ã‚’ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼ğŸ‰'
        ];
        
        // ã‚«ã‚¹ã‚¿ãƒ ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥
        showToast(messages[rating - 1]);
        
        // è©•ä¾¡ã‚’LocalStorageã«ä¿å­˜ï¼ˆå³åº§ã«ä¿å­˜ï¼‰
        localStorage.setItem('collegeSparkRating', rating.toString());
        localStorage.setItem('collegeSparkRatingDate', new Date().toISOString());
        console.log('Rating saved to localStorage:', rating);
        
        // LocalStorageã¸ã®ä¿å­˜ã‚’ç¢ºèª
        const savedRating = localStorage.getItem('collegeSparkRating');
        console.log('Confirmed saved rating:', savedRating);
        
        // ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆã‚’ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ
        const widget = document.getElementById('ratingWidget');
        widget.style.animation = 'fadeOut 0.5s ease-out forwards';
        
        setTimeout(() => {
          widget.classList.add('hidden');
          widget.style.display = 'none';
          console.log('Widget hidden after rating');
          // è©³ç´°ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã‚’è¡¨ç¤º
          document.getElementById('detailedSurvey').style.display = 'flex';
          document.body.style.overflow = 'hidden';
        }, 500);
      }
      
      // ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ã‚’è¡¨ç¤º
      function showToast(message) {
        const toast = document.createElement('div');
        toast.className = 'toast-notification';
        toast.textContent = message;
        document.body.appendChild(toast);
        
        setTimeout(() => {
          toast.classList.add('show');
        }, 100);
        
        setTimeout(() => {
          toast.classList.remove('show');
          setTimeout(() => toast.remove(), 300);
        }, 3000);
      }
      
      // ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆã‚’é–‰ã˜ã‚‹
      function closeSurveyWidget() {
        // å³åº§ã«LocalStorageã«ä¿å­˜
        localStorage.setItem('collegeSparkSurveyClosed', 'true');
        console.log('Survey closed flag saved to localStorage');
        
        const widget = document.getElementById('ratingWidget');
        widget.style.animation = 'fadeOut 0.3s ease-out forwards';
        setTimeout(() => {
          widget.classList.add('hidden');
          widget.style.display = 'none';
          console.log('Widget closed by user');
        }, 300);
        
        // LocalStorageã¸ã®ä¿å­˜ã‚’ç¢ºèª
        const savedClosed = localStorage.getItem('collegeSparkSurveyClosed');
        console.log('Confirmed survey closed flag:', savedClosed);
      }
      
      // è©³ç´°ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã‚’é–‰ã˜ã‚‹
      function closeDetailedSurvey() {
        const currentStatus = localStorage.getItem('collegeSparkDetailedSurvey');
        
        document.getElementById('detailedSurvey').style.display = 'none';
        document.body.style.overflow = '';
        
        // ã¾ã å›ç­”ã—ã¦ã„ãªã„å ´åˆï¼ˆã‚¹ã‚­ãƒƒãƒ—ã®å ´åˆï¼‰
        if (!currentStatus || currentStatus === 'skipped') {
          localStorage.setItem('collegeSparkDetailedSurvey', 'skipped');
          showToast('ğŸ’­ ãŠæ™‚é–“ã‚’ã„ãŸã ãã€ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸï¼');
        }
      }
      
      // ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆé–¢é€£ã®LocalStorageãƒ‡ãƒ¼ã‚¿ã®ã¿ã‚’å‰Šé™¤ï¼ˆé–‹ç™ºãƒ»ãƒ†ã‚¹ãƒˆç”¨ï¼‰
      function clearSurveyData() {
        console.log('Clearing all survey data...');
        localStorage.removeItem('collegeSparkRating');
        localStorage.removeItem('collegeSparkRatingDate');
        localStorage.removeItem('collegeSparkSurveyClosed');
        localStorage.removeItem('collegeSparkDetailedSurvey');
        localStorage.removeItem('collegeSparkDetailedSurveyData');
        
        // ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆã‚’å³åº§ã«è¡¨ç¤º
        const widget = document.getElementById('ratingWidget');
        widget.classList.remove('hidden');
        widget.style.display = 'block';
        
        console.log('Survey data cleared and widget restored.');
      }
      
      // å¼·åˆ¶çš„ã«ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆã‚’è¡¨ç¤ºï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
      function forceShowWidget() {
        let widget = document.getElementById('ratingWidget');
        
        if (!widget) {
          console.log('Widget not found, creating new one...');
          // ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆ
          const widgetHTML = `
            <div id="ratingWidget" class="rating-widget" style="display: block;">
              <button class="widget-close" onclick="closeSurveyWidget()">&times;</button>
              <div class="rating-content">
                <div class="emoji-icon">ğŸ†</div>
                <p class="rating-text">âœ¨ ã”æ„è¦‹ã‚’ãŠèã‹ã›ãã ã•ã„ï¼</p>
                <div class="star-rating">
                  <span class="star" onclick="setRating(1)">â­</span>
                  <span class="star" onclick="setRating(2)">â­</span>
                  <span class="star" onclick="setRating(3)">â­</span>
                  <span class="star" onclick="setRating(4)">â­</span>
                  <span class="star" onclick="setRating(5)">â­</span>
                </div>
                <p class="rating-subtext">ã‚µãƒ¼ãƒ“ã‚¹æ”¹å–„ã«ã”å”åŠ›ãã ã•ã„ ğŸš€</p>
              </div>
            </div>
          `;
          document.body.insertAdjacentHTML('beforeend', widgetHTML);
          widget = document.getElementById('ratingWidget');
        } else {
          // æ—¢å­˜ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆã‚’è¡¨ç¤º
          widget.style.display = 'block';
          widget.classList.remove('hidden');
        }
        
        // ãƒ›ãƒãƒ¼ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’è¨­å®š
        setupStarHoverEffects();
        
        showToast('ğŸ‘ï¸ ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã‚’å¼·åˆ¶è¡¨ç¤ºã—ã¾ã—ãŸ');
        console.log('âœ… Widget forced to show');
      }
      
      // å¼·åˆ¶çš„ã«ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆã‚’éè¡¨ç¤ºï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
      function forceHideWidget() {
        const widget = document.getElementById('ratingWidget');
        widget.classList.add('hidden');
        widget.classList.remove('show');
        console.log('Widget forced to hide');
      }
      
      // ãƒ‡ãƒãƒƒã‚°ç”¨ï¼šãªãœã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆãŒè¡¨ç¤ºã•ã‚Œãªã„ã‹ã‚’è©³ã—ãèª¿ã¹ã‚‹
      function debugWidgetVisibility() {
        console.log('ğŸ” === WIDGET VISIBILITY DEBUG ===');
        
        const widget = document.getElementById('ratingWidget');
        console.log('Widget element exists:', !!widget);
        
        if (widget) {
          console.log('Widget display style:', widget.style.display);
          console.log('Widget computed display:', window.getComputedStyle(widget).display);
          console.log('Widget classes:', widget.className);
        }
        
        const status = checkSurveyStatus();
        const hasRated = status.rating !== null && status.rating !== '';
        const wasClosedByUser = status.surveyClosed === 'true';
        
        console.log('ğŸ¯ Visibility Decision:');
        console.log('- Has rated (should hide):', hasRated);
        console.log('- Was closed by user (should hide):', wasClosedByUser);
        console.log('- Should be visible:', !hasRated && !wasClosedByUser);
        
        return {
          widgetExists: !!widget,
          shouldBeVisible: !hasRated && !wasClosedByUser,
          actuallyVisible: widget ? window.getComputedStyle(widget).display !== 'none' : false
        };
      }
      
      // åˆæœŸåŒ–å‡¦ç†ã‚’ç‹¬ç«‹ã—ãŸé–¢æ•°ã¨ã—ã¦å®šç¾©
      function initializeSurveyWidget() {
        console.log('ğŸ” Initializing survey widget...');
        
        // LocalStorageã®çŠ¶æ…‹ã‚’ç¢ºèª
        const status = checkSurveyStatus();
        
        // è©•ä¾¡æ¸ˆã¿ã¾ãŸã¯æ˜ç¤ºçš„ã«é–‰ã˜ã‚‰ã‚ŒãŸå ´åˆã®ã¿éè¡¨ç¤º
        const hasRated = status.rating !== null && status.rating !== '';
        const wasClosedByUser = status.surveyClosed === 'true';
        
        // è©³ç´°ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã®ã‚¹ã‚­ãƒƒãƒ—ã¯æ˜Ÿè©•ä¾¡ã¨ã¯ç„¡é–¢ä¿‚ãªã®ã§é™¤å¤–
        const widget = document.getElementById('ratingWidget');
        
        console.log('=== Widget Display Logic ===');
        console.log('Widget element found:', !!widget);
        console.log('Rating value:', status.rating);
        console.log('Survey closed by user:', status.surveyClosed);
        console.log('Has rated:', hasRated);
        console.log('Was closed by user:', wasClosedByUser);
        console.log('Widget should be hidden:', hasRated || wasClosedByUser);
        
        if (!widget) {
          console.error('âŒ Widget element not found!');
          return false;
        }
        
        // è©•ä¾¡æ¸ˆã¿ã¾ãŸã¯æ˜ç¤ºçš„ã«é–‰ã˜ã‚‰ã‚ŒãŸå ´åˆã®ã¿éè¡¨ç¤º
        if (hasRated || wasClosedByUser) {
          console.log('âŒ Hiding widget permanently...');
          widget.style.display = 'none';
          return false; // ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆã¯è¡¨ç¤ºã•ã‚Œãªã„
        }
        
        console.log('âœ… Showing widget (not rated and not closed by user)...');
        widget.style.display = 'block';
        widget.classList.remove('hidden');
        widget.classList.add('show');
        
        // å¼·åˆ¶çš„ã«ã‚¹ã‚¿ã‚¤ãƒ«ã‚’å†é©ç”¨
        widget.style.background = 'linear-gradient(135deg, rgba(255, 146, 36, 0.7) 0%, rgba(255, 122, 0, 0.7) 100%)';
        
        console.log('âœ… Widget display set to block');
        
        // æ˜Ÿã®ãƒ›ãƒãƒ¼ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’è¨­å®š
        setupStarHoverEffects();
        
        // è©³ç´°ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ãƒ ã®å‡¦ç†ã‚‚è¨­å®š
        setupDetailedSurveyForm();
        
        return true; // ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆãŒè¡¨ç¤ºã•ã‚ŒãŸ
      }
      
      // æ˜Ÿã®ãƒ›ãƒãƒ¼ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’è¨­å®šã™ã‚‹é–¢æ•°
      function setupStarHoverEffects() {
        const stars = document.querySelectorAll('.star');
        stars.forEach((star, index) => {
          star.addEventListener('mouseenter', function() {
            stars.forEach((s, i) => {
              if (i <= index) {
                s.style.color = '#FFD700';
                s.style.opacity = '1';
              } else {
                s.style.color = '';
                s.style.opacity = '0.7';
              }
            });
          });
        });
        
        // ãƒã‚¦ã‚¹ãŒé›¢ã‚ŒãŸã‚‰å…ƒã«æˆ»ã™
        document.querySelector('.star-rating').addEventListener('mouseleave', function() {
          stars.forEach(star => {
            star.style.color = '';
            star.style.opacity = '0.7';
          });
        });
      }
      
      // è©³ç´°ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ãƒ ã®å‡¦ç†ã‚’è¨­å®šã™ã‚‹é–¢æ•°
      function setupDetailedSurveyForm() {
        const detailedForm = document.getElementById('detailedSurveyForm');
        
        // æ—¢ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
        if (detailedForm.dataset.listenerAdded === 'true') {
          console.log('ğŸ“‹ Detailed survey form listener already added, skipping...');
          return;
        }
        
        console.log('ğŸ“‹ Setting up detailed survey form...');
        
        detailedForm.addEventListener('submit', function(e) {
          e.preventDefault();
          console.log('ğŸ“‹ Detailed survey form submitted');
          
          const formData = new FormData(detailedForm);
          const data = {
            purpose: formData.get('purpose'),
            feedback: formData.get('feedback'),
            rating: localStorage.getItem('collegeSparkRating'),
            timestamp: new Date().toISOString()
          };
          
          // ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡
          fetch('/surveys', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
            },
            body: JSON.stringify(data)
          })
          .then(response => response.json())
          .then(result => {
            if (result.status === 'success') {
              localStorage.setItem('collegeSparkDetailedSurvey', 'completed');
              console.log('ğŸ“‹ Survey data saved successfully');
            } else {
              console.error('ğŸ“‹ Survey save failed:', result.message);
              localStorage.setItem('collegeSparkDetailedSurvey', 'completed');
            }
          })
          .catch(error => {
            console.error('ğŸ“‹ Survey submission error:', error);
            localStorage.setItem('collegeSparkDetailedSurveyData', JSON.stringify(data));
            localStorage.setItem('collegeSparkDetailedSurvey', 'completed');
          });
          
          // ãŠç¤¼ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ã‚’è¡¨ç¤º
          showToast('ğŸ‰ è©³ç´°ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã«ã”å›ç­”ã„ãŸã ãã€ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸï¼');
          
          // Thank youãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
          console.log('ğŸ“‹ Showing thank you message...');
          detailedForm.style.display = 'none';
          document.querySelector('.survey-header').style.display = 'none';
          document.querySelector('.survey-thanks').style.display = 'block';
          
          // ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆå®Œäº†ã‚’ãƒãƒ¼ã‚¯
          localStorage.setItem('collegeSparkDetailedSurvey', 'completed');
          
          // 6ç§’å¾Œã«è‡ªå‹•çš„ã«é–‰ã˜ã‚‹
          setTimeout(() => {
            closeDetailedSurvey();
            showToast('âœ¨ è²´é‡ãªã”æ„è¦‹ã‚’ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸï¼');
          }, 6000);
        });
        
        // ãƒªã‚¹ãƒŠãƒ¼ãŒè¿½åŠ ã•ã‚ŒãŸã“ã¨ã‚’ãƒãƒ¼ã‚¯
        detailedForm.dataset.listenerAdded = 'true';
        console.log('ğŸ“‹ Detailed survey form setup complete');
        
        // èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§è©³ç´°ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã‚’é–‰ã˜ã‚‹å‡¦ç†ã‚‚è¨­å®š
        const detailedSurvey = document.getElementById('detailedSurvey');
        if (detailedSurvey.dataset.backgroundListenerAdded !== 'true') {
          detailedSurvey.addEventListener('click', function(e) {
            if (e.target === this) {
              closeDetailedSurvey();
            }
          });
          detailedSurvey.dataset.backgroundListenerAdded = 'true';
        }
      }
      
      // ãƒ†ã‚¹ãƒˆç”¨ãƒªã‚»ãƒƒãƒˆæ©Ÿèƒ½ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ãƒœã‚¿ãƒ³ç”¨ï¼‰
      function resetSurveyForTesting() {
        console.log('ğŸ”„ Testing: Resetting survey data...');
        
        // æ—¢å­˜ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆã‚’å‰Šé™¤
        const existingWidget = document.getElementById('ratingWidget');
        if (existingWidget) {
          existingWidget.remove();
          console.log('ğŸ—‘ï¸ Removed existing widget');
        }
        
        // è©³ç´°ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã‚‚é–‰ã˜ã‚‹
        const detailedSurvey = document.getElementById('detailedSurvey');
        if (detailedSurvey) {
          detailedSurvey.style.display = 'none';
          document.body.style.overflow = '';
        }
        
        // LocalStorageã‚’å®Œå…¨ã«ã‚¯ãƒªã‚¢
        const keysToRemove = [
          'collegeSparkRating',
          'collegeSparkRatingDate', 
          'collegeSparkSurveyClosed',
          'collegeSparkDetailedSurvey',
          'collegeSparkDetailedSurveyData'
        ];
        
        keysToRemove.forEach(key => {
          localStorage.removeItem(key);
          console.log(`ğŸ§¹ Removed: ${key}`);
        });
        
        // åˆæœŸåŒ–ãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆ
        window.surveyWidgetInitialized = false;
        
        // æ–°ã—ã„ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆã‚’ä½œæˆ
        const widgetHTML = `
          <div id="ratingWidget" class="rating-widget" style="display: none; background: linear-gradient(135deg, rgba(255, 146, 36, 0.7) 0%, rgba(255, 122, 0, 0.7) 100%);">
            <button class="widget-close" onclick="closeSurveyWidget()">&times;</button>
            <div class="rating-content">
              <div class="emoji-icon">ğŸ†</div>
              <p class="rating-text">âœ¨ ã”æ„è¦‹ã‚’ãŠèã‹ã›ãã ã•ã„ï¼</p>
              <div class="star-rating">
                <span class="star" onclick="setRating(1)">â­</span>
                <span class="star" onclick="setRating(2)">â­</span>
                <span class="star" onclick="setRating(3)">â­</span>
                <span class="star" onclick="setRating(4)">â­</span>
                <span class="star" onclick="setRating(5)">â­</span>
              </div>
              <p class="rating-subtext">ã‚µãƒ¼ãƒ“ã‚¹æ”¹å–„ã«ã”å”åŠ›ãã ã•ã„ ğŸš€</p>
            </div>
          </div>
        `;
        
        // HTMLã‚’æŒ¿å…¥
        document.body.insertAdjacentHTML('beforeend', widgetHTML);
        console.log('âœ¨ Created new widget');
        
        // å°‘ã—å¾…ã£ã¦ã‹ã‚‰åˆæœŸåŒ–å‡¦ç†ã‚’å®Ÿè¡Œ
        setTimeout(() => {
          const widgetShown = initializeSurveyWidget();
          
          // ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥
          if (widgetShown) {
            showToast('ğŸ”„ ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã—ãŸï¼');
          } else {
            showToast('âŒ ãƒªã‚»ãƒƒãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ');
          }
          
          console.log('âœ… Survey reset complete - widget restored:', widgetShown);
        }, 100);
      }
      
      // LocalStorageã®å…¨çŠ¶æ…‹ã‚’ç¢ºèª
      function checkSurveyStatus() {
        const status = {
          rating: localStorage.getItem('collegeSparkRating'),
          ratingDate: localStorage.getItem('collegeSparkRatingDate'),
          surveyClosed: localStorage.getItem('collegeSparkSurveyClosed'),
          detailedSurvey: localStorage.getItem('collegeSparkDetailedSurvey'),
          detailedSurveyData: localStorage.getItem('collegeSparkDetailedSurveyData')
        };
        console.log('=== Survey LocalStorage Status ===');
        console.log('Rating:', status.rating);
        console.log('Rating Date:', status.ratingDate);
        console.log('Survey Closed:', status.surveyClosed);
        console.log('Detailed Survey:', status.detailedSurvey);
        console.log('Detailed Survey Data:', status.detailedSurveyData);
        
        // å€¤ã®è©³ç´°åˆ†æ
        console.log('--- Value Analysis ---');
        console.log('rating !== null:', status.rating !== null);
        console.log('rating !== "":', status.rating !== '');
        console.log('surveyClosed === "true":', status.surveyClosed === 'true');
        
        return status;
      }
      
      // åˆæœŸåŒ–ãƒ•ãƒ©ã‚°
      window.surveyWidgetInitialized = false;
      
      // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®å‡¦ç†
      function initializeOnLoad() {
        console.log('ğŸ“„ Starting initialization...');
        const result = initializeSurveyWidget();
        console.log('ğŸ“„ Initialization result:', result);
        return result;
      }
      
      // è¤‡æ•°ã®æ–¹æ³•ã§åˆæœŸåŒ–ã‚’è©¦è¡Œ
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeOnLoad);
      } else {
        // DOM already loaded
        console.log('ğŸ“„ DOM already loaded, initializing immediately...');
        initializeOnLoad();
      }
      
      // è¿½åŠ ã®å®‰å…¨ç­–ï¼šwindowã®loadã‚¤ãƒ™ãƒ³ãƒˆã§ã‚‚å®Ÿè¡Œ
      window.addEventListener('load', function() {
        console.log('ğŸ“„ Window load event - checking if widget is visible...');
        const widget = document.getElementById('ratingWidget');
        if (widget && window.getComputedStyle(widget).display === 'none') {
          console.log('ğŸ“„ Widget still hidden, re-initializing...');
          initializeOnLoad();
        }
      });
      
      // ã•ã‚‰ãªã‚‹å®‰å…¨ç­–ï¼šã‚¿ã‚¤ãƒãƒ¼ã§ãƒã‚§ãƒƒã‚¯
      setTimeout(() => {
        const widget = document.getElementById('ratingWidget');
        if (widget && window.getComputedStyle(widget).display === 'none') {
          const status = checkSurveyStatus();
          const hasRated = status.rating !== null && status.rating !== '';
          const wasClosedByUser = status.surveyClosed === 'true';
          
          if (!hasRated && !wasClosedByUser) {
            console.log('â° Timer check: Widget should be visible but is hidden, forcing display...');
            widget.style.display = 'block';
          }
        }
      }, 1000);
      
      // å¤ã„DOMContentLoadedãƒªã‚¹ãƒŠãƒ¼ã¯å‰Šé™¤æ¸ˆã¿
    </script>
  </body>
</html>
