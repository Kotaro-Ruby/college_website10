<% content_for :title, "アメリカ州別大学ガイド | 50州の特徴・気候・生活費を比較 - College Spark" %>
<% content_for :description, "アメリカ各州の特色、気候、生活費、主要大学を詳しく紹介。カリフォルニア、ニューヨーク、テキサスなど人気州から大学を探そう。留学先選択に役立つ情報を網羅。" %>
<% content_for :keywords, "アメリカ 州 大学, アメリカ留学 州選び, カリフォルニア 大学, ニューヨーク 大学, アメリカ 生活費 比較" %>

<div class="main">
  <div class="professional-info-container">
    <!-- Hero Section -->
    <section class="hero-section">
      <div class="hero-content">
        <h1 class="hero-title">州別大学ガイド</h1>
        <p class="hero-subtitle">State-by-State College Guide</p>
        <div class="hero-divider"></div>
      </div>
    </section>

    <!-- Intro Section -->
    <section class="section-wrapper">
      <div class="section-content">
        <div class="intro-card">
          <p>
            アメリカ留学では、大学選びと同じくらい<strong>「どの州で学ぶか」</strong>が重要です。
            気候、生活費、文化、就職機会など、州によって大きく異なる特色があります。
            各州の詳細情報と主要大学をチェックして、理想的な留学先を見つけましょう。
          </p>
        </div>
      </div>
    </section>

    <!-- Interactive Map Section -->
    <section class="section-wrapper map-section-bg">
      <div class="section-content">
        <div class="map-card">
          <h2>地図から州を選択</h2>
          <p class="map-subtitle">Click on a State to Learn More</p>
          <div class="map-container">
            <div class="map-wrapper" id="us-map-wrapper">
              <!-- SVG will be loaded here -->
            </div>
            <div class="map-tooltip" id="map-tooltip"></div>
          </div>
          <p class="map-hint">州をクリックすると詳細ページへ移動します</p>
          <div class="mobile-state-panel" id="mobile-state-panel">
            <span class="mobile-state-name">
              <span id="mobile-state-name-text"></span>
              <span class="mobile-state-code" id="mobile-state-code-text"></span>
            </span>
            <a href="#" class="mobile-state-link" id="mobile-state-link">
              詳細を見る <i class="fas fa-arrow-right"></i>
            </a>
          </div>
        </div>
      </div>
    </section>

    <!-- States Grid Section -->
    <section class="section-wrapper">
      <div class="section-content-wide">
        <div class="states-header">
          <h2>全50州一覧</h2>
          <p class="states-subtitle">Browse All States</p>
          <div class="states-search">
            <input type="text" id="state-search-input" placeholder="州名で検索...">
            <i class="fas fa-search"></i>
          </div>
        </div>

        <div class="states-grid" id="states-grid">
          <% @states.each do |state| %>
            <%= link_to state_detail_path(state[:code].downcase), class: "state-card", data: { name: state[:name], code: state[:code] } do %>
              <span class="state-code"><%= state[:code] %></span>
              <h3><%= state[:name] %></h3>
              <p class="college-count"><%= state[:college_count] %>校</p>
            <% end %>
          <% end %>
        </div>
      </div>
    </section>

  </div>
</div>

<style>
/* Container */
.professional-info-container {
  max-width: 100%;
  margin: 0;
  padding: 0;
  background: #ffffff;
}

/* Hero Section */
.hero-section {
  background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
  padding: 80px 20px;
  text-align: center;
  color: white;
}

.hero-content {
  max-width: 800px;
  margin: 0 auto;
}

.hero-title {
  font-size: 48px;
  font-weight: 700;
  margin-bottom: 10px;
  letter-spacing: -0.5px;
}

.hero-subtitle {
  font-size: 18px;
  font-weight: 300;
  opacity: 0.8;
  letter-spacing: 2px;
  text-transform: uppercase;
}

.hero-divider {
  width: 60px;
  height: 3px;
  background: rgb(240, 177, 61);
  margin: 30px auto 0;
}

/* Section Wrapper */
.section-wrapper {
  padding: 50px 20px;
}

.section-content {
  max-width: 900px;
  margin: 0 auto;
}

.map-section-bg {
  background: #f5f5f5;
}

/* Intro Card */
.intro-card {
  max-width: 700px;
  margin: 0 auto;
  text-align: center;
}

.intro-card p {
  font-size: 16px;
  line-height: 1.9;
  color: #555;
  margin: 0;
}

.intro-card strong {
  color: rgb(200, 140, 40);
  font-weight: 600;
}

/* Map Card */
.map-card {
  background: white;
  padding: 40px;
  border-radius: 8px;
  border: 1px solid #e5e5e5;
}

.map-card h2 {
  font-size: 24px;
  font-weight: 700;
  color: #1a1a1a;
  margin: 0 0 8px 0;
  text-align: center;
}

.map-subtitle {
  font-size: 14px;
  color: #999;
  text-align: center;
  margin: 0 0 30px 0;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.map-container {
  position: relative;
  max-width: 500px;
  margin: 0 auto;
}

.map-wrapper {
  width: 100%;
  aspect-ratio: 1.4 / 1;
}

.map-wrapper svg {
  width: 100%;
  height: 100%;
}

.map-wrapper svg path {
  fill: #e5e5e5;
  stroke: #fff;
  stroke-width: 1.5;
  cursor: pointer;
  transition: fill 0.2s ease;
}

.map-wrapper svg path:hover {
  fill: rgb(240, 177, 61);
  stroke: rgb(200, 140, 40);
}

.map-tooltip {
  position: absolute;
  background: #1a1a1a;
  color: white;
  padding: 8px 14px;
  border-radius: 4px;
  font-size: 14px;
  font-weight: 500;
  pointer-events: none;
  opacity: 0;
  transition: opacity 0.2s ease;
  z-index: 100;
  white-space: nowrap;
}

.map-tooltip::after {
  content: '';
  position: absolute;
  top: 100%;
  left: 50%;
  transform: translateX(-50%);
  border: 6px solid transparent;
  border-top-color: #1a1a1a;
}

.map-hint {
  text-align: center;
  color: #999;
  font-size: 13px;
  margin: 25px 0 0 0;
}

/* Mobile State Info Panel */
.mobile-state-panel {
  display: none;
  background: #1a1a1a;
  border-radius: 8px;
  padding: 16px 20px;
  margin-top: 20px;
  align-items: center;
  justify-content: space-between;
  gap: 15px;
}

.mobile-state-panel.visible {
  display: flex;
}

.mobile-state-name {
  color: white;
  font-size: 16px;
  font-weight: 600;
}

.mobile-state-code {
  color: rgb(240, 177, 61);
  font-weight: 700;
  margin-left: 8px;
}

.mobile-state-link {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  background: rgb(240, 177, 61);
  color: #1a1a1a;
  padding: 10px 18px;
  border-radius: 6px;
  text-decoration: none;
  font-size: 14px;
  font-weight: 600;
  white-space: nowrap;
}

.mobile-state-link:hover {
  background: rgb(220, 160, 50);
}

@media (max-width: 768px) {
  .map-tooltip {
    display: none !important;
  }
}

/* States Header */
.states-header {
  text-align: center;
  margin-bottom: 40px;
}

.states-header h2 {
  font-size: 28px;
  font-weight: 700;
  color: #1a1a1a;
  margin: 0 0 8px 0;
}

.states-subtitle {
  font-size: 14px;
  color: #999;
  margin: 0;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.states-search {
  position: relative;
  max-width: 300px;
  margin: 25px auto 0;
}

.states-search input {
  width: 100%;
  padding: 14px 20px 14px 45px;
  border: 1px solid #e5e5e5;
  border-radius: 8px;
  font-size: 15px;
  color: #1a1a1a;
  transition: all 0.2s;
}

.states-search input:focus {
  outline: none;
  border-color: rgb(200, 140, 40);
  box-shadow: 0 0 0 3px rgba(200, 140, 40, 0.1);
}

.states-search input::placeholder {
  color: #999;
}

.states-search i {
  position: absolute;
  left: 16px;
  top: 50%;
  transform: translateY(-50%);
  color: rgb(200, 140, 40);
  font-size: 14px;
}

.state-card.hidden {
  display: none;
}

.no-results {
  grid-column: 1 / -1;
  text-align: center;
  padding: 40px 20px;
  color: #999;
  font-size: 15px;
}

.section-content-wide {
  max-width: 1100px;
  margin: 0 auto;
}

/* States Grid */
.states-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
  gap: 16px;
}

.state-card {
  display: block;
  background: #fafafa;
  border-radius: 6px;
  padding: 20px;
  text-decoration: none;
  text-align: center;
  transition: all 0.15s ease;
}

.state-card:hover {
  background: rgb(240, 177, 61);
}

.state-card .state-code {
  display: block;
  font-size: 13px;
  font-weight: 700;
  color: rgb(200, 140, 40);
  margin-bottom: 8px;
  letter-spacing: 1px;
}

.state-card:hover .state-code {
  color: #1a1a1a;
}

.state-card h3 {
  font-size: 15px;
  font-weight: 600;
  color: #1a1a1a;
  margin: 0 0 6px 0;
}

.state-card:hover h3 {
  color: #1a1a1a;
}

.state-card .college-count {
  font-size: 12px;
  color: #999;
  margin: 0;
}

.state-card:hover .college-count {
  color: rgba(0, 0, 0, 0.6);
}

/* Responsive */
@media (max-width: 768px) {
  .hero-title {
    font-size: 36px;
  }

  .section-wrapper {
    padding: 40px 15px;
  }

  .map-card {
    padding: 25px 15px;
  }

  .states-grid {
    grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
    gap: 12px;
  }

  .state-card {
    padding: 16px;
  }
}

@media (max-width: 480px) {
  .hero-section {
    padding: 60px 15px;
  }

  .hero-title {
    font-size: 30px;
  }

  .states-grid {
    grid-template-columns: repeat(2, 1fr);
  }
}
</style>

<script>
function initUSMap() {
  const stateNames = {
    'al': 'アラバマ', 'ak': 'アラスカ', 'az': 'アリゾナ', 'ar': 'アーカンソー',
    'ca': 'カリフォルニア', 'co': 'コロラド', 'ct': 'コネチカット', 'de': 'デラウェア',
    'fl': 'フロリダ', 'ga': 'ジョージア', 'hi': 'ハワイ', 'id': 'アイダホ',
    'il': 'イリノイ', 'in': 'インディアナ', 'ia': 'アイオワ', 'ks': 'カンザス',
    'ky': 'ケンタッキー', 'la': 'ルイジアナ', 'me': 'メイン', 'md': 'メリーランド',
    'ma': 'マサチューセッツ', 'mi': 'ミシガン', 'mn': 'ミネソタ', 'ms': 'ミシシッピ',
    'mo': 'ミズーリ', 'mt': 'モンタナ', 'ne': 'ネブラスカ', 'nv': 'ネバダ',
    'nh': 'ニューハンプシャー', 'nj': 'ニュージャージー', 'nm': 'ニューメキシコ',
    'ny': 'ニューヨーク', 'nc': 'ノースカロライナ', 'nd': 'ノースダコタ',
    'oh': 'オハイオ', 'ok': 'オクラホマ', 'or': 'オレゴン', 'pa': 'ペンシルベニア',
    'ri': 'ロードアイランド', 'sc': 'サウスカロライナ', 'sd': 'サウスダコタ',
    'tn': 'テネシー', 'tx': 'テキサス', 'ut': 'ユタ', 'vt': 'バーモント',
    'va': 'バージニア', 'wa': 'ワシントン', 'wv': 'ウェストバージニア',
    'wi': 'ウィスコンシン', 'wy': 'ワイオミング', 'dc': 'ワシントンD.C.'
  };

  // モバイル判定
  const isMobile = window.matchMedia('(max-width: 768px)').matches;

  fetch('/us-map.svg')
    .then(response => response.text())
    .then(svgContent => {
      const wrapper = document.getElementById('us-map-wrapper');
      wrapper.innerHTML = svgContent;

      const tooltip = document.getElementById('map-tooltip');
      const mobilePanel = document.getElementById('mobile-state-panel');
      const mobileNameText = document.getElementById('mobile-state-name-text');
      const mobileCodeText = document.getElementById('mobile-state-code-text');
      const mobileLink = document.getElementById('mobile-state-link');
      const paths = wrapper.querySelectorAll('path[id]');

      let selectedPath = null;

      paths.forEach(path => {
        const stateCode = path.id.toLowerCase();
        const stateName = stateNames[stateCode];

        if (stateName) {
          if (isMobile) {
            // モバイル: タップで選択、パネルに表示
            path.addEventListener('click', function(e) {
              e.preventDefault();

              // 前の選択を解除
              if (selectedPath) {
                selectedPath.style.fill = '';
              }

              // 新しい選択
              selectedPath = path;
              path.style.fill = 'rgb(240, 177, 61)';

              // パネルを更新
              mobileNameText.textContent = stateName;
              mobileCodeText.textContent = stateCode.toUpperCase();
              mobileLink.href = '/states/' + stateCode;
              mobilePanel.classList.add('visible');
            });
          } else {
            // デスクトップ: ホバーでツールチップ、クリックで遷移
            path.addEventListener('mouseenter', function(e) {
              tooltip.textContent = stateName + ' (' + stateCode.toUpperCase() + ')';
              tooltip.style.opacity = '1';
            });

            path.addEventListener('mousemove', function(e) {
              const rect = wrapper.getBoundingClientRect();
              tooltip.style.left = (e.clientX - rect.left) + 'px';
              tooltip.style.top = (e.clientY - rect.top - 45) + 'px';
            });

            path.addEventListener('mouseleave', function() {
              tooltip.style.opacity = '0';
            });

            path.addEventListener('click', function() {
              window.location.href = '/states/' + stateCode;
            });
          }
        }
      });
    })
    .catch(error => {
      console.error('Failed to load map:', error);
      document.getElementById('us-map-wrapper').innerHTML =
        '<p style="text-align:center;color:#999;padding:40px;">地図の読み込みに失敗しました</p>';
    });
}

// 州検索機能
function initStateSearch() {
  const searchInput = document.getElementById('state-search-input');
  const statesGrid = document.getElementById('states-grid');
  if (!searchInput || !statesGrid) return;

  const stateCards = statesGrid.querySelectorAll('.state-card');

  searchInput.addEventListener('input', function() {
    const query = this.value.toLowerCase().trim();

    // 既存のno-results要素を削除
    const existingNoResults = statesGrid.querySelector('.no-results');
    if (existingNoResults) existingNoResults.remove();

    let visibleCount = 0;

    stateCards.forEach(card => {
      const name = card.dataset.name.toLowerCase();
      const code = card.dataset.code.toLowerCase();

      if (name.includes(query) || code.includes(query)) {
        card.classList.remove('hidden');
        visibleCount++;
      } else {
        card.classList.add('hidden');
      }
    });

    // 結果がない場合
    if (visibleCount === 0 && query !== '') {
      const noResults = document.createElement('div');
      noResults.className = 'no-results';
      noResults.textContent = '「' + this.value + '」に一致する州が見つかりませんでした';
      statesGrid.appendChild(noResults);
    }
  });
}

// DOMContentLoaded (初回ロード用)
document.addEventListener('DOMContentLoaded', function() {
  initUSMap();
  initStateSearch();
});

// Turbo用 (ページ遷移時)
document.addEventListener('turbo:load', function() {
  initUSMap();
  initStateSearch();
});
</script>
