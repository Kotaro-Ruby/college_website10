<% content_for :title, "ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆç®¡ç†ç”»é¢ - College Spark" %>

<div class="admin-container">
  <div class="admin-header">
    <h1>ğŸ“Š ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆç®¡ç†ç”»é¢</h1>
    <p>ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿</p>
  </div>

  <!-- çµ±è¨ˆæƒ…å ± -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-icon">ğŸ“ˆ</div>
      <div class="stat-content">
        <h3><%= @total_responses %></h3>
        <p>ç·å›ç­”æ•°</p>
      </div>
    </div>
    
    <div class="stat-card">
      <div class="stat-icon">â­</div>
      <div class="stat-content">
        <h3><%= @average_rating %></h3>
        <p>å¹³å‡è©•ä¾¡</p>
      </div>
    </div>
    
    <div class="stat-card">
      <div class="stat-icon">ğŸ“…</div>
      <div class="stat-content">
        <h3><%= Date.current.strftime("%Y/%m/%d") %></h3>
        <p>æœ€çµ‚æ›´æ–°</p>
      </div>
    </div>
  </div>

  <!-- è©•ä¾¡åˆ†å¸ƒ -->
  <div class="chart-section">
    <h2>â­ è©•ä¾¡åˆ†å¸ƒ</h2>
    <div class="rating-chart">
      <% (1..5).each do |rating| %>
        <% count = @rating_distribution[rating] || 0 %>
        <% percentage = @total_responses > 0 ? (count.to_f / @total_responses * 100).round(1) : 0 %>
        <div class="rating-bar">
          <span class="rating-label"><%= rating %>æ˜Ÿ</span>
          <div class="bar-container">
            <div class="bar-fill" style="width: <%= percentage %>%"></div>
          </div>
          <span class="rating-count"><%= count %>ä»¶ (<%= percentage %>%)</span>
        </div>
      <% end %>
    </div>
  </div>

  <!-- è¨ªå•ç›®çš„åˆ†å¸ƒ -->
  <% if @purpose_distribution.any? %>
    <div class="chart-section">
      <h2>ğŸ¯ è¨ªå•ç›®çš„åˆ†å¸ƒ</h2>
      <div class="purpose-chart">
        <% @purpose_distribution.each do |purpose, count| %>
          <% percentage = @total_responses > 0 ? (count.to_f / @total_responses * 100).round(1) : 0 %>
          <div class="purpose-item">
            <div class="purpose-label">
              <%= case purpose
                  when 'research' then 'ç•™å­¦ã®æƒ…å ±åé›†'
                  when 'specific' then 'ç‰¹å®šã®å¤§å­¦ã‚’æ¢ã—ã¦ã„ã‚‹'
                  when 'browsing' then 'ãªã‚“ã¨ãªãè¦‹ã¦ã„ã‚‹'
                  when 'other' then 'ãã®ä»–'
                  end %>
            </div>
            <div class="purpose-bar">
              <div class="purpose-fill" style="width: <%= percentage %>%"></div>
            </div>
            <div class="purpose-count"><%= count %>ä»¶</div>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>

  <!-- æœ€æ–°ã®å›ç­” -->
  <div class="responses-section">
    <h2>ğŸ“ æœ€æ–°ã®å›ç­”ï¼ˆæœ€æ–°50ä»¶ï¼‰</h2>
    <div class="responses-table-container">
      <table class="responses-table">
        <thead>
          <tr>
            <th>æ—¥æ™‚</th>
            <th>è©•ä¾¡</th>
            <th>è¨ªå•ç›®çš„</th>
            <th>ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯</th>
            <th>IP</th>
          </tr>
        </thead>
        <tbody>
          <% @recent_responses.each do |response| %>
            <tr>
              <td class="date-cell">
                <%= response.created_at.strftime("%m/%d %H:%M") %>
              </td>
              <td class="rating-cell">
                <span class="rating-stars">
                  <% response.rating.times do %>â­<% end %>
                </span>
                <span class="rating-number">(<%= response.rating %>)</span>
              </td>
              <td class="purpose-cell">
                <%= response.purpose_display %>
              </td>
              <td class="feedback-cell">
                <% if response.feedback.present? %>
                  <div class="feedback-content" title="<%= response.feedback %>">
                    <%= truncate(response.feedback, length: 50) %>
                  </div>
                <% else %>
                  <span class="no-feedback">æœªè¨˜å…¥</span>
                <% end %>
              </td>
              <td class="ip-cell">
                <%= response.user_ip&.gsub(/\.\d+$/, '.***') %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>
</div>

<style>
  .admin-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 40px 20px;
    font-family: 'Montserrat', sans-serif;
  }

  .admin-header {
    text-align: center;
    margin-bottom: 40px;
  }

  .admin-header h1 {
    font-size: 2.5rem;
    color: #1f2937;
    margin-bottom: 10px;
  }

  .admin-header p {
    color: #6b7280;
    font-size: 1.1rem;
  }

  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 40px;
  }

  .stat-card {
    background: white;
    border-radius: 12px;
    padding: 25px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    display: flex;
    align-items: center;
    gap: 15px;
  }

  .stat-icon {
    font-size: 2.5rem;
  }

  .stat-content h3 {
    font-size: 2rem;
    font-weight: 700;
    color: #1f2937;
    margin: 0;
  }

  .stat-content p {
    color: #6b7280;
    margin: 0;
    font-size: 0.9rem;
  }

  .chart-section {
    background: white;
    border-radius: 12px;
    padding: 30px;
    margin-bottom: 30px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
  }

  .chart-section h2 {
    color: #1f2937;
    margin-bottom: 20px;
    font-size: 1.5rem;
  }

  .rating-chart, .purpose-chart {
    display: flex;
    flex-direction: column;
    gap: 15px;
  }

  .rating-bar, .purpose-item {
    display: grid;
    grid-template-columns: 80px 1fr 120px;
    align-items: center;
    gap: 15px;
  }

  .rating-label, .purpose-label {
    font-weight: 600;
    color: #374151;
  }

  .bar-container, .purpose-bar {
    background: #f3f4f6;
    border-radius: 8px;
    height: 20px;
    overflow: hidden;
  }

  .bar-fill, .purpose-fill {
    background: linear-gradient(90deg, #fbbf24, #f59e0b);
    height: 100%;
    transition: width 0.3s ease;
  }

  .rating-count, .purpose-count {
    text-align: right;
    font-weight: 500;
    color: #6b7280;
    font-size: 0.9rem;
  }

  .responses-section {
    background: white;
    border-radius: 12px;
    padding: 30px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
  }

  .responses-section h2 {
    color: #1f2937;
    margin-bottom: 20px;
    font-size: 1.5rem;
  }

  .responses-table-container {
    overflow-x: auto;
  }

  .responses-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9rem;
  }

  .responses-table th {
    background: #f9fafb;
    padding: 12px;
    text-align: left;
    font-weight: 600;
    color: #374151;
    border-bottom: 2px solid #e5e7eb;
  }

  .responses-table td {
    padding: 12px;
    border-bottom: 1px solid #e5e7eb;
    vertical-align: top;
  }

  .responses-table tr:hover {
    background: #f9fafb;
  }

  .date-cell {
    white-space: nowrap;
    color: #6b7280;
  }

  .rating-cell {
    white-space: nowrap;
  }

  .rating-stars {
    font-size: 0.8rem;
  }

  .rating-number {
    color: #6b7280;
    font-size: 0.8rem;
  }

  .purpose-cell {
    color: #374151;
    font-weight: 500;
  }

  .feedback-content {
    max-width: 200px;
    word-break: break-word;
    cursor: help;
  }

  .no-feedback {
    color: #9ca3af;
    font-style: italic;
  }

  .ip-cell {
    font-family: monospace;
    color: #6b7280;
    font-size: 0.8rem;
  }

  @media (max-width: 768px) {
    .admin-container {
      padding: 20px 10px;
    }

    .admin-header h1 {
      font-size: 2rem;
    }

    .stats-grid {
      grid-template-columns: 1fr;
    }

    .chart-section, .responses-section {
      padding: 20px;
    }

    .rating-bar, .purpose-item {
      grid-template-columns: 60px 1fr 80px;
      gap: 10px;
    }

    .responses-table {
      font-size: 0.8rem;
    }

    .responses-table th,
    .responses-table td {
      padding: 8px;
    }
  }
</style>